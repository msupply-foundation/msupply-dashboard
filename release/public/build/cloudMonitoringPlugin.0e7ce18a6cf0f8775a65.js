"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3549],{"./public/app/plugins/datasource/cloud-monitoring/module.ts":(e,t,a)=>{a.r(t),a.d(t,{plugin:()=>ve});var s=a("./packages/grafana-data/src/index.ts"),r=a("./node_modules/lodash/lodash.js"),i=a("./node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),n=a("./node_modules/rxjs/dist/esm5/internal/observable/of.js"),l=a("./node_modules/rxjs/dist/esm5/internal/observable/from.js"),o=a("./node_modules/rxjs/dist/esm5/internal/observable/throwError.js"),c=a("./node_modules/rxjs/dist/esm5/internal/operators/map.js"),u=a("./node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),p=a("./node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),d=a("./packages/grafana-runtime/src/index.ts"),h=a("./public/app/features/templating/template_srv.ts"),y=a("./public/app/features/dashboard/services/TimeSrv.ts"),g=a("./public/app/plugins/datasource/cloud-monitoring/types.ts"),m=a("./public/app/core/app_events.ts"),v=a("./public/app/types/index.ts"),j=a("./public/app/plugins/datasource/cloud-monitoring/functions.ts");function b(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class f{constructor(e){b(this,"cache",void 0),b(this,"defaultOptions",void 0),this.baseUrl=e,this.cache={},this.defaultOptions={useCache:!0,responseMap:e=>e,baseUrl:this.baseUrl}}get(e,t){const{useCache:a,responseMap:s,baseUrl:r}=Object.assign({},this.defaultOptions,t);return a&&this.cache[e]?Promise.resolve(this.cache[e]):(0,i.n)((0,d.getBackendSrv)().fetch({url:r+e,method:"GET"}).pipe((0,c.U)((t=>{const r=e.match(/([^\/]*)\/*$/)[1].split("?")[0];let i=[];return t&&t.data&&t.data[r]&&(i=t.data[r].map(s)),a&&(this.cache[e]=i),i})),(0,p.K)((e=>(m.Z.emit(v.RW.SQ,{error:{data:{error:(0,j.Rn)(e)}}}),(0,n.of)([]))))))}post(e){return(0,d.getBackendSrv)().fetch({url:"/api/tsdb/query",method:"POST",data:e})}test(e){return(0,i.n)((0,d.getBackendSrv)().fetch({url:`${this.baseUrl}${e}/metricDescriptors`,method:"GET"}))}}var S=a("./public/app/plugins/datasource/cloud-monitoring/constants.ts");class T{constructor(e){this.datasource=e}async execute(e){try{switch(e.projectName||(e.projectName=this.datasource.getDefaultProject()),e.selectedQueryType){case g.Bp.Projects:return this.handleProjectsQuery();case g.Bp.Services:return this.handleServiceQuery(e);case g.Bp.MetricTypes:return this.handleMetricTypesQuery(e);case g.Bp.LabelKeys:return this.handleLabelKeysQuery(e);case g.Bp.LabelValues:return this.handleLabelValuesQuery(e);case g.Bp.ResourceTypes:return this.handleResourceTypeQuery(e);case g.Bp.Aligners:return this.handleAlignersQuery(e);case g.Bp.AlignmentPeriods:return this.handleAlignmentPeriodQuery();case g.Bp.Aggregations:return this.handleAggregationQuery(e);case g.Bp.SLOServices:return this.handleSLOServicesQuery(e);case g.Bp.SLO:return this.handleSLOQuery(e);case g.Bp.Selectors:return this.handleSelectorQuery();default:return[]}}catch(t){return console.error(`Could not run CloudMonitoringMetricFindQuery ${e}`,t),[]}}async handleProjectsQuery(){return(await this.datasource.getProjects()).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleServiceQuery({projectName:e}){const t=await this.datasource.getMetricTypes(e);return(0,j.qA)(t).map((e=>({text:e.serviceShortName,value:e.service,expandable:!0})))}async handleMetricTypesQuery({selectedService:e,projectName:t}){if(!e)return[];const a=await this.datasource.getMetricTypes(t);return(0,j.Qf)(a,this.datasource.templateSrv.replace(e)).map((e=>({text:e.displayName,value:e.type,expandable:!0})))}async handleLabelKeysQuery({selectedMetricType:e,projectName:t}){if(!e)return[];return(await(0,j.Qd)(this.datasource,e,t)).map(this.toFindQueryResult)}async handleLabelValuesQuery({selectedMetricType:e,labelKey:t,projectName:a}){if(!e)return[];const s=await this.datasource.getLabels(e,"handleLabelValuesQuery",a,[t]),r=this.datasource.templateSrv.replace(t);return(s.hasOwnProperty(r)?s[r]:[]).map(this.toFindQueryResult)}async handleResourceTypeQuery({selectedMetricType:e,projectName:t}){var a,s;if(!e)return[];return null!==(a=null===(s=(await this.datasource.getLabels(e,"handleResourceTypeQueryQueryType",t))["resource.type"])||void 0===s?void 0:s.map(this.toFindQueryResult))&&void 0!==a?a:[]}async handleAlignersQuery({selectedMetricType:e,projectName:t}){if(!e)return[];const a=(await this.datasource.getMetricTypes(t)).find((t=>t.type===this.datasource.templateSrv.replace(e)));return a?(0,j.oU)(a.valueType,a.metricKind).map(this.toFindQueryResult):[]}async handleAggregationQuery({selectedMetricType:e,projectName:t}){if(!e)return[];const a=(await this.datasource.getMetricTypes(t)).find((t=>t.type===this.datasource.templateSrv.replace(e)));return a?(0,j.A_)(a.valueType,a.metricKind).map(this.toFindQueryResult):[]}async handleSLOServicesQuery({projectName:e}){return(await this.datasource.getSLOServices(e)).map(this.toFindQueryResult)}async handleSLOQuery({selectedSLOService:e,projectName:t}){return(await this.datasource.getServiceLevelObjectives(t,e)).map(this.toFindQueryResult)}async handleSelectorQuery(){return S.IR.map(this.toFindQueryResult)}handleAlignmentPeriodQuery(){return S.dD.map(this.toFindQueryResult)}toFindQueryResult(e){return(0,r.isString)(e)?{text:e,expandable:!0}:Object.assign({},e,{expandable:!0})}}var x,C=a("./node_modules/react/index.js"),Q=a("./public/app/plugins/datasource/cloud-monitoring/components/index.ts"),w=a("./node_modules/react/jsx-runtime.js");const M=["metricDescriptors","labels","metricTypes","services"];function P(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class O extends C.PureComponent{constructor(e){super(e),P(this,"queryTypes",[{value:g.Bp.Projects,label:"Projects"},{value:g.Bp.Services,label:"Services"},{value:g.Bp.MetricTypes,label:"Metric Types"},{value:g.Bp.LabelKeys,label:"Label Keys"},{value:g.Bp.LabelValues,label:"Label Values"},{value:g.Bp.ResourceTypes,label:"Resource Types"},{value:g.Bp.Aggregations,label:"Aggregations"},{value:g.Bp.Aligners,label:"Aligners"},{value:g.Bp.AlignmentPeriods,label:"Alignment Periods"},{value:g.Bp.Selectors,label:"Selectors"},{value:g.Bp.SLOServices,label:"SLO Services"},{value:g.Bp.SLO,label:"Service Level Objectives (SLO)"}]),P(this,"defaults",{selectedQueryType:this.queryTypes[0].value,metricDescriptors:[],selectedService:"",selectedMetricType:"",labels:[],labelKey:"",metricTypes:[],services:[],sloServices:[],selectedSLOService:"",projects:[],projectName:"",loading:!0}),P(this,"onPropsChange",(()=>{const e=function(e,t){if(null==e)return{};var a,s,r={},i=Object.keys(e);for(s=0;s<i.length;s++)a=i[s],t.indexOf(a)>=0||(r[a]=e[a]);return r}(this.state,M);this.props.onChange(Object.assign({},e,{refId:"CloudMonitoringVariableQueryEditor-VariableQuery"}))})),this.state=Object.assign(this.defaults,{projectName:this.props.datasource.getDefaultProject()},this.props.query)}async componentDidMount(){const e=await this.props.datasource.getProjects(),t=await this.props.datasource.getMetricTypes(this.props.query.projectName||this.props.datasource.getDefaultProject()),a=(0,j.qA)(t).map((e=>({value:e.service,label:e.serviceShortName})));let s="";a.some((e=>e.value===(0,d.getTemplateSrv)().replace(this.state.selectedService)))?s=this.state.selectedService:a&&a.length>0&&(s=a[0].value);const{metricTypes:r,selectedMetricType:i}=(0,j.FL)(t,this.state.selectedMetricType,(0,d.getTemplateSrv)().replace(this.state.selectedMetricType),(0,d.getTemplateSrv)().replace(s)),n=await this.props.datasource.getSLOServices(this.state.projectName),l=Object.assign({services:a,selectedService:s,metricTypes:r,selectedMetricType:i,metricDescriptors:t,projects:e},await this.getLabels(i,this.state.projectName),{sloServices:n,loading:!1});this.setState(l,(()=>this.onPropsChange()))}async onQueryTypeChange(e){const t=Object.assign({selectedQueryType:e},await this.getLabels(this.state.selectedMetricType,this.state.projectName,e));this.setState(t)}async onProjectChange(e){const t=await this.props.datasource.getMetricTypes(e),a=await this.getLabels(this.state.selectedMetricType,e),{metricTypes:s,selectedMetricType:r}=(0,j.FL)(t,this.state.selectedMetricType,(0,d.getTemplateSrv)().replace(this.state.selectedMetricType),(0,d.getTemplateSrv)().replace(this.state.selectedService)),i=await this.props.datasource.getSLOServices(e);this.setState(Object.assign({},a,{metricTypes:s,selectedMetricType:r,metricDescriptors:t,projectName:e,sloServices:i}),(()=>this.onPropsChange()))}async onServiceChange(e){const{metricTypes:t,selectedMetricType:a}=(0,j.FL)(this.state.metricDescriptors,this.state.selectedMetricType,(0,d.getTemplateSrv)().replace(this.state.selectedMetricType),(0,d.getTemplateSrv)().replace(e)),s=Object.assign({selectedService:e,metricTypes:t,selectedMetricType:a},await this.getLabels(a,this.state.projectName));this.setState(s,(()=>this.onPropsChange()))}async onMetricTypeChange(e){const t=Object.assign({selectedMetricType:e},await this.getLabels(e,this.state.projectName));this.setState(t,(()=>this.onPropsChange()))}onLabelKeyChange(e){this.setState({labelKey:e},(()=>this.onPropsChange()))}componentDidUpdate(e,t){const a=t.selectedQueryType!==this.state.selectedQueryType,s=this.state.selectedSLOService!==t.selectedSLOService;(a||s)&&this.onPropsChange()}async getLabels(e,t,a=this.state.selectedQueryType){let s={labels:this.state.labels,labelKey:this.state.labelKey};if(e&&a===g.Bp.LabelValues){const a=await(0,j.Qd)(this.props.datasource,e,t),r=a.some((e=>e===(0,d.getTemplateSrv)().replace(this.state.labelKey)))?this.state.labelKey:a[0];s={labels:a,labelKey:r}}return s}renderQueryTypeSwitch(e){const t={label:"Template Variables",expanded:!1,options:(0,d.getTemplateSrv)().getVariables().map((e=>({value:`$${e.name}`,label:`$${e.name}`})))};switch(e){case g.Bp.MetricTypes:return(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(Q.Th,{allowCustomValue:!0,value:this.state.projectName,options:[t,...this.state.projects],onChange:e=>this.onProjectChange(e),label:"Project"}),(0,w.jsx)(Q.Th,{value:this.state.selectedService,options:[t,...this.state.services],onChange:e=>this.onServiceChange(e),label:"Service"})]});case g.Bp.LabelKeys:case g.Bp.LabelValues:case g.Bp.ResourceTypes:return(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(Q.Th,{allowCustomValue:!0,value:this.state.projectName,options:[t,...this.state.projects],onChange:e=>this.onProjectChange(e),label:"Project"}),(0,w.jsx)(Q.Th,{value:this.state.selectedService,options:[t,...this.state.services],onChange:e=>this.onServiceChange(e),label:"Service"}),(0,w.jsx)(Q.Th,{value:this.state.selectedMetricType,options:[t,...this.state.metricTypes.map((({value:e,name:t})=>({value:e,label:t})))],onChange:e=>this.onMetricTypeChange(e),label:"Metric Type"}),e===g.Bp.LabelValues&&(0,w.jsx)(Q.Th,{value:this.state.labelKey,options:[t,...this.state.labels.map((e=>({value:e,label:e})))],onChange:e=>this.onLabelKeyChange(e),label:"Label Key"})]});case g.Bp.Aligners:case g.Bp.Aggregations:return(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(Q.Th,{value:this.state.selectedService,options:[t,...this.state.services],onChange:e=>this.onServiceChange(e),label:"Service"}),(0,w.jsx)(Q.Th,{value:this.state.selectedMetricType,options:[t,...this.state.metricTypes.map((({value:e,name:t})=>({value:e,label:t})))],onChange:e=>this.onMetricTypeChange(e),label:"Metric Type"})]});case g.Bp.SLOServices:return(0,w.jsx)(w.Fragment,{children:(0,w.jsx)(Q.Th,{allowCustomValue:!0,value:this.state.projectName,options:[t,...this.state.projects],onChange:e=>this.onProjectChange(e),label:"Project"})});case g.Bp.SLO:return(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(Q.Th,{allowCustomValue:!0,value:this.state.projectName,options:[t,...this.state.projects],onChange:e=>this.onProjectChange(e),label:"Project"}),(0,w.jsx)(Q.Th,{value:this.state.selectedSLOService,options:[t,...this.state.sloServices],onChange:e=>{this.setState(Object.assign({},this.state,{selectedSLOService:e}))},label:"SLO Service"})]});default:return""}}render(){return this.state.loading?x||(x=(0,w.jsxs)("div",{className:"gf-form max-width-21",children:[(0,w.jsx)("span",{className:"gf-form-label width-10 query-keyword",children:"Query Type"}),(0,w.jsx)("div",{className:"gf-form-select-wrapper max-width-12",children:(0,w.jsx)("select",{className:"gf-form-input",children:(0,w.jsx)("option",{children:"Loading..."})})})]})):(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(Q.Th,{value:this.state.selectedQueryType,options:this.queryTypes,onChange:e=>this.onQueryTypeChange(e),label:"Query Type"}),this.renderQueryTypeSwitch(this.state.selectedQueryType)]})}}function L(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class N extends s.CustomVariableSupport{constructor(e){super(),L(this,"metricFindQuery",void 0),L(this,"editor",O),this.datasource=e,this.metricFindQuery=new T(e),this.query=this.query.bind(this)}query(e){const t=(0,l.Dp)(this.metricFindQuery.execute(e.targets[0]));return(0,l.Dp)(this.datasource.ensureGCEDefaultProject()).pipe((0,u.z)((()=>t)),(0,c.U)((e=>({data:e}))))}}const D=["hide","refId","datasource","key","queryType","maxLines","metric","intervalMs","type"];function B(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class F extends d.DataSourceWithBackend{constructor(e,t=(0,h.J)(),a=(0,y.$t)()){super(e),B(this,"api",void 0),B(this,"authenticationType",void 0),B(this,"intervalMs",void 0),this.instanceSettings=e,this.templateSrv=t,this.timeSrv=a,this.authenticationType=e.jsonData.authenticationType||"jwt",this.api=new f(`${e.url}/cloudmonitoring/v3/projects/`),this.variables=new N(this),this.intervalMs=0}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}query(e){return e.targets=e.targets.map((t=>Object.assign({},this.migrateQuery(t),{intervalMs:e.intervalMs}))),super.query(e)}async annotationQuery(e){await this.ensureGCEDefaultProject();const t=e.annotation,a=[{refId:"annotationQuery",type:"annotationQuery",datasourceId:this.id,view:"FULL",crossSeriesReducer:"REDUCE_NONE",perSeriesAligner:"ALIGN_NONE",metricType:this.templateSrv.replace(t.target.metricType,e.scopedVars||{}),title:this.templateSrv.replace(t.target.title,e.scopedVars||{}),text:this.templateSrv.replace(t.target.text,e.scopedVars||{}),tags:this.templateSrv.replace(t.target.tags,e.scopedVars||{}),projectName:this.templateSrv.replace(t.target.projectName?t.target.projectName:this.getDefaultProject(),e.scopedVars||{}),filters:this.interpolateFilters(t.target.filters||[],e.scopedVars)}];return(0,i.n)(this.api.post({from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:a}).pipe((0,c.U)((({data:e})=>{const a=(0,d.toDataQueryResponse)({data:e}),s=[];if(0!==a.data.length)for(let e=0;e<a.data.length;e++)for(let r=0;r<a.data[e].fields[0].values.length;r++)s.push({annotation:t,time:Date.parse(a.data[e].fields[0].values.get(r)),title:a.data[e].fields[1].values.get(r),tags:[],text:a.data[e].fields[3].values.get(r)});return s}))))}applyTemplateVariables({metricQuery:e,refId:t,queryType:a,sloQuery:s},r){return{datasourceId:this.id,refId:t,intervalMs:this.intervalMs,type:"timeSeriesQuery",queryType:a,metricQuery:Object.assign({},this.interpolateProps(e,r),{projectName:this.templateSrv.replace(e.projectName?e.projectName:this.getDefaultProject(),r),filters:this.interpolateFilters(e.filters||[],r),groupBys:this.interpolateGroupBys(e.groupBys||[],r),view:e.view||"FULL",editorMode:e.editorMode}),sloQuery:s&&this.interpolateProps(s,r)}}async getLabels(e,t,a,s){const r={targets:[{refId:t,datasourceId:this.id,queryType:g.xL.METRICS,metricQuery:{projectName:this.templateSrv.replace(a),metricType:this.templateSrv.replace(e),groupBys:this.interpolateGroupBys(s||[],{}),crossSeriesReducer:"REDUCE_NONE",view:"HEADERS"}}],range:this.timeSrv.timeRange()},o=r.targets;return o.length?(0,i.n)((0,l.Dp)(this.ensureGCEDefaultProject()).pipe((0,u.z)((()=>this.api.post({from:r.range.from.valueOf().toString(),to:r.range.to.valueOf().toString(),queries:o}))),(0,c.U)((({data:e})=>e)),(0,c.U)((e=>{const a=e.results[t];return a&&a.meta?a.meta.labels:{}})))):(0,i.n)((0,n.of)({results:[]}))}async testDatasource(){let e,t;const a="Cannot connect to Google Cloud Monitoring API";try{await this.ensureGCEDefaultProject();const s=await this.api.test(this.getDefaultProject());200===s.status?(e="success",t="Successfully queried the Google Cloud Monitoring API."):(e="error",t=s.statusText?s.statusText:a)}catch(s){e="error",(0,r.isString)(s)?t=s:(t="Google Cloud Monitoring: ",t+=s.statusText?s.statusText:a,s.data&&s.data.error&&s.data.error.code&&(t+=": "+s.data.error.code+". "+s.data.error.message))}finally{return{status:e,message:t}}}async getGCEDefaultProject(){return(0,i.n)(this.api.post({queries:[{refId:"getGCEDefaultProject",type:"getGCEDefaultProject",datasourceId:this.id}]}).pipe((0,c.U)((({data:e})=>e&&e.results&&e.results.getGCEDefaultProject&&e.results.getGCEDefaultProject.meta?e.results.getGCEDefaultProject.meta.defaultProject:"")),(0,p.K)((e=>(0,o._)(e.data.error)))))}getDefaultProject(){const{defaultProject:e,authenticationType:t,gceDefaultProject:a}=this.instanceSettings.jsonData;return"gce"===t?a||"":e||""}async ensureGCEDefaultProject(){const{authenticationType:e,gceDefaultProject:t}=this.instanceSettings.jsonData;"gce"!==e||t||(this.instanceSettings.jsonData.gceDefaultProject=await this.getGCEDefaultProject())}async getMetricTypes(e){return e?this.api.get(`${this.templateSrv.replace(e)}/metricDescriptors`,{responseMap:e=>{const[t]=e.type.split("/"),[a]=t.split(".");return e.service=t,e.serviceShortName=a,e.displayName=e.displayName||e.type,e}}):[]}async getSLOServices(e){return this.api.get(`${this.templateSrv.replace(e)}/services?pageSize=1000`,{responseMap:({name:e,displayName:t})=>({value:e.match(/([^\/]*)\/*$/)[1],label:t||e.match(/([^\/]*)\/*$/)[1]})})}async getServiceLevelObjectives(e,t){if(!t)return Promise.resolve([]);let{projectName:a,serviceId:s}=this.interpolateProps({projectName:e,serviceId:t});return this.api.get(`${a}/services/${s}/serviceLevelObjectives`,{responseMap:({name:e,displayName:t,goal:a})=>({value:e.match(/([^\/]*)\/*$/)[1],label:t,goal:a})})}getProjects(){return this.api.get("projects",{responseMap:({projectId:e,name:t})=>({value:e,label:t}),baseUrl:`${this.instanceSettings.url}/cloudresourcemanager/v1/`})}migrateQuery(e){if(!e.hasOwnProperty("metricQuery")){const t=e,{hide:a,refId:s,intervalMs:r,type:i}=t,n=function(e,t){if(null==e)return{};var a,s,r={},i=Object.keys(e);for(s=0;s<i.length;s++)a=i[s],t.indexOf(a)>=0||(r[a]=e[a]);return r}(t,D);return{refId:s,intervalMs:r,type:i,hide:a,queryType:g.xL.METRICS,metricQuery:Object.assign({},n,{view:n.view||"FULL"})}}return e}interpolateProps(e,t={}){return Object.entries(e).reduce(((e,[a,s])=>Object.assign({},e,{[a]:s&&(0,r.isString)(s)?this.templateSrv.replace(s,t):s})),{})}filterQuery(e){if(e.hide)return!1;if(e.queryType&&e.queryType===g.xL.SLO&&e.sloQuery){const{selectorName:t,serviceId:a,sloId:s,projectName:r}=e.sloQuery;return!!(t&&a&&s&&r)}if(e.queryType&&e.queryType===g.xL.METRICS&&e.metricQuery.editorMode===g.je.MQL)return!!e.metricQuery.projectName&&!!e.metricQuery.query;const{metricType:t}=e.metricQuery;return!!t}interpolateVariablesInQueries(e,t){return e.map((e=>this.applyTemplateVariables(this.migrateQuery(e),t)))}interpolateFilters(e,t){const a=(0,r.chunk)(e,4).map((([e,t,a,s])=>Object.assign({key:e,operator:t,value:a},s&&{condition:s}))).reduce(((e,t)=>t.value?[...e,t]:e),[]);return(0,r.flatten)(a.map((({key:e,operator:a,value:s,condition:r})=>[this.templateSrv.replace(e,t||{}),a,this.templateSrv.replace(s,t||{},"regex"),...r?[r]:[]])))||[]}interpolateGroupBys(e,t){let a=[];return(e||[]).forEach((e=>{const s=this.templateSrv.replace(e,t||{},"csv").split(",");Array.isArray(s)?a=a.concat(s):a.push(s)})),a}}var E,G=a("./public/app/plugins/datasource/cloud-monitoring/components/QueryEditor.tsx"),k=a("./packages/grafana-ui/src/index.ts"),_=a("./node_modules/@emotion/css/dist/emotion-css.esm.js");const A=["project_id","private_key","client_email","token_uri"];function I({onChange:e,isConfigured:t}){const a=(0,k.useStyles)(V),[s,i]=(0,C.useState)(!t),[n,l]=(0,C.useState)(null);return s?(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(k.FileUpload,{className:a,accept:"application/json",onFileUpload:t=>{var a,s;if(1===(null==t||null===(a=t.currentTarget)||void 0===a||null===(s=a.files)||void 0===s?void 0:s.length)){l(null);const a=new FileReader,s=()=>t=>{const a=JSON.parse(t.target.result);(e=>!!(e.token_uri&&e.client_email&&e.project_id&&e.project_id))(a)?(e(a),i(!1)):l("Invalid JWT file")};a.onload=s(),a.readAsText(t.currentTarget.files[0])}else l("You can only upload one file")},children:"Upload service account key file"}),n&&(0,w.jsx)("p",{className:(0,_.cx)(a,"alert"),children:n})]}):(0,w.jsxs)(w.Fragment,{children:[A.map(((e,t)=>(0,w.jsx)(k.InlineField,{label:(0,r.startCase)(e),labelWidth:20,disabled:!0,children:E||(E=(0,w.jsx)(k.Input,{width:40,placeholder:"configured"}))},t))),(0,w.jsx)(k.Button,{variant:"secondary",onClick:()=>i(!0),className:a,children:"Upload another JWT file"}),(0,w.jsx)(k.Alert,{title:"",className:a,severity:"info",children:"Do not forget to save your changes after uploading a file"})]})}const V=e=>_.css`
  margin: ${e.spacing.md} 0 0;
`;var R,q,K,U,$,J,W,z,H,Y,Z,X,ee,te,ae,se,re,ie,ne,le,oe,ce,ue,pe,de,he;class ye extends C.PureComponent{render(){const{options:e,onOptionsChange:t}=this.props,{secureJsonFields:a,jsonData:r}=e;return r.hasOwnProperty("authenticationType")||(r.authenticationType=g.Gr.JWT),(0,w.jsxs)(w.Fragment,{children:[R||(R=(0,w.jsx)("div",{className:"gf-form-group",children:(0,w.jsxs)("div",{className:"grafana-info-box",children:[(0,w.jsx)("h4",{children:"Google Cloud Monitoring Authentication"}),(0,w.jsx)("p",{children:"There are two ways to authenticate the Google Cloud Monitoring plugin - either by uploading a Service Account key file or by automatically retrieving credentials from the Google metadata server. The latter option is only available when running Grafana on a GCE virtual machine."}),(0,w.jsx)("h5",{children:"Uploading a Service Account Key File"}),(0,w.jsx)("p",{children:"There are two ways to authenticate the Google Cloud Monitoring plugin. You can upload a Service Account key file or automatically retrieve credentials from the Google metadata server. The latter option is only available when running Grafana on a GCE virtual machine."}),(0,w.jsxs)("p",{children:["The ",(0,w.jsx)("strong",{children:"Monitoring Viewer"})," role provides all the permissions that Grafana needs. The following API needs to be enabled on GCP for the data source to work:"," ",(0,w.jsx)("a",{className:"external-link",target:"_blank",rel:"noopener noreferrer",href:"https://console.cloud.google.com/apis/library/monitoring.googleapis.com",children:"Monitoring API"})]}),(0,w.jsx)("h5",{children:"GCE Default Service Account"}),(0,w.jsx)("p",{children:"If Grafana is running on a Google Compute Engine (GCE) virtual machine, it is possible for Grafana to automatically retrieve the default project id and authentication token from the metadata server. In order for this to work, you need to make sure that you have a service account that is setup as the default account for the virtual machine and that the service account has been given read access to the Google Cloud Monitoring Monitoring API."}),(0,w.jsxs)("p",{children:["Detailed instructions on how to create a Service Account can be found"," ",(0,w.jsx)("a",{className:"external-link",target:"_blank",rel:"noopener noreferrer",href:"https://grafana.com/docs/grafana/latest/datasources/google-cloud-monitoring/",children:"in the documentation."})]})]})})),(0,w.jsxs)(k.FieldSet,{children:[(0,w.jsx)(k.InlineField,{label:"Authentication type",labelWidth:20,children:(0,w.jsx)(k.Select,{menuShouldPortal:!0,width:40,value:g.CK.find((e=>e.value===r.authenticationType))||g.CK[0],options:g.CK,defaultValue:r.authenticationType,onChange:(0,s.onUpdateDatasourceJsonDataOptionSelect)(this.props,"authenticationType")})}),r.authenticationType===g.Gr.JWT&&(0,w.jsx)(I,{isConfigured:a&&!!a.jwt,onChange:({private_key:a,client_email:s,project_id:r,token_uri:i})=>{t(Object.assign({},e,{secureJsonData:Object.assign({},e.secureJsonData,{privateKey:a}),jsonData:Object.assign({},e.jsonData,{defaultProject:r,clientEmail:s,tokenUri:i})}))}})]}),r.authenticationType===g.Gr.GCE&&(q||(q=(0,w.jsx)(k.Alert,{title:"",severity:"info",children:"Verify GCE default service account by clicking Save & Test"})))]})}}class ge extends C.PureComponent{render(){return(0,w.jsxs)("div",{children:[K||(K=(0,w.jsx)("h2",{children:"Cloud Monitoring alias patterns"})),(0,w.jsxs)("div",{children:[U||(U=(0,w.jsx)("p",{children:"Format the legend keys any way you want by using alias patterns. Format the legend keys any way you want by using alias patterns."})),"Example:",$||($=(0,w.jsx)("code",{children:"{{metric.name}} - {{metric.label.instance_name}}"})),J||(J=(0,w.jsx)("br",{})),"Result:   ",W||(W=(0,w.jsx)("code",{children:"cpu/usage_time - server1-europe-west-1"})),z||(z=(0,w.jsx)("br",{})),H||(H=(0,w.jsx)("br",{})),Y||(Y=(0,w.jsx)("label",{children:"Patterns"})),Z||(Z=(0,w.jsx)("br",{})),(0,w.jsxs)("ul",{className:_.css`
              list-style: none;
            `,children:[X||(X=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{metric.type}}"})," = metric type e.g. compute.googleapis.com/instance/cpu/usage_time"]})),ee||(ee=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{metric.name}}"})," = name part of metric e.g. instance/cpu/usage_time"]})),te||(te=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{metric.service}}"})," = service part of metric e.g. compute"]})),ae||(ae=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{metric.label.label_name}}"})," = Metric label metadata e.g. metric.label.instance_name"]})),se||(se=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{resource.label.label_name}}"})," = Resource label metadata e.g. resource.label.zone"]})),re||(re=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{metadata.system_labels.name}}"})," = Meta data system labels e.g. metadata.system_labels.name. For this to work, the needs to be included in the group by"]})),ie||(ie=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{metadata.user_labels.name}}"})," = Meta data user labels e.g. metadata.user_labels.name. For this to work, the needs to be included in the group by"]})),ne||(ne=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{bucket}}"})," = bucket boundary for distribution metrics when using a heatmap in Grafana"]})),le||(le=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{project}}"})," = The project name that was specified in the query editor"]})),oe||(oe=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{service}}"})," = The service id that was specified in the SLO query editor"]})),ce||(ce=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{slo}}"})," = The SLO id that was specified in the SLO query editor"]})),ue||(ue=(0,w.jsxs)("li",{children:[(0,w.jsx)("code",{children:"{{selector}}"})," = The Selector function that was specified in the SLO query editor"]}))]})]})]})}}class me{constructor(e){this.annotation=e.ctrl.annotation||{},this.annotation.target=e.ctrl.annotation.target||{},this.onQueryChange=this.onQueryChange.bind(this)}onQueryChange(e){Object.assign(this.annotation.target,e)}}me.$inject=["$scope"],he="partials/annotations.editor.html",(de="templateUrl")in(pe=me)?Object.defineProperty(pe,de,{value:he,enumerable:!0,configurable:!0,writable:!0}):pe[de]=he;const ve=new s.DataSourcePlugin(F).setQueryEditorHelp(ge).setQueryEditor(G.W).setConfigEditor(ye).setAnnotationQueryCtrl(me).setVariableQueryEditor(O)}}]);
//# sourceMappingURL=cloudMonitoringPlugin.0e7ce18a6cf0f8775a65.js.map