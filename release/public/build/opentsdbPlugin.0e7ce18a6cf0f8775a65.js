"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3168],{"./public/app/plugins/datasource/opentsdb/module.ts":(t,e,s)=>{s.r(e),s.d(e,{plugin:()=>A});var r=s("./node_modules/angular/index.js"),a=s.n(r),i=s("./node_modules/lodash/lodash.js"),o=s("./node_modules/rxjs/dist/esm5/internal/observable/of.js"),n=s("./node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),l=s("./node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),g=s("./node_modules/rxjs/dist/esm5/internal/operators/map.js"),u=s("./packages/grafana-runtime/src/index.ts"),h=s("./packages/grafana-data/src/index.ts"),c=s("./public/app/features/templating/template_srv.ts");function d(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class p extends h.DataSourceApi{constructor(t,e=(0,c.J)()){super(t),d(this,"type",void 0),d(this,"url",void 0),d(this,"name",void 0),d(this,"withCredentials",void 0),d(this,"basicAuth",void 0),d(this,"tsdbVersion",void 0),d(this,"tsdbResolution",void 0),d(this,"lookupLimit",void 0),d(this,"tagKeys",void 0),d(this,"aggregatorsPromise",void 0),d(this,"filterTypesPromise",void 0),this.templateSrv=e,this.type="opentsdb",this.url=t.url,this.name=t.name,this.withCredentials=t.withCredentials,this.basicAuth=t.basicAuth,t.jsonData=t.jsonData||{},this.tsdbVersion=t.jsonData.tsdbVersion||1,this.tsdbResolution=t.jsonData.tsdbResolution||1,this.lookupLimit=t.jsonData.lookupLimit||1e3,this.tagKeys={},this.aggregatorsPromise=null,this.filterTypesPromise=null}query(t){const e=this.convertToTSDBTime(t.range.raw.from,!1,t.timezone),s=this.convertToTSDBTime(t.range.raw.to,!0,t.timezone),r=[];(0,i.each)(t.targets,(e=>{e.metric&&r.push(this.convertTargetToQuery(e,t,this.tsdbVersion))}));const a=(0,i.compact)(r);if((0,i.isEmpty)(a))return(0,o.of)({data:[]});const n={};return(0,i.each)(a,(t=>{t.filters&&t.filters.length>0?(0,i.each)(t.filters,(t=>{n[t.tagk]=!0})):(0,i.each)(t.tags,((t,e)=>{n[e]=!0}))})),t.targets=(0,i.filter)(t.targets,(t=>!0!==t.hide)),this.performTimeSeriesQuery(a,e,s).pipe((0,l.K)((t=>{var e,s;throw(null==t||null===(e=t.data)||void 0===e||null===(s=e.error)||void 0===s?void 0:s.message)||"Error performing time series query."})),(0,g.U)((e=>{const s=this.mapMetricsToTargets(e.data,t,this.tsdbVersion);return{data:(0,i.map)(e.data,((e,r)=>(-1===(r=s[r])&&(r=0),this._saveTagKeys(e),this.transformMetricData(e,n,t.targets[r],t,this.tsdbResolution))))}})))}annotationQuery(t){const e=this.convertToTSDBTime(t.rangeRaw.from,!1,t.timezone),s=this.convertToTSDBTime(t.rangeRaw.to,!0,t.timezone),r=[],a=[];r.push({aggregator:"sum",metric:t.annotation.target});const o=(0,i.compact)(r);return(0,n.n)(this.performTimeSeriesQuery(o,e,s).pipe((0,g.U)((e=>{if(e.data[0]){let s=e.data[0].annotations;t.annotation.isGlobal&&(s=e.data[0].globalAnnotations),s&&(0,i.each)(s,(e=>{const s={text:e.description,time:1e3*Math.floor(e.startTime),annotation:t.annotation};a.push(s)}))}return a}))))}targetContainsTemplate(t){if(t.filters&&t.filters.length>0)for(let e=0;e<t.filters.length;e++)if(this.templateSrv.variableExists(t.filters[e].filter))return!0;if(t.tags&&Object.keys(t.tags).length>0)for(const e in t.tags)if(this.templateSrv.variableExists(t.tags[e]))return!0;return!1}performTimeSeriesQuery(t,e,s){let r=!1;2===this.tsdbResolution&&(r=!0);const a={start:e,queries:t,msResolution:r,globalAnnotations:!0};3===this.tsdbVersion&&(a.showQuery=!0),s&&(a.end=s);const i={method:"POST",url:this.url+"/api/query",data:a};return this._addCredentialOptions(i),(0,u.getBackendSrv)().fetch(i)}suggestTagKeys(t){return Promise.resolve(this.tagKeys[t]||[])}_saveTagKeys(t){const e=Object.keys(t.tags);(0,i.each)(t.aggregateTags,(t=>{e.push(t)})),this.tagKeys[t.metric]=e}_performSuggestQuery(t,e){return this._get("/api/suggest",{type:e,q:t,max:this.lookupLimit}).pipe((0,g.U)((t=>t.data)))}_performMetricKeyValueLookup(t,e){if(!t||!e)return(0,o.of)([]);const s=e.split(",").map((t=>t.trim())),r=s[0];let a=r+"=*";s.length>1&&(a+=","+s.splice(1).join(","));const n=t+"{"+a+"}";return this._get("/api/search/lookup",{m:n,limit:this.lookupLimit}).pipe((0,g.U)((t=>{t=t.data.results;const e=[];return(0,i.each)(t,(t=>{-1===e.indexOf(t.tags[r])&&e.push(t.tags[r])})),e})))}_performMetricKeyLookup(t){return t?this._get("/api/search/lookup",{m:t,limit:1e3}).pipe((0,g.U)((t=>{t=t.data.results;const e=[];return(0,i.each)(t,(t=>{(0,i.each)(t.tags,((t,s)=>{-1===e.indexOf(s)&&e.push(s)}))})),e}))):(0,o.of)([])}_get(t,e){const s={method:"GET",url:this.url+t,params:e};return this._addCredentialOptions(s),(0,u.getBackendSrv)().fetch(s)}_addCredentialOptions(t){(this.basicAuth||this.withCredentials)&&(t.withCredentials=!0),this.basicAuth&&(t.headers={Authorization:this.basicAuth})}metricFindQuery(t){if(!t)return Promise.resolve([]);let e;try{e=this.templateSrv.replace(t,{},"distributed")}catch(t){return Promise.reject(t)}const s=t=>(0,i.map)(t,(t=>({text:t}))),r=e.match(/metrics\((.*)\)/);if(r)return(0,n.n)(this._performSuggestQuery(r[1],"metrics").pipe((0,g.U)(s)));const a=e.match(/tag_names\((.*)\)/);if(a)return(0,n.n)(this._performMetricKeyLookup(a[1]).pipe((0,g.U)(s)));const o=e.match(/tag_values\((.*?),\s?(.*)\)/);if(o)return(0,n.n)(this._performMetricKeyValueLookup(o[1],o[2]).pipe((0,g.U)(s)));const l=e.match(/suggest_tagk\((.*)\)/);if(l)return(0,n.n)(this._performSuggestQuery(l[1],"tagk").pipe((0,g.U)(s)));const u=e.match(/suggest_tagv\((.*)\)/);return u?(0,n.n)(this._performSuggestQuery(u[1],"tagv").pipe((0,g.U)(s))):Promise.resolve([])}testDatasource(){return(0,n.n)(this._performSuggestQuery("cpu","metrics").pipe((0,g.U)((()=>({status:"success",message:"Data source is working"})))))}getAggregators(){return this.aggregatorsPromise||(this.aggregatorsPromise=(0,n.n)(this._get("/api/aggregators").pipe((0,g.U)((t=>t.data&&(0,i.isArray)(t.data)?t.data.sort():[]))))),this.aggregatorsPromise}getFilterTypes(){return this.filterTypesPromise||(this.filterTypesPromise=(0,n.n)(this._get("/api/config/filters").pipe((0,g.U)((t=>t.data?Object.keys(t.data).sort():[]))))),this.filterTypesPromise}transformMetricData(t,e,s,r,a){const o=this.createMetricLabel(t,s,e,r),n=[];return(0,i.each)(t.dps,((t,e)=>{2===a?n.push([t,1*e]):n.push([t,1e3*e])})),{target:o,datapoints:n}}createMetricLabel(t,e,s,r){if(e.alias){const s=(0,i.clone)(r.scopedVars||{});return(0,i.each)(t.tags,((t,e)=>{s["tag_"+e]={value:t}})),this.templateSrv.replace(e.alias,s)}let a=t.metric;const o=[];return(0,i.isEmpty)(t.tags)||(0,i.each)((0,i.toPairs)(t.tags),(t=>{(0,i.has)(s,t[0])&&o.push(t[0]+"="+t[1])})),(0,i.isEmpty)(o)||(a+="{"+o.join(", ")+"}"),a}convertTargetToQuery(t,e,s){if(!t.metric||t.hide)return null;const r={metric:this.templateSrv.replace(t.metric,e.scopedVars,"pipe"),aggregator:"avg"};if(t.aggregator&&(r.aggregator=this.templateSrv.replace(t.aggregator)),t.shouldComputeRate&&(r.rate=!0,r.rateOptions={counter:!!t.isCounter},t.counterMax&&t.counterMax.length&&(r.rateOptions.counterMax=parseInt(t.counterMax,10)),t.counterResetValue&&t.counterResetValue.length&&(r.rateOptions.resetValue=parseInt(t.counterResetValue,10)),s>=2&&(r.rateOptions.dropResets=!(r.rateOptions.counterMax||r.rateOptions.ResetValue&&0!==r.rateOptions.ResetValue))),!t.disableDownsampling){let s=this.templateSrv.replace(t.downsampleInterval||e.interval);s.match(/\.[0-9]+s/)&&(s=1e3*parseFloat(s)+"ms"),r.downsample=s+"-"+t.downsampleAggregator,t.downsampleFillPolicy&&"none"!==t.downsampleFillPolicy&&(r.downsample+="-"+t.downsampleFillPolicy)}if(t.filters&&t.filters.length>0){if(r.filters=a().copy(t.filters),r.filters)for(const t in r.filters)r.filters[t].filter=this.templateSrv.replace(r.filters[t].filter,e.scopedVars,"pipe")}else if(r.tags=a().copy(t.tags),r.tags)for(const t in r.tags)r.tags[t]=this.templateSrv.replace(r.tags[t],e.scopedVars,"pipe");return t.explicitTags&&(r.explicitTags=!0),r}mapMetricsToTargets(t,e,s){let r,a;return(0,i.map)(t,(t=>3===s?t.query.index:(0,i.findIndex)(e.targets,(s=>s.filters&&s.filters.length>0?s.metric===t.metric:s.metric===t.metric&&(0,i.every)(s.tags,((s,o)=>(r=this.templateSrv.replace(s,e.scopedVars,"pipe"),a=r.split("|"),(0,i.includes)(a,t.tags[o])||"*"===r)))))))}interpolateVariablesInQueries(t,e){return t.length?t.map((t=>Object.assign({},t,{metric:this.templateSrv.replace(t.metric,e)}))):t}convertToTSDBTime(t,e,s){return"now"===t?null:(t=h.dateMath.parse(t,e,s)).valueOf()}}var m=s("./public/app/plugins/sdk.ts");function f(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class v extends m.QueryCtrl{constructor(t,e){super(t,e),f(this,"aggregators",void 0),f(this,"fillPolicies",void 0),f(this,"filterTypes",void 0),f(this,"tsdbVersion",void 0),f(this,"aggregator",void 0),f(this,"downsampleInterval",void 0),f(this,"downsampleAggregator",void 0),f(this,"downsampleFillPolicy",void 0),f(this,"errors",void 0),f(this,"suggestMetrics",void 0),f(this,"suggestTagKeys",void 0),f(this,"suggestTagValues",void 0),f(this,"addTagMode",!1),f(this,"addFilterMode",!1),this.errors=this.validateTarget(),this.aggregators=["avg","sum","min","max","dev","zimsum","mimmin","mimmax"],this.fillPolicies=["none","nan","null","zero"],this.filterTypes=["wildcard","iliteral_or","not_iliteral_or","not_literal_or","iwildcard","literal_or","regexp"],this.tsdbVersion=this.datasource.tsdbVersion,this.target.aggregator||(this.target.aggregator="sum"),this.target.downsampleAggregator||(this.target.downsampleAggregator="avg"),this.target.downsampleFillPolicy||(this.target.downsampleFillPolicy="none"),this.datasource.getAggregators().then((t=>{0!==t.length&&(this.aggregators=t)})),this.datasource.getFilterTypes().then((t=>{0!==t.length&&(this.filterTypes=t)})),this.suggestMetrics=(t,e)=>{this.datasource.metricFindQuery("metrics("+t+")").then(this.getTextValues).then(e)},this.suggestTagKeys=(t,e)=>{this.datasource.suggestTagKeys(this.target.metric).then(e)},this.suggestTagValues=(t,e)=>{this.datasource.metricFindQuery("suggest_tagv("+t+")").then(this.getTextValues).then(e)}}targetBlur(){this.errors=this.validateTarget(),this.refresh()}getTextValues(t){return(0,i.map)(t,(t=>h.textUtil.escapeHtml(t.text)))}addTag(){this.target.filters&&this.target.filters.length>0&&(this.errors.tags="Please remove filters to use tags, tags and filters are mutually exclusive."),this.addTagMode?(this.target.tags||(this.target.tags={}),this.errors=this.validateTarget(),this.errors.tags||(this.target.tags[this.target.currentTagKey]=this.target.currentTagValue,this.target.currentTagKey="",this.target.currentTagValue="",this.targetBlur()),this.addTagMode=!1):this.addTagMode=!0}removeTag(t){delete this.target.tags[t],this.targetBlur()}editTag(t,e){this.removeTag(t),this.target.currentTagKey=t,this.target.currentTagValue=e,this.addTag()}closeAddTagMode(){this.addTagMode=!1}addFilter(){if(this.target.tags&&(0,i.size)(this.target.tags)>0&&(this.errors.filters="Please remove tags to use filters, tags and filters are mutually exclusive."),this.addFilterMode){if(this.target.filters||(this.target.filters=[]),this.target.currentFilterType||(this.target.currentFilterType="iliteral_or"),this.target.currentFilterGroupBy||(this.target.currentFilterGroupBy=!1),this.errors=this.validateTarget(),!this.errors.filters){const t={type:this.target.currentFilterType,tagk:this.target.currentFilterKey,filter:this.target.currentFilterValue,groupBy:this.target.currentFilterGroupBy};this.target.filters.push(t),this.target.currentFilterType="literal_or",this.target.currentFilterKey="",this.target.currentFilterValue="",this.target.currentFilterGroupBy=!1,this.targetBlur()}this.addFilterMode=!1}else this.addFilterMode=!0}removeFilter(t){this.target.filters.splice(t,1),this.targetBlur()}editFilter(t,e){this.removeFilter(e),this.target.currentFilterKey=t.tagk,this.target.currentFilterValue=t.filter,this.target.currentFilterType=t.type,this.target.currentFilterGroupBy=t.groupBy,this.addFilter()}closeAddFilterMode(){this.addFilterMode=!1}validateTarget(){const t={};if(this.target.shouldDownsample)try{this.target.downsampleInterval?h.rangeUtil.describeInterval(this.target.downsampleInterval):t.downsampleInterval="You must supply a downsample interval (e.g. '1m' or '1h')."}catch(e){t.downsampleInterval=e.message}return this.target.tags&&(0,i.has)(this.target.tags,this.target.currentTagKey)&&(t.tags="Duplicate tag key '"+this.target.currentTagKey+"'."),t}}v.$inject=["$scope","$injector"],f(v,"templateUrl","partials/query.editor.html");s("./node_modules/react/index.js");var y,T,b,j,x=s("./packages/grafana-ui/src/index.ts"),F=s("./node_modules/react/jsx-runtime.js");const{Select:w,Input:_}=x.LegacyForms,V=[{label:"<=2.1",value:1},{label:"==2.2",value:2},{label:"==2.3",value:3}],S=[{label:"second",value:1},{label:"millisecond",value:2}],k=t=>{var e,s,r;const{onChange:a,value:i}=t;return(0,F.jsxs)(F.Fragment,{children:[y||(y=(0,F.jsx)("h5",{children:"OpenTSDB settings"})),(0,F.jsxs)("div",{className:"gf-form",children:[T||(T=(0,F.jsx)(x.InlineFormLabel,{width:7,children:"Version"})),(0,F.jsx)(w,{menuShouldPortal:!0,options:V,value:null!==(e=V.find((t=>t.value===i.jsonData.tsdbVersion)))&&void 0!==e?e:V[0],onChange:P("tsdbVersion",i,a)})]}),(0,F.jsxs)("div",{className:"gf-form",children:[b||(b=(0,F.jsx)(x.InlineFormLabel,{width:7,children:"Resolution"})),(0,F.jsx)(w,{menuShouldPortal:!0,options:S,value:null!==(s=S.find((t=>t.value===i.jsonData.tsdbResolution)))&&void 0!==s?s:S[0],onChange:P("tsdbResolution",i,a)})]}),(0,F.jsxs)("div",{className:"gf-form",children:[j||(j=(0,F.jsx)(x.InlineFormLabel,{width:7,children:"Lookup limit"})),(0,F.jsx)(_,{type:"number",value:null!==(r=i.jsonData.lookupLimit)&&void 0!==r?r:1e3,onChange:M("lookupLimit",i,a)})]})]})},P=(t,e,s)=>r=>{s(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{[t]:r.value})}))},M=(t,e,s)=>r=>{s(Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{[t]:r.currentTarget.value})}))};class D{}var O,C,K;K="partials/annotations.editor.html",(C="templateUrl")in(O=D)?Object.defineProperty(O,C,{value:K,enumerable:!0,configurable:!0,writable:!0}):O[C]=K;const A=new h.DataSourcePlugin(p).setQueryCtrl(v).setConfigEditor((t=>{const{options:e,onOptionsChange:s}=t;return(0,F.jsxs)(F.Fragment,{children:[(0,F.jsx)(x.DataSourceHttpSettings,{defaultUrl:"http://localhost:4242",dataSourceConfig:e,onChange:s}),(0,F.jsx)(k,{value:e,onChange:s})]})})).setAnnotationQueryCtrl(D)}}]);
//# sourceMappingURL=opentsdbPlugin.0e7ce18a6cf0f8775a65.js.map