"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2364],{"./public/app/plugins/datasource/grafana-azure-monitor-datasource/module.ts":(e,t,s)=>{s.r(t),s.d(t,{plugin:()=>Ae});var r=s("./packages/grafana-data/src/index.ts"),i=s("./node_modules/lodash/lodash.js"),a=s.n(i);class o{static buildAzureMonitorGetMetricNamespacesUrl(e,t,s,r,i,a){const o=r.split("/"),n=i.split("/"),c=[e,t,"resourceGroups",s,"providers",o.shift()];for(const e in o)c.push(o[e]),c.push(n[e]);return`${c.join("/")}/providers/microsoft.insights/metricNamespaces?api-version=${a}`}static buildAzureMonitorGetMetricNamesUrl(e,t,s,r,i,a,o){const n=r.split("/"),c=i.split("/"),u=[e,t,"resourceGroups",s,"providers",n.shift()];for(const e in n)u.push(n[e]),u.push(c[e]);return`${u.join("/")}/providers/microsoft.insights/metricdefinitions?api-version=${o}&metricnamespace=${encodeURIComponent(a)}`}}var n=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/time_grain_converter.ts");class c{static parseResponseValues(e,t,s){const r=[];if(!e)return r;for(let a=0;a<e.value.length;a++)if(!(0,i.find)(r,["value",(0,i.get)(e.value[a],s)])){const o=(0,i.get)(e.value[a],s),n=(0,i.get)(e.value[a],t,o);r.push({text:n,value:o})}return r}static parseResourceNames(e,t){const s=[];if(!e)return s;for(let r=0;r<e.value.length;r++)e.value[r].type===t&&s.push({text:e.value[r].name,value:e.value[r].name});return s}static parseMetadata(e,t){var s,r;const i=["None","Average","Minimum","Maximum","Total","Count"],a=null==e?void 0:e.value.find((e=>e.name.value===t));return a?{primaryAggType:a.primaryAggregationType,supportedAggTypes:a.supportedAggregationTypes||i,supportedTimeGrains:[{label:"Auto",value:"auto"},...c.parseTimeGrains(null!==(s=a.metricAvailabilities)&&void 0!==s?s:[])],dimensions:c.parseDimensions(null!==(r=a.dimensions)&&void 0!==r?r:[])}:{primaryAggType:"",supportedAggTypes:i,supportedTimeGrains:[],dimensions:[]}}static parseTimeGrains(e){const t=[];return e?(e.forEach((e=>{e.timeGrain&&t.push({label:n.Z.createTimeGrainFromISO8601Duration(e.timeGrain),value:e.timeGrain})})),t):t}static parseDimensions(e){return e.map((e=>({label:e.localizedValue||e.value,value:e.value})))}static parseSubscriptions(e){const t=[];if(!e)return t;const s="subscriptionId";for(let r=0;r<e.value.length;r++)(0,i.find)(t,["value",(0,i.get)(e.value[r],s)])||t.push({text:`${(0,i.get)(e.value[r],"displayName")}`,value:(0,i.get)(e.value[r],s)});return t}static parseSubscriptionsForSelect(e){const t=[];if(!e)return t;const s="subscriptionId";for(let r=0;r<e.data.value.length;r++)(0,i.find)(t,["value",(0,i.get)(e.data.value[r],s)])||t.push({label:`${(0,i.get)(e.data.value[r],"displayName")} - ${(0,i.get)(e.data.value[r],s)}`,value:(0,i.get)(e.data.value[r],s)});return t}static parseWorkspacesForSelect(e){const t=[];if(!e)return t;const s="customerId";for(let r=0;r<e.data.value.length;r++)(0,i.find)(t,["value",(0,i.get)(e.data.value[r].properties,s)])||t.push({label:(0,i.get)(e.data.value[r],"name"),value:(0,i.get)(e.data.value[r].properties,s)});return t}}class u{constructor(e){var t,s,r;r={azuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.ApiManagement/service","Microsoft.AppConfiguration/configurationStores","Microsoft.Automation/automationAccounts","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerInstance/containerGroups","Microsoft.ContainerRegistry/registries","Microsoft.ContainerService/managedClusters","Microsoft.CustomerInsights/hubs","Microsoft.DataBoxEdge/dataBoxEdgeDevices","Microsoft.DataFactory/datafactories","Microsoft.DataFactory/factories","Microsoft.DataLakeAnalytics/accounts","Microsoft.DataLakeStore/accounts","Microsoft.DBforMariaDB/servers","Microsoft.DBforMySQL/servers","Microsoft.DBforMySQL/flexibleServers","Microsoft.DBforPostgreSQL/servers","Microsoft.DBforPostgreSQL/flexibleServers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.DocumentDB/databaseAccounts","Microsoft.EventGrid/topics","Microsoft.EventGrid/eventSubscriptions","Microsoft.EventGrid/extensionTopics","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.HDInsight/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.Insights/components","Microsoft.KeyVault/vaults","Microsoft.Kusto/clusters","Microsoft.LocationBasedServices/accounts","Microsoft.Logic/workflows","Microsoft.Logic/integrationServiceEnvironments","Microsoft.NetApp/netAppAccounts/capacityPools","Microsoft.NetApp/netAppAccounts/capacityPools/volumes","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.Network/natGateways","Microsoft.Network/vpngateways","Microsoft.Network/virtualNetworkGateways","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.Search/searchServices","Microsoft.ServiceBus/namespaces","Microsoft.SignalRService/SignalR","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StorageSync/storageSyncServices","Microsoft.StorageSync/storageSyncServices/syncGroups","Microsoft.StorageSync/storageSyncServices/syncGroups/serverEndpoints","Microsoft.StorageSync/storageSyncServices/registeredServers","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],govazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.ApiManagement/service","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerRegistry/registries","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventGrid/topics","Microsoft.EventGrid/eventSubscriptions","Microsoft.EventGrid/extensionTopics","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.KeyVault/vaults","Microsoft.Logic/workflows","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],germanyazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventHub/namespaces","Microsoft.EventHub/clusters","Microsoft.Insights/AutoscaleSettings","Microsoft.KeyVault/vaults","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.OperationalInsights/workspaces","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"],chinaazuremonitor:["Microsoft.AnalysisServices/servers","Microsoft.Batch/batchAccounts","Microsoft.Cache/redis","Microsoft.ClassicCompute/virtualMachines","Microsoft.ClassicCompute/domainNames/slots/roles","Microsoft.CognitiveServices/accounts","Microsoft.Compute/virtualMachines","Microsoft.Compute/virtualMachineScaleSets","Microsoft.ContainerRegistry/registries","Microsoft.DBforMySQL/servers","Microsoft.DBforPostgreSQL/servers","Microsoft.Devices/IotHubs","Microsoft.Devices/provisioningServices","Microsoft.EventHub/namespaces","Microsoft.Insights/AutoscaleSettings","Microsoft.KeyVault/vaults","Microsoft.Logic/workflows","Microsoft.Network/networkInterfaces","Microsoft.Network/loadBalancers","Microsoft.Network/dnsZones","Microsoft.Network/publicIPAddresses","Microsoft.Network/azureFirewalls","Microsoft.Network/applicationGateways","Microsoft.Network/virtualNetworkGateways","Microsoft.Network/expressRouteCircuits","Microsoft.Network/expressRouteCircuits/Peerings","Microsoft.Network/connections","Microsoft.Network/trafficManagerProfiles","Microsoft.Network/networkWatchers/connectionMonitors","Microsoft.Network/frontdoors","Microsoft.NotificationHubs/namespaces/notificationHubs","Microsoft.PowerBIDedicated/capacities","Microsoft.Relay/namespaces","Microsoft.ServiceBus/namespaces","Microsoft.Sql/servers/databases","Microsoft.Sql/servers/elasticPools","Microsoft.Sql/managedInstances","Microsoft.Storage/storageAccounts","Microsoft.Storage/storageAccounts/blobServices","Microsoft.Storage/storageAccounts/fileServices","Microsoft.Storage/storageAccounts/queueServices","Microsoft.Storage/storageAccounts/tableServices","Microsoft.StreamAnalytics/streamingJobs","Microsoft.Web/serverfarms","Microsoft.Web/sites","Microsoft.Web/sites/slots","Microsoft.Web/hostingEnvironments/multiRolePools","Microsoft.Web/hostingEnvironments/workerPools"]},(s="supportedMetricNamespaces")in(t=this)?Object.defineProperty(t,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[s]=r,this.cloudName=e}get(){return this.supportedMetricNamespaces[this.cloudName]}}var l=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/types/index.ts"),p=s("./packages/grafana-runtime/src/index.ts"),d=s("./public/app/features/dashboard/services/TimeSrv.ts");const h=Symbol("Concealed client secret");function g(e){return e.jsonData.azureAuthType?e.jsonData.azureAuthType:e.jsonData.tenantId&&e.jsonData.clientId?"clientsecret":p.config.azure.managedIdentityEnabled?"msi":"clientsecret"}function f(){switch(p.config.azure.cloud){case l._.Public:case l._.None:case void 0:return"azuremonitor";case l._.China:return"chinaazuremonitor";case l._.USGovernment:return"govazuremonitor";case l._.Germany:return"germanyazuremonitor";default:throw new Error(`The cloud '${p.config.azure.cloud}' not supported.`)}}function m(e){switch(e){case"azuremonitor":return"https://portal.azure.com";case"chinaazuremonitor":return"https://portal.azure.cn";case"govazuremonitor":return"https://portal.azure.us";case"germanyazuremonitor":return"https://portal.microsoftazure.de";default:throw new Error("The cloud not supported.")}}function v(e){switch(g(e)){case"msi":return f();case"clientsecret":return e.jsonData.cloudName||f()}}function M(e){if(e.secureJsonFields.clientSecret)return h;{var t;const s=null===(t=e.secureJsonData)||void 0===t?void 0:t.clientSecret;return"string"==typeof s&&s.length>0?s:void 0}}function b(e){switch(g(e)){case"msi":return p.config.azure.managedIdentityEnabled?{authType:"msi",defaultSubscriptionId:e.jsonData.subscriptionId}:{authType:"clientsecret",azureCloud:f()};case"clientsecret":return{authType:"clientsecret",azureCloud:e.jsonData.cloudName||f(),tenantId:e.jsonData.tenantId,clientId:e.jsonData.clientId,clientSecret:M(e),defaultSubscriptionId:e.jsonData.subscriptionId}}}var y=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/azureMetadata/index.ts"),S=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/common.ts");function w(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}const I="select";class A extends p.DataSourceWithBackend{constructor(e){super(e),w(this,"apiVersion","2018-01-01"),w(this,"apiPreviewVersion","2017-12-01-preview"),w(this,"defaultSubscriptionId",void 0),w(this,"resourcePath",void 0),w(this,"azurePortalUrl",void 0),w(this,"supportedMetricNamespaces",[]),w(this,"timeSrv",void 0),this.instanceSettings=e,this.timeSrv=(0,d.$t)(),this.defaultSubscriptionId=e.jsonData.subscriptionId;const t=v(e);this.resourcePath=`${S.kr.azureMonitor}/subscriptions`,this.supportedMetricNamespaces=new u(t).get(),this.azurePortalUrl=m(t)}isConfigured(){return!this.validateDatasource()}filterQuery(e){return!!(!0!==e.hide&&e.azureMonitor&&e.azureMonitor.resourceGroup&&e.azureMonitor.resourceGroup!==I&&e.azureMonitor.resourceName&&e.azureMonitor.resourceName!==I&&e.azureMonitor.metricDefinition&&e.azureMonitor.metricDefinition!==I&&e.azureMonitor.metricName&&e.azureMonitor.metricName!==I&&e.azureMonitor.aggregation&&e.azureMonitor.aggregation!==I)}applyTemplateVariables(e,t){var s;const r=e.azureMonitor;if(!r)throw new Error("Query is not a valid Azure Monitor Metrics query");r.timeGrain&&r.timeGrainUnit&&"auto"!==r.timeGrain&&(r.timeGrain=n.Z.createISO8601Duration(r.timeGrain,r.timeGrainUnit));const i=(0,p.getTemplateSrv)(),a=i.replace(e.subscription||this.defaultSubscriptionId,t),o=i.replace(r.resourceGroup,t),c=i.replace(r.resourceName,t),u=i.replace(r.metricNamespace,t),d=i.replace(r.metricDefinition,t),h=i.replace((r.timeGrain||"").toString(),t),g=i.replace(r.aggregation,t),f=i.replace(r.top||"",t),m=(null!==(s=r.dimensionFilters)&&void 0!==s?s:[]).filter((e=>e.dimension&&"None"!==e.dimension)).map((e=>{var s;const r=i.replace(null!==(s=e.filter)&&void 0!==s?s:"",t);return{dimension:i.replace(e.dimension,t),operator:e.operator||"eq",filter:r||"*"}}));return{refId:e.refId,subscription:a,queryType:l.B.AzureMonitor,azureMonitor:{resourceGroup:o,resourceName:c,metricDefinition:d,timeGrain:h,allowedTimeGrainsMs:r.allowedTimeGrainsMs,metricName:i.replace(r.metricName,t),metricNamespace:u&&u!==I?u:d,aggregation:g,dimensionFilters:m,top:f||"10",alias:r.alias}}}metricFindQueryInternal(e){if(e.match(/^Subscriptions\(\)/i))return this.getSubscriptions();if(e.match(/^ResourceGroups\(\)/i)&&this.defaultSubscriptionId)return this.getResourceGroups(this.defaultSubscriptionId);const t=e.match(/^ResourceGroups\(([^\)]+?)(,\s?([^,]+?))?\)/i);if(t)return this.getResourceGroups(this.toVariable(t[1]));const s=e.match(/^Namespaces\(([^\)]+?)(,\s?([^,]+?))?\)/i);if(s&&this.defaultSubscriptionId&&!s[3])return this.getMetricDefinitions(this.defaultSubscriptionId,this.toVariable(s[1]));const r=e.match(/^Namespaces\(([^,]+?),\s?([^,]+?)\)/i);if(r)return this.getMetricDefinitions(this.toVariable(r[1]),this.toVariable(r[2]));const i=e.match(/^ResourceNames\(([^,]+?),\s?([^,]+?)\)/i);if(i&&this.defaultSubscriptionId){const e=this.toVariable(i[1]),t=this.toVariable(i[2]);return this.getResourceNames(this.defaultSubscriptionId,e,t)}const a=e.match(/^ResourceNames\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/i);if(a){const e=this.toVariable(a[1]),t=this.toVariable(a[2]),s=this.toVariable(a[3]);return this.getResourceNames(e,t,s)}const o=e.match(/^MetricNamespace\(([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i);if(o&&this.defaultSubscriptionId){const e=this.toVariable(o[1]),t=this.toVariable(o[2]),s=this.toVariable(o[3]);return this.getMetricNamespaces(this.defaultSubscriptionId,e,t,s)}const n=e.match(/^metricnamespace\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i);if(n){const e=this.toVariable(n[1]),t=this.toVariable(n[2]),s=this.toVariable(n[3]),r=this.toVariable(n[4]);return this.getMetricNamespaces(e,t,s,r)}const c=e.match(/^MetricNames\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)\)/i);if(c&&this.defaultSubscriptionId&&-1===c[3].indexOf(",")){const e=this.toVariable(c[1]),t=this.toVariable(c[2]),s=this.toVariable(c[3]),r=this.toVariable(c[4]);return this.getMetricNames(this.defaultSubscriptionId,e,t,s,r)}const u=e.match(/^MetricNames\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?(.+?)\)/i);if(u){const e=this.toVariable(u[1]),t=this.toVariable(u[2]),s=this.toVariable(u[3]),r=this.toVariable(u[4]),i=this.toVariable(u[5]);return this.getMetricNames(e,t,s,r,i)}return null}toVariable(e){return(0,p.getTemplateSrv)().replace((e||"").trim())}async getSubscriptions(){return this.isConfigured()?this.getResource(`${this.resourcePath}?api-version=2019-03-01`).then((e=>c.parseSubscriptions(e))):[]}getResourceGroups(e){return this.getResource(`${this.resourcePath}/${e}/resourceGroups?api-version=${this.apiVersion}`).then((e=>c.parseResponseValues(e,"name","name")))}getMetricDefinitions(e,t){return this.getResource(`${this.resourcePath}/${e}/resourceGroups/${t}/resources?api-version=${this.apiVersion}`).then((e=>c.parseResponseValues(e,"type","type"))).then((e=>(0,i.filter)(e,(e=>{for(let t=0;t<this.supportedMetricNamespaces.length;t++)if(e.value.toLowerCase()===this.supportedMetricNamespaces[t].toLowerCase())return!0;return!1})))).then((e=>{let t=!1;for(let s=0;s<e.length;s++)if("Microsoft.Storage/storageAccounts"===e[s].value){t=!0;break}return t&&(e.push({text:"Microsoft.Storage/storageAccounts/blobServices",value:"Microsoft.Storage/storageAccounts/blobServices"}),e.push({text:"Microsoft.Storage/storageAccounts/fileServices",value:"Microsoft.Storage/storageAccounts/fileServices"}),e.push({text:"Microsoft.Storage/storageAccounts/tableServices",value:"Microsoft.Storage/storageAccounts/tableServices"}),e.push({text:"Microsoft.Storage/storageAccounts/queueServices",value:"Microsoft.Storage/storageAccounts/queueServices"})),e.map((e=>({value:e.value,text:y.D8[e.value.toLowerCase()]||e.value})))}))}getResourceNames(e,t,s){return this.getResource(`${this.resourcePath}/${e}/resourceGroups/${t}/resources?api-version=${this.apiVersion}`).then((e=>{if(!(0,i.startsWith)(s,"Microsoft.Storage/storageAccounts/"))return c.parseResourceNames(e,s);const t=c.parseResourceNames(e,"Microsoft.Storage/storageAccounts");for(let e=0;e<t.length;e++)t[e].text+="/default",t[e].value+="/default";return t}))}getMetricNamespaces(e,t,s,r){const i=o.buildAzureMonitorGetMetricNamespacesUrl(this.resourcePath,e,t,s,r,this.apiPreviewVersion);return this.getResource(i).then((e=>c.parseResponseValues(e,"name","properties.metricNamespaceName")))}getMetricNames(e,t,s,r,i){const a=o.buildAzureMonitorGetMetricNamesUrl(this.resourcePath,e,t,s,r,i,this.apiVersion);return this.getResource(a).then((e=>c.parseResponseValues(e,"name.localizedValue","name.value")))}getMetricMetadata(e,t,s,r,i,a){const n=o.buildAzureMonitorGetMetricNamesUrl(this.resourcePath,e,t,s,r,i,this.apiVersion);return this.getResource(n).then((e=>c.parseMetadata(e,a)))}async testDatasource(){const e=this.validateDatasource();if(e)return Promise.resolve(e);try{const e=`${this.resourcePath}?api-version=2019-03-01`;return await this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Azure Monitor service.",title:"Success"})))}catch(e){let t="Azure Monitor: ";return t+=e.statusText?e.statusText+": ":"",e.data&&e.data.error&&e.data.error.code?t+=e.data.error.code+". "+e.data.error.message:e.data&&e.data.error?t+=e.data.error:e.data?t+=e.data:t+="Cannot connect to Azure Monitor REST API.",{status:"error",message:t}}}validateDatasource(){if("clientsecret"===g(this.instanceSettings)){if(!this.isValidConfigField(this.instanceSettings.jsonData.tenantId))return{status:"error",message:"The Tenant Id field is required."};if(!this.isValidConfigField(this.instanceSettings.jsonData.clientId))return{status:"error",message:"The Client Id field is required."}}}isValidConfigField(e){return"string"==typeof e&&e.length>0}}class N{constructor(e){this.results=e}parseQueryResult(){let e=[],t=[];for(let s=0;s<this.results.length;s++)if(this.results[s].query.raw){const r=this.results[s].query.xaxis,a=this.results[s].query.yaxis,o=this.results[s].query.spliton;t=this.results[s].result.Tables[0].Columns;const n=this.results[s].result.Tables[0].Rows;e=(0,i.concat)(e,this.parseRawQueryResultRow(this.results[s].query,t,n,r,a,o))}else{const t=this.results[s].result.value,r=this.results[s].query.alias;e=(0,i.concat)(e,this.parseQueryResultRow(this.results[s].query,t,r))}return e}parseRawQueryResultRow(e,t,s,r,a,o){const n=[],c=(0,i.map)(t,(e=>({text:e.ColumnName,value:e.ColumnName}))),u=t.findIndex((e=>e.ColumnName===r)),l=a.split(","),p={};(0,i.forEach)(l,(e=>{p[e]=t.findIndex((t=>t.ColumnName===e))}));const d=t.findIndex((e=>e.ColumnName===o)),h="timestamp"===r;return(0,i.forEach)(s,(t=>{(0,i.forEach)(p,((s,r)=>{const i=-1===d?N.findOrCreateBucket(n,r):N.findOrCreateBucket(n,t[d]),a=h?N.dateTimeToEpoch(t[u]):t[u];i.datapoints.push([t[s],a]),i.refId=e.refId,i.query=e.query,i.columnsForDropdown=c}))})),n}parseQueryResultRow(e,t,s){const r=[];if(N.isSingleValue(t)){const s=N.getMetricFieldKey(t),i=N.getKeyForAggregationField(t[s]),a=N.dateTimeToEpoch(t.end);return r.push({target:s,datapoints:[[t[s][i],a]],refId:e.refId,query:e.query}),r}if(N.hasSegmentsField(t.segments[0]))for(let i=0;i<t.segments.length;i++){const a=N.dateTimeToEpoch(t.segments[i].end);for(let o=0;o<t.segments[i].segments.length;o++){const n=N.getMetricFieldKey(t.segments[i].segments[o]),c=N.getKeyForAggregationField(t.segments[i].segments[o][n]),u=this.getTargetName(t.segments[i].segments[o],s),l=N.findOrCreateBucket(r,u);l.datapoints.push([t.segments[i].segments[o][n][c],a]),l.refId=e.refId,l.meta={query:e.query}}}else{const s=N.getMetricFieldKey(t.segments[0]),i=N.findOrCreateBucket(r,s);for(let e=0;e<t.segments.length;e++){const r=N.dateTimeToEpoch(t.segments[e].end),a=N.getKeyForAggregationField(t.segments[e][s]);i.datapoints.push([t.segments[e][s][a],r])}i.refId=e.refId,i.query=e.query}return r}getTargetName(e,t){let s="",r="",a="";for(const t in e)(0,i.isObject)(e[t])?s=t:(r=t,a=e[t]);if(t){const e=/\{\{([\s\S]+?)\}\}/g;return t.replace(e,((e,t,i)=>{const o=t||i;return"metric"===o?s:"groupbyname"===o?r:"groupbyvalue"===o?a:e}))}return s+`{${r}="${a}"}`}static isSingleValue(e){return!N.hasSegmentsField(e)}static findOrCreateBucket(e,t){let s=(0,i.find)(e,["target",t]);return s||(s={target:t,datapoints:[]},e.push(s)),s}static hasSegmentsField(e){const t=(0,i.keys)(e);return(0,i.indexOf)(t,"segments")>-1}static getMetricFieldKey(e){const t=(0,i.keys)(e);return(0,i.filter)((0,i.without)(t,"start","end"),(t=>(0,i.isObject)(e[t])))[0]}static getKeyForAggregationField(e){const t=(0,i.keys)(e);return(0,i.intersection)(t,["sum","avg","min","max","count","unique"])[0]}static dateTimeToEpoch(e){return(0,r.dateTime)(e).valueOf()}static parseMetricNames(e){const t=(0,i.keys)(e.metrics);return N.toTextValueList(t)}parseMetadata(e){const t=this.results.metrics[e];if(!t)throw Error("No data found for metric: "+e);return{primaryAggType:t.defaultAggregation,supportedAggTypes:t.supportedAggregations,supportedGroupBy:t.supportedGroupBy.all}}parseGroupBys(){return N.toTextValueList(this.results.supportedGroupBy)}parseQuerySchema(){const e={Type:"AppInsights",Tables:{}};if(this.results&&this.results&&this.results.Tables)for(let t=0;t<this.results.Tables[0].Rows.length;t++){const s=this.results.Tables[0].Rows[t],r=s[0],i=s[1],a=s[2];e.Tables[r]?e.Tables[r].OrderedColumns.push({Name:i,Type:a}):e.Tables[r]={Name:r,OrderedColumns:[{Name:i,Type:a}]}}return e}static toTextValueList(e){const t=[];for(let s=0;s<e.length;s++)t.push({text:e[s],value:e[s]});return t}}function D(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class T extends p.DataSourceWithBackend{constructor(e){super(e),D(this,"resourcePath",void 0),D(this,"version","beta"),D(this,"applicationId",void 0),D(this,"logAnalyticsColumns",{}),this.applicationId=e.jsonData.appInsightsAppId||"",this.resourcePath=`${S.kr.appInsights}/${this.version}/apps/${this.applicationId}`}isConfigured(){return!!this.applicationId&&this.applicationId.length>0}createRawQueryRequest(e,t,s){return e.xaxis&&!e.timeColumn&&(e.timeColumn=e.xaxis),e.yaxis&&!e.valueColumn&&(e.valueColumn=e.yaxis),e.spliton&&!e.segmentColumn&&(e.segmentColumn=e.spliton),{type:"timeSeriesQuery",raw:!1,appInsights:{rawQuery:!0,rawQueryString:(0,p.getTemplateSrv)().replace(e.rawQueryString,t.scopedVars),timeColumn:e.timeColumn,valueColumn:e.valueColumn,segmentColumn:e.segmentColumn}}}applyTemplateVariables(e,t){const s=e.appInsights;if(!s)return e;const r=s;r.timeGrainCount?s.timeGrain=n.Z.createISO8601Duration(r.timeGrainCount,s.timeGrainUnit):s.timeGrain&&s.timeGrainUnit&&"auto"!==s.timeGrain&&(s.timeGrain=n.Z.createISO8601Duration(s.timeGrain,s.timeGrainUnit)),r.groupBy&&!s.dimension&&(s.dimension=[r.groupBy]),r.filter&&!s.dimensionFilter&&(s.dimensionFilter=r.filter),(0,i.isString)(s.dimension)&&("None"===s.dimension?s.dimension=[]:s.dimension=[s.dimension]),s.dimension||(s.dimension=[]);const a=(0,p.getTemplateSrv)();return{refId:e.refId,queryType:l.B.ApplicationInsights,appInsights:{timeGrain:a.replace((s.timeGrain||"").toString(),t),metricName:a.replace(s.metricName,t),aggregation:a.replace(s.aggregation,t),dimension:s.dimension.map((e=>a.replace(e,t))),dimensionFilter:a.replace(s.dimensionFilter,t),alias:s.alias}}}metricFindQueryInternal(e){if(e.match(/^AppInsightsMetricNames\(\)/i))return this.getMetricNames();const t=e.match(/^AppInsightsGroupBys\(([^\)]+?)(,\s?([^,]+?))?\)/i);if(t){const e=t[1];return this.getGroupBys((0,p.getTemplateSrv)().replace(e))}return null}testDatasource(){const e=`${this.resourcePath}/metrics/metadata`;return this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Application Insights service.",title:"Success"}))).catch((e=>{let t="Application Insights: ";return t+=e.statusText?e.statusText+": ":"",e.data&&e.data.error&&"PathNotFoundError"===e.data.error.code?t+="Invalid Application Id for Application Insights service.":e.data&&e.data.error?t+=e.data.error.code+". "+e.data.error.message:t+="Cannot connect to Application Insights REST API.",{status:"error",message:t}}))}getMetricNames(){const e=`${this.resourcePath}/metrics/metadata`;return this.getResource(e).then(N.parseMetricNames)}getMetricMetadata(e){const t=`${this.resourcePath}/metrics/metadata`;return this.getResource(t).then((t=>new N(t).parseMetadata(e)))}getGroupBys(e){return this.getMetricMetadata(e).then((e=>new N(e).parseGroupBys()))}getQuerySchema(){const e=`${this.resourcePath}/query/schema`;return this.getResource(e).then((e=>new N(e).parseQuerySchema()))}}class x{constructor(e,t,s){this.rawQueryString=e,this.options=t,this.defaultTimeField=s}generate(){let e=this.rawQueryString;const t=/\$__([_a-zA-Z0-9]+)\(([^\)]*)\)/gi;e=e.replace(t,((e,t,s)=>"contains"===t?this.getMultiContains(s):e)),e=e.replace(/\$__escapeMulti\(('[^]*')\)/gi,((e,t)=>this.escape(t))),this.options&&(e=e.replace(t,((e,t,s)=>"timeFilter"===t?this.getTimeFilter(s,this.options):"timeFrom"===t?this.getFrom(this.options):"timeTo"===t?this.getUntil(this.options):e)),e=e.replace(/\$__interval/gi,this.options.interval));const s=e;e=encodeURIComponent(e);return{uriString:`query=${e}`,rawQuery:s}}getFrom(e){const t=e.range.from;return`datetime(${(0,r.dateTime)(t).startOf("minute").toISOString()})`}getUntil(e){var t;if("now"===(null===(t=e.rangeRaw)||void 0===t?void 0:t.to)){const e=Date.now();return`datetime(${(0,r.dateTime)(e).startOf("minute").toISOString()})`}{const t=e.range.to;return`datetime(${(0,r.dateTime)(t).startOf("minute").toISOString()})`}}getTimeFilter(e,t){var s;const r=e||this.defaultTimeField;return"now"===(null===(s=t.rangeRaw)||void 0===s?void 0:s.to)?`${r} >= ${this.getFrom(t)}`:`${r}  >= ${this.getFrom(t)} and ${r} <= ${this.getUntil(t)}`}getMultiContains(e){const t=e.indexOf(","),s=e.substring(0,t),r=e.substring(e.indexOf(",")+1);return r&&"all"===r.toLowerCase().trim()?"1 == 1":`${s.trim()} in (${r.trim()})`}escape(e){return e.substring(1,e.length-1).split("','").map((e=>`@'${e}'`)).join(", ")}}class k{constructor(e){this.results=e}parseQueryResult(){let e=[],t=[];for(let s=0;s<this.results.length;s++){if(0===this.results[s].result.tables.length)continue;t=this.results[s].result.tables[0].columns;const r=this.results[s].result.tables[0].rows;e="time_series"===this.results[s].query.resultFormat?(0,i.concat)(e,this.parseTimeSeriesResult(this.results[s].query,t,r)):(0,i.concat)(e,this.parseTableResult(this.results[s].query,t,r))}return e}parseTimeSeriesResult(e,t,s){const r=[];let a=-1,o=-1,n=-1;for(let e=0;e<t.length;e++)-1===a&&"datetime"===t[e].type&&(a=e),-1===o&&"string"===t[e].type&&(o=e),-1===n&&["int","long","real","double"].indexOf(t[e].type)>-1&&(n=e);if(-1===a)throw new Error("No datetime column found in the result. The Time Series format requires a time column.");return(0,i.forEach)(s,(s=>{const i=k.dateTimeToEpoch(s[a]),c=o>-1?s[o]:t[n].name,u=k.findOrCreateBucket(r,c);u.datapoints.push([s[n],i]),u.refId=e.refId,u.meta={executedQueryString:e.query}})),r}parseTableResult(e,t,s){return{type:"table",columns:(0,i.map)(t,(e=>({text:e.name,type:e.type}))),rows:s,refId:e.refId,meta:{executedQueryString:e.query}}}parseToVariables(){const e=this.parseQueryResult(),t=[];return(0,i.forEach)(e,(e=>{(0,i.forEach)((0,i.flattenDeep)(e.rows),(e=>{t.push({text:e,value:e})}))})),t}transformToAnnotations(e){const t=this.parseQueryResult(),s=[];return(0,i.forEach)(t,(t=>{let r=-1,a=-1,o=-1;for(let e=0;e<t.columns.length;e++)-1===r&&"datetime"===t.columns[e].type&&(r=e),-1===a&&"text"===t.columns[e].text.toLowerCase()&&(a=e),-1===o&&"tags"===t.columns[e].text.toLowerCase()&&(o=e);(0,i.forEach)(t.rows,(t=>{s.push({annotation:e.annotation,time:Math.floor(k.dateTimeToEpoch(t[r])),text:t[a]?t[a].toString():"",tags:t[o]?t[o].trim().split(/\s*,\s*/):[]})}))})),s}static findOrCreateBucket(e,t){let s=(0,i.find)(e,["target",t]);return s||(s={target:t,datapoints:[],refId:"",query:""},e.push(s)),s}static dateTimeToEpoch(e){return(0,r.dateTime)(e).valueOf()}static parseSubscriptions(e){const t=[];if(!e)return t;const s="subscriptionId";for(let r=0;r<e.value.length;r++)(0,i.find)(t,["value",(0,i.get)(e.value[r],s)])||t.push({text:`${(0,i.get)(e.value[r],"displayName")}`,value:(0,i.get)(e.value[r],s)});return t}}const C=/([\w\W]+):([\w]+)(?:\s?=\s?([\w\W]+))?/;function j(e){return e.functions?e.functions.map((e=>{const t=e.parameters&&e.parameters.split(", ").map((e=>{const t=e.match(C);if(!t)return;const[,s,r,i]=t;return{name:s,type:r,defaultValue:i,cslDefaultValue:i}})).filter((e=>!!e));return{name:e.name,body:e.body,inputParameters:t||[]}})):[]}var z=s("./node_modules/rxjs/dist/esm5/internal/observable/from.js"),X=s("./node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),R=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/ResourcePicker/utils.ts");function P(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class F extends p.DataSourceWithBackend{constructor(e){super(e),P(this,"resourcePath",void 0),P(this,"azurePortalUrl",void 0),P(this,"defaultSubscriptionId",void 0),P(this,"azureMonitorPath",void 0),P(this,"firstWorkspace",void 0),P(this,"cache",void 0),this.instanceSettings=e,this.cache=new Map,this.resourcePath=`${S.kr.logAnalytics}`,this.azureMonitorPath=`${S.kr.azureMonitor}/subscriptions`;const t=v(e);this.azurePortalUrl=m(t),this.defaultSubscriptionId=this.instanceSettings.jsonData.subscriptionId||""}isConfigured(){return!this.validateDatasource()}async getSubscriptions(){if(!this.isConfigured())return[];const e=`${this.azureMonitorPath}?api-version=2019-03-01`;return await this.getResource(e).then((e=>k.parseSubscriptions(e)))}async getWorkspaces(e){const t=await this.getWorkspaceList(e);return(0,i.map)(t.value,(e=>({text:e.name,value:e.id})))||[]}getWorkspaceList(e){const t=(0,p.getTemplateSrv)().replace(e||this.defaultSubscriptionId),s=this.azureMonitorPath+`/${t}/providers/Microsoft.OperationalInsights/workspaces?api-version=2017-04-26-preview`;return this.getResource(s)}async getMetadata(e){const t=`${this.resourcePath}/v1${e}/metadata`;return await this.getResource(t)}async getKustoSchema(e){return function(e,t){const s={name:t,tables:e.tables,functions:j(e),majorVersion:0,minorVersion:0};return{clusterType:"Engine",cluster:{connectionString:t,databases:[s]},database:s}}(await this.getMetadata(e),e)}applyTemplateVariables(e,t){const s=e.azureLogAnalytics;if(!s)return e;const r=(0,p.getTemplateSrv)(),i=r.replace(s.resource,t);let a=r.replace(s.workspace,t);a||i||!this.firstWorkspace||(a=this.firstWorkspace);const o=r.replace(s.query,t,S.Ll);return{refId:e.refId,queryType:l.B.LogAnalytics,azureLogAnalytics:{resultFormat:s.resultFormat,query:o,resource:i,workspace:a}}}query(e){return super.query(e).pipe((0,X.z)((e=>(0,z.Dp)(this.processResponse(e)))))}async processResponse(e){if(e.data)for(const r of e.data){var t,s;const e=null===(t=r.meta)||void 0===t||null===(s=t.custom)||void 0===s?void 0:s.encodedQuery;if(e&&e.length>0){const e=await this.buildDeepLink(r.meta.custom);if(null!=e&&e.length)for(const t of r.fields)t.config.links=[{url:e,title:"View in Azure Portal",targetBlank:!0}]}}return e}async buildDeepLink(e){const t=encodeURIComponent(e.encodedQuery),s=e.workspace,r=e.subscription,i=await this.getWorkspaceDetails(s);if(!i.workspace||!i.resourceGroup)return"";return`${this.azurePortalUrl}/#blade/Microsoft_OperationsManagementSuite_Workspace/AnalyticsBlade/initiator/AnalyticsShareLinkToQuery/isQueryEditorVisible/true/scope/%7B%22resources%22%3A%5B%7B%22resourceId%22%3A%22%2Fsubscriptions%2F${r}%2Fresourcegroups%2F${i.resourceGroup}%2Fproviders%2Fmicrosoft.operationalinsights%2Fworkspaces%2F${i.workspace}%22%7D%5D%7D/query/${t}/isQueryBase64Compressed/true/timespanInIsoFormat/P1D`}async getWorkspaceDetails(e){if(!this.defaultSubscriptionId)return{};const t=(await this.getWorkspaceList(this.defaultSubscriptionId)).value.find((t=>t.properties.customerId===e));if(!t)return{};const s=/.*resourcegroups\/(.*)\/providers.*/.exec(t.id);return!s||s.length<2?{}:{workspace:t.name,resourceGroup:s[1]}}metricFindQueryInternal(e,t){if(e.match(/^workspaces\(\)/i)){if(this.defaultSubscriptionId)return this.getWorkspaces(this.defaultSubscriptionId);throw new Error("No subscription ID. Specify a default subscription ID in the data source config to use workspaces() without a subscription ID")}const s=e.match(/^workspaces\(["']?([^\)]+?)["']?\)/i);return s?this.getWorkspaces((s[1]||"").trim()):this.getFirstWorkspace().then((s=>{if(!s)return[];const r=this.buildQuery(e,t,s),i=this.doQueries(r);return Promise.all(i).then((e=>new k(e).parseToVariables())).catch((e=>{if(e.error&&e.error.data&&e.error.data.error&&e.error.data.error.innererror&&e.error.data.error.innererror.innererror)throw{message:e.error.data.error.innererror.innererror.message};if(e.error&&e.error.data&&e.error.data.error)throw{message:e.error.data.error.message};throw e}))}))}buildQuery(e,t,s){const r=new x((0,p.getTemplateSrv)().replace(e,{},S.Ll),t,"TimeGenerated").generate().uriString,i=(0,R.uD)(s)?`${this.resourcePath}/v1/workspaces/${s}/query?${r}`:`${this.resourcePath}/v1${s}/query?${r}`;return[{datasourceId:this.id,path:i,resultFormat:"table"}]}async getDefaultOrFirstSubscription(){var e;if(this.defaultSubscriptionId)return this.defaultSubscriptionId;return null===(e=(await this.getSubscriptions())[0])||void 0===e?void 0:e.value}async getFirstWorkspace(){var e;if(this.firstWorkspace)return this.firstWorkspace;const t=await this.getDefaultOrFirstSubscription();if(!t)return;const s=null===(e=(await this.getWorkspaces(t))[0])||void 0===e?void 0:e.value;return s&&(this.firstWorkspace=s),s}annotationQuery(e){if(!e.annotation.rawQuery)return Promise.reject({message:"Query missing in annotation definition"});const t=this.buildQuery(e.annotation.rawQuery,e,e.annotation.workspace),s=this.doQueries(t);return Promise.all(s).then((t=>new k(t).transformToAnnotations(e)))}doQueries(e){return(0,i.map)(e,(e=>this.getResource(e.path).then((t=>({result:t,query:e}))).catch((t=>{throw{error:t,query:e}}))))}async testDatasource(){const e=this.validateDatasource();if(e)return e;let t;try{const e=await this.getFirstWorkspace();if(!e)return{status:"error",message:"Workspace not found."};t=e}catch(e){let t="Azure Log Analytics requires access to Azure Monitor but had the following error: ";return{status:"error",message:this.getErrorMessage(t,e)}}try{const e=(0,R.uD)(t)?`${this.resourcePath}/v1/workspaces/${t}/metadata`:`${this.resourcePath}/v1${t}/metadata`;return await this.getResource(e).then((e=>({status:"success",message:"Successfully queried the Azure Log Analytics service.",title:"Success"})))}catch(e){let t="Azure Log Analytics: ";return{status:"error",message:this.getErrorMessage(t,e)}}}getErrorMessage(e,t){return e+=t.statusText?t.statusText+": ":"",t.data&&t.data.error&&t.data.error.code?e+=t.data.error.code+". "+t.data.error.message:t.data&&t.data.error?e+=t.data.error:t.data?e+=t.data:e+="Cannot connect to Azure Log Analytics REST API.",e}validateDatasource(){if("clientsecret"===g(this.instanceSettings)){if(!this.isValidConfigField(this.instanceSettings.jsonData.tenantId))return{status:"error",message:"The Tenant Id field is required."};if(!this.isValidConfigField(this.instanceSettings.jsonData.clientId))return{status:"error",message:"The Client Id field is required."}}}isValidConfigField(e){return"string"==typeof e&&e.length>0}}var V=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/resourcePicker/resourcePickerData.ts"),G=s("./node_modules/rxjs/dist/esm5/internal/observable/forkJoin.js"),q=s("./node_modules/rxjs/dist/esm5/internal/observable/of.js");class O extends T{constructor(e){super(e)}applyTemplateVariables(e,t){const s=e.insightsAnalytics;if(!s)return e;const r=s.rawQueryString&&!s.query?s.rawQueryString:s.query;return{refId:e.refId,queryType:l.B.InsightsAnalytics,insightsAnalytics:{query:(0,p.getTemplateSrv)().replace(r,t),resultFormat:s.resultFormat}}}}var $=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/migrateQuery.ts"),B=s("./node_modules/rxjs/dist/esm5/internal/operators/map.js");class L extends p.DataSourceWithBackend{filterQuery(e){var t;return!(null===(t=e.azureResourceGraph)||void 0===t||!t.query)}applyTemplateVariables(e,t){const s=e.azureResourceGraph;if(!s)return e;const r=(0,p.getTemplateSrv)(),i=r.getVariables().map((e=>`$${e.name}`)),o=a().find(e.subscriptions,(e=>a().includes(i,e))),n=[...r.replace(o,t,(e=>e)).split(",").filter((e=>e.length>0)),...a().filter(e.subscriptions,(e=>!a().includes(i,e)))],c=r.replace(s.query,t,S.Ll);return{refId:e.refId,queryType:l.B.AzureResourceGraph,subscriptions:n,azureResourceGraph:{resultFormat:"table",query:c}}}}function E(e){var t,s,r,i,a;const o="string"==typeof e.rawQuery?e.rawQuery:null,n="string"==typeof e.workspace?e.workspace:null;if(!o||!n||null!==(t=e.target)&&void 0!==t&&null!==(s=t.azureLogAnalytics)&&void 0!==s&&s.query)return e;const c=Object.assign({},null!==(r=e.target)&&void 0!==r?r:{},{refId:null!==(i=null===(a=e.target)||void 0===a?void 0:a.refId)&&void 0!==i?i:"Anno",queryType:l.B.LogAnalytics,azureLogAnalytics:{query:o,resource:n}});return Object.assign({},e,{rawQuery:void 0,workspace:void 0,subscription:void 0,queryType:void 0,target:c})}function Q(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class W extends r.DataSourceApi{constructor(e,t=(0,p.getTemplateSrv)()){super(e),Q(this,"annotations",{prepareAnnotation:E}),Q(this,"azureMonitorDatasource",void 0),Q(this,"azureLogAnalyticsDatasource",void 0),Q(this,"resourcePickerData",void 0),Q(this,"azureResourceGraphDatasource",void 0),Q(this,"appInsightsDatasource",void 0),Q(this,"insightsAnalyticsDatasource",void 0),Q(this,"pseudoDatasource",{}),this.templateSrv=t,this.azureMonitorDatasource=new A(e),this.azureLogAnalyticsDatasource=new F(e),this.azureResourceGraphDatasource=new L(e),this.resourcePickerData=new V.Z(e),this.pseudoDatasource={[l.B.AzureMonitor]:this.azureMonitorDatasource,[l.B.LogAnalytics]:this.azureLogAnalyticsDatasource,[l.B.AzureResourceGraph]:this.azureResourceGraphDatasource};const s=v(e);"azuremonitor"!==s&&"chinaazuremonitor"!==s||(this.appInsightsDatasource=new T(e),this.insightsAnalyticsDatasource=new O(e),this.pseudoDatasource[l.B.ApplicationInsights]=this.appInsightsDatasource,this.pseudoDatasource[l.B.InsightsAnalytics]=this.insightsAnalyticsDatasource)}query(e){const t=new Map;for(const s of e.targets){const r=(0,$.N)(s);if(!r.queryType||r.hide||!U(r))continue;if(!t.has(r.queryType)){const s=(0,i.cloneDeep)(e);s.requestId=`${s.requestId}-${r.refId}`,s.targets=[],t.set(r.queryType,s)}const a=t.get(r.queryType);null==a||a.targets.push(r)}const s=Array.from(t.entries()).map((([e,t])=>{const s=this.pseudoDatasource[e];if(!s)throw new Error("Data source not created for query type "+e);return s.query(t)}));return 1===s.length?s[0]:s.length>1?(0,G.D)(s).pipe((0,B.U)((e=>{const t=[];for(const s of e)for(const e of s.data)t.push(e);return{state:r.LoadingState.Done,data:t}}))):(0,q.of)({state:r.LoadingState.Done,data:[]})}async annotationQuery(e){return this.azureLogAnalyticsDatasource.annotationQuery(e)}async metricFindQuery(e,t){var s;if(!e)return Promise.resolve([]);const r=null===(s=this.appInsightsDatasource)||void 0===s?void 0:s.metricFindQueryInternal(e);if(r)return r;const i=this.azureMonitorDatasource.metricFindQueryInternal(e);if(i)return i;const a=this.azureLogAnalyticsDatasource.metricFindQueryInternal(e,t);return a||Promise.resolve([])}async testDatasource(){var e;const t=[];return t.push(this.azureMonitorDatasource.testDatasource()),t.push(this.azureLogAnalyticsDatasource.testDatasource()),null!==(e=this.appInsightsDatasource)&&void 0!==e&&e.isConfigured()&&t.push(this.appInsightsDatasource.testDatasource()),await Promise.all(t).then((e=>{let t="success",s="";for(let r=0;r<e.length;r++)"success"!==e[r].status&&(t=e[r].status),s+=`${r+1}. ${e[r].message} `;return{status:t,message:s,title:(0,i.upperFirst)(t)}}))}getResourceGroups(e){return this.azureMonitorDatasource.getResourceGroups(this.replaceTemplateVariable(e))}getMetricDefinitions(e,t){return this.azureMonitorDatasource.getMetricDefinitions(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t))}getResourceNames(e,t,s){return this.azureMonitorDatasource.getResourceNames(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(s))}getMetricNames(e,t,s,r,i){return this.azureMonitorDatasource.getMetricNames(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(s),this.replaceTemplateVariable(r),this.replaceTemplateVariable(i))}getMetricNamespaces(e,t,s,r){return this.azureMonitorDatasource.getMetricNamespaces(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(s),this.replaceTemplateVariable(r))}getMetricMetadata(e,t,s,r,i,a){return this.azureMonitorDatasource.getMetricMetadata(this.replaceTemplateVariable(e),this.replaceTemplateVariable(t),this.replaceTemplateVariable(s),this.replaceTemplateVariable(r),this.replaceTemplateVariable(i),this.replaceTemplateVariable(a))}getAppInsightsMetricNames(){var e;return null===(e=this.appInsightsDatasource)||void 0===e?void 0:e.getMetricNames()}getAppInsightsMetricMetadata(e){var t;return null===(t=this.appInsightsDatasource)||void 0===t?void 0:t.getMetricMetadata(e)}getAppInsightsColumns(e){var t;return null===(t=this.appInsightsDatasource)||void 0===t?void 0:t.logAnalyticsColumns[e]}getAzureLogAnalyticsWorkspaces(e){return this.azureLogAnalyticsDatasource.getWorkspaces(e)}getSubscriptions(){return this.azureMonitorDatasource.getSubscriptions()}interpolateVariablesInQueries(e,t){return e.map((e=>{var s;if(!e.queryType)return e;const r=this.pseudoDatasource[e.queryType];return null!==(s=null==r?void 0:r.applyTemplateVariables(e,t))&&void 0!==s?s:e}))}replaceTemplateVariable(e){return this.templateSrv.replace(e)}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}isTemplateVariable(e){return this.getVariables().includes(e)}}function U(e){switch(e.queryType){case l.B.AzureMonitor:return!!e.azureMonitor;case l.B.LogAnalytics:return!!e.azureLogAnalytics;case l.B.AzureResourceGraph:return!!e.azureResourceGraph;case l.B.ApplicationInsights:return!!e.appInsights;case l.B.InsightsAnalytics:return!!e.insightsAnalytics;default:return!1}}var K,_,J,H,Z,Y,ee,te=s("./node_modules/react/index.js"),se=s("./packages/grafana-ui/src/index.ts"),re=s("./node_modules/react/jsx-runtime.js");const{Select:ie,Input:ae}=se.LegacyForms,oe=[{value:"msi",label:"Managed Identity"},{value:"clientsecret",label:"App Registration"}],ne=e=>{const{credentials:t,azureCloudOptions:s,onCredentialsChange:r,getSubscriptions:i,disabled:a}=e,o=function(e){switch(e.authType){case"msi":return!0;case"clientsecret":return!!(e.azureCloud&&e.tenantId&&e.clientId&&e.clientSecret)}}(t),[n,c]=(0,te.useState)([]),[u,l]=(0,te.useReducer)((e=>e+1),0);(0,te.useEffect)((()=>{if(!i||!o)return void p([]);let e=!1;return i().then((t=>{e||p(t,u)})),()=>{e=!0}}),[u]);const p=(e,s=!1)=>{if(c(e),i)if(s&&!t.defaultSubscriptionId&&e.length>0)d(e[0]);else if(t.defaultSubscriptionId){e.find((e=>e.value===t.defaultSubscriptionId))||d(void 0)}},d=e=>{if(r){const s=Object.assign({},t,{defaultSubscriptionId:null==e?void 0:e.value});r(s)}};return(0,re.jsxs)("div",{className:"gf-form-group",children:[e.managedIdentityEnabled&&(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsxs)("div",{className:"gf-form",children:[K||(K=(0,re.jsx)(se.InlineFormLabel,{className:"width-12",tooltip:"Choose the type of authentication to Azure services",children:"Authentication"})),(0,re.jsx)(ie,{menuShouldPortal:!0,className:"width-15",value:oe.find((e=>e.value===t.authType)),options:oe,onChange:e=>{if(r){c([]);const s=Object.assign({},t,{authType:e.value||"msi",defaultSubscriptionId:void 0});r(s)}},isDisabled:a})]})}),"clientsecret"===t.authType&&(0,re.jsxs)(re.Fragment,{children:[s&&(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsxs)("div",{className:"gf-form",children:[_||(_=(0,re.jsx)(se.InlineFormLabel,{className:"width-12",tooltip:"Choose an Azure Cloud",children:"Azure Cloud"})),(0,re.jsx)(ie,{menuShouldPortal:!0,className:"width-15",value:s.find((e=>e.value===t.azureCloud)),options:s,onChange:e=>{if(r&&"clientsecret"===t.authType){c([]);const s=Object.assign({},t,{azureCloud:e.value,defaultSubscriptionId:void 0});r(s)}},isDisabled:a})]})}),(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsxs)("div",{className:"gf-form",children:[J||(J=(0,re.jsx)(se.InlineFormLabel,{className:"width-12",children:"Directory (tenant) ID"})),(0,re.jsx)("div",{className:"width-15",children:(0,re.jsx)(ae,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.tenantId||"",onChange:e=>{if(r&&"clientsecret"===t.authType){c([]);const s=Object.assign({},t,{tenantId:e.target.value,defaultSubscriptionId:void 0});r(s)}},disabled:a})})]})}),(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsxs)("div",{className:"gf-form",children:[H||(H=(0,re.jsx)(se.InlineFormLabel,{className:"width-12",children:"Application (client) ID"})),(0,re.jsx)("div",{className:"width-15",children:(0,re.jsx)(ae,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.clientId||"",onChange:e=>{if(r&&"clientsecret"===t.authType){c([]);const s=Object.assign({},t,{clientId:e.target.value,defaultSubscriptionId:void 0});r(s)}},disabled:a})})]})}),!a&&("symbol"==typeof t.clientSecret?(0,re.jsxs)("div",{className:"gf-form-inline",children:[Z||(Z=(0,re.jsxs)("div",{className:"gf-form",children:[(0,re.jsx)(se.InlineFormLabel,{className:"width-12",children:"Client Secret"}),(0,re.jsx)(ae,{className:"width-25",placeholder:"configured",disabled:!0})]})),(0,re.jsx)("div",{className:"gf-form",children:(0,re.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,re.jsx)(se.Button,{variant:"secondary",type:"button",onClick:()=>{if(r&&"clientsecret"===t.authType){c([]);const e=Object.assign({},t,{clientSecret:"",defaultSubscriptionId:void 0});r(e)}},disabled:a,children:"reset"})})})]}):(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsxs)("div",{className:"gf-form",children:[Y||(Y=(0,re.jsx)(se.InlineFormLabel,{className:"width-12",children:"Client Secret"})),(0,re.jsx)("div",{className:"width-15",children:(0,re.jsx)(ae,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.clientSecret||"",onChange:e=>{if(r&&"clientsecret"===t.authType){c([]);const s=Object.assign({},t,{clientSecret:e.target.value,defaultSubscriptionId:void 0});r(s)}},disabled:a})})]})}))]}),i&&(0,re.jsxs)(re.Fragment,{children:[(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsxs)("div",{className:"gf-form",children:[ee||(ee=(0,re.jsx)(se.InlineFormLabel,{className:"width-12",children:"Default Subscription"})),(0,re.jsx)("div",{className:"width-30",children:(0,re.jsx)(ie,{menuShouldPortal:!0,value:t.defaultSubscriptionId?n.find((e=>e.value===t.defaultSubscriptionId)):void 0,options:n,onChange:d,isDisabled:a})})]})}),!a&&(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsx)("div",{className:"gf-form",children:(0,re.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,re.jsx)(se.Button,{variant:"secondary",size:"sm",type:"button",onClick:l,disabled:!o,children:"Load Subscriptions"})})})})]}),e.children]})};var ce;const ue=[{value:"azuremonitor",label:"Azure"},{value:"govazuremonitor",label:"Azure US Government"},{value:"germanyazuremonitor",label:"Azure Germany"},{value:"chinaazuremonitor",label:"Azure China"}],le=e=>{const{updateOptions:t,getSubscriptions:s}=e,r=(0,te.useMemo)((()=>b(e.options)),[e.options]);return(0,re.jsxs)(re.Fragment,{children:[ce||(ce=(0,re.jsx)("h3",{className:"page-heading",children:"Authentication"})),(0,re.jsx)(ne,{managedIdentityEnabled:p.config.azure.managedIdentityEnabled,credentials:r,azureCloudOptions:ue,onCredentialsChange:e=>{t((t=>function(e,t){switch(t.authType){case"msi":if(!p.config.azure.managedIdentityEnabled)throw new Error("Managed Identity authentication is not enabled in Grafana config.");return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureAuthType:"msi",subscriptionId:t.defaultSubscriptionId})});case"clientsecret":return Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureAuthType:"clientsecret",cloudName:t.azureCloud||f(),tenantId:t.tenantId,clientId:t.clientId,subscriptionId:t.defaultSubscriptionId}),secureJsonData:Object.assign({},e.secureJsonData,{clientSecret:"string"==typeof t.clientSecret&&t.clientSecret.length>0?t.clientSecret:void 0}),secureJsonFields:Object.assign({},e.secureJsonFields,{clientSecret:"symbol"==typeof t.clientSecret})})}}(t,e)))},getSubscriptions:s,disabled:e.options.readOnly})]})};var pe,de;const he=e=>{const{updateOptions:t}=e,s=(0,te.useMemo)((()=>b(e.options)),[e.options]);return"clientsecret"===s.authType&&!1===e.options.jsonData.azureLogAnalyticsSameAs?(0,re.jsxs)(re.Fragment,{children:[pe||(pe=(0,re.jsx)("h3",{className:"page-heading",children:"Azure Monitor Logs"})),(0,re.jsxs)(re.Fragment,{children:[de||(de=(0,re.jsx)(se.Alert,{severity:"error",title:"Deprecated",children:"Using different credentials for Azure Monitor Logs is no longer supported. Authentication information above will be used instead. Please create a new data source with the credentials below."})),(0,re.jsx)(ne,{managedIdentityEnabled:!1,credentials:Object.assign({},s,{authType:"clientsecret",tenantId:e.options.jsonData.logAnalyticsTenantId,clientId:e.options.jsonData.logAnalyticsClientId}),disabled:!0,children:(0,re.jsx)(se.Button,{onClick:()=>{t((e=>Object.assign({},e,{jsonData:Object.assign({},e.jsonData,{azureLogAnalyticsSameAs:!0})})))},children:"Clear Azure Monitor Logs Credentials"})})]})]}):null};var ge,fe,me,ve,Me;const{Input:be}=se.LegacyForms;class ye extends te.PureComponent{constructor(...e){var t,s,r;super(...e),r=()=>{this.props.onResetOptionKey("appInsightsApiKey")},(s="onAppInsightsResetApiKey")in(t=this)?Object.defineProperty(t,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[s]=r}render(){const{options:e,onUpdateJsonDataOption:t,onUpdateSecureJsonDataOption:s}=this.props;return(0,re.jsxs)(re.Fragment,{children:[ge||(ge=(0,re.jsx)("h3",{className:"page-heading",children:"Azure Application Insights"})),fe||(fe=(0,re.jsx)(se.Alert,{severity:"info",title:"Application Insights credentials are deprecated",children:"Configure using Azure AD App Registration above and update existing queries to use Metrics or Logs."})),(0,re.jsxs)("div",{className:"gf-form-group",children:[e.secureJsonFields.appInsightsApiKey?(0,re.jsxs)("div",{className:"gf-form-inline",children:[me||(me=(0,re.jsxs)("div",{className:"gf-form",children:[(0,re.jsx)(se.InlineFormLabel,{className:"width-12",children:"API Key"}),(0,re.jsx)(be,{className:"width-25",placeholder:"configured",disabled:!0})]})),(0,re.jsx)("div",{className:"gf-form",children:(0,re.jsx)("div",{className:"max-width-30 gf-form-inline",children:(0,re.jsx)(se.Button,{variant:"secondary",type:"button",onClick:this.onAppInsightsResetApiKey,disabled:this.props.options.readOnly,children:"reset"})})})]}):(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsxs)("div",{className:"gf-form",children:[ve||(ve=(0,re.jsx)(se.InlineFormLabel,{className:"width-12",children:"API Key"})),(0,re.jsx)("div",{className:"width-15",children:(0,re.jsx)(be,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:e.secureJsonData.appInsightsApiKey||"",onChange:s("appInsightsApiKey"),disabled:this.props.options.readOnly})})]})}),(0,re.jsx)("div",{className:"gf-form-inline",children:(0,re.jsxs)("div",{className:"gf-form",children:[Me||(Me=(0,re.jsx)(se.InlineFormLabel,{className:"width-12",children:"Application ID"})),(0,re.jsx)("div",{className:"width-15",children:(0,re.jsx)(be,{className:"width-30",value:e.jsonData.appInsightsAppId||"",onChange:t("appInsightsAppId"),disabled:this.props.options.readOnly})})]})})]})]})}}function Se(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class we extends te.PureComponent{constructor(e){var t;super(e),Se(this,"templateSrv",(0,p.getTemplateSrv)()),Se(this,"baseURL",void 0),Se(this,"updateOptions",(e=>{const t=e(this.props.options);this.props.onOptionsChange(t),this.setState({unsaved:!0})})),Se(this,"saveOptions",(async()=>{this.state.unsaved&&(await(0,p.getBackendSrv)().put(`/api/datasources/${this.props.options.id}`,this.props.options).then((e=>{(0,r.updateDatasourcePluginOption)(this.props,"version",e.datasource.version)})),this.setState({unsaved:!1}))})),Se(this,"getSubscriptions",(async()=>{await this.saveOptions();try{const e=await(0,p.getBackendSrv)().fetch({url:this.baseURL+"?api-version=2019-03-01",method:"GET"}).toPromise();return this.setState({error:void 0}),c.parseSubscriptionsForSelect(e)}catch(t){var e;return this.setState({error:{title:"Error requesting subscriptions",description:"Could not request subscriptions from Azure. Check your credentials and try again.",details:null==t||null===(e=t.data)||void 0===e?void 0:e.message}}),Promise.resolve([])}})),Se(this,"onUpdateJsonDataOption",(e=>t=>{(0,r.updateDatasourcePluginJsonDataOption)(this.props,e,t.currentTarget.value)})),Se(this,"onUpdateSecureJsonDataOption",(e=>t=>{(0,r.updateDatasourcePluginSecureJsonDataOption)(this.props,e,t.currentTarget.value)})),Se(this,"resetSecureKey",(e=>{(0,r.updateDatasourcePluginResetOption)(this.props,e)})),this.state={unsaved:!1,appInsightsInitiallyConfigured:(t=e.options,!(!t.jsonData.appInsightsAppId||!t.secureJsonFields.appInsightsApiKey))},this.baseURL=`/api/datasources/${this.props.options.id}/resources/${S.kr.azureMonitor}/subscriptions`}render(){const{options:e}=this.props,{error:t}=this.state;return(0,re.jsxs)(re.Fragment,{children:[(0,re.jsx)(le,{options:e,updateOptions:this.updateOptions,getSubscriptions:this.getSubscriptions}),(0,re.jsx)(he,{options:e,updateOptions:this.updateOptions}),this.state.appInsightsInitiallyConfigured&&(0,re.jsx)(ye,{options:e,onUpdateJsonDataOption:this.onUpdateJsonDataOption,onUpdateSecureJsonDataOption:this.onUpdateSecureJsonDataOption,onResetOptionKey:this.resetSecureKey}),t&&(0,re.jsxs)(se.Alert,{severity:"error",title:t.title,children:[(0,re.jsx)("p",{children:t.description}),t.details&&(0,re.jsx)("details",{style:{whiteSpace:"pre-wrap"},children:t.details})]})]})}}var Ie=s("./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/QueryEditor/QueryEditor.tsx");const Ae=new r.DataSourcePlugin(W).setConfigEditor(we).setQueryEditor(Ie.Z)}}]);
//# sourceMappingURL=azureMonitorPlugin.0e7ce18a6cf0f8775a65.js.map