{"version":3,"file":"tempoPlugin.e65e3aa10981aa98e7a1.js","mappings":"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","sources":["webpack://grafana/./public/app/core/components/NodeGraphSettings.tsx","webpack://grafana/./public/app/core/components/TraceToLogsSettings.tsx","webpack://grafana/./public/app/core/utils/tracing.ts","webpack://grafana/./public/app/plugins/datasource/tempo/configuration/ServiceGraphSettings.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/configuration/SearchSettings.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/datasource.ts","webpack://grafana/./public/app/plugins/datasource/tempo/language_provider.ts","webpack://grafana/./public/app/plugins/datasource/tempo/QueryEditor/NativeSearch.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/syntax.ts","webpack://grafana/./public/app/plugins/datasource/tempo/QueryEditor/utils.ts","webpack://grafana/./public/app/plugins/datasource/tempo/QueryEditor/ServiceGraphSection.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/QueryEditor/QueryField.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/module.ts","webpack://grafana/./public/app/plugins/datasource/tempo/configuration/ConfigEditor.tsx","webpack://grafana/./public/app/plugins/datasource/tempo/CheatSheet.tsx"],"sourcesContent":["import React from 'react';\nimport { css } from '@emotion/css';\nimport {\n  DataSourceJsonData,\n  DataSourcePluginOptionsEditorProps,\n  GrafanaTheme,\n  updateDatasourcePluginJsonDataOption,\n} from '@grafana/data';\nimport { InlineField, InlineFieldRow, InlineSwitch, useStyles } from '@grafana/ui';\n\nexport interface NodeGraphOptions {\n  enabled?: boolean;\n}\n\nexport interface NodeGraphData extends DataSourceJsonData {\n  nodeGraph?: NodeGraphOptions;\n}\n\ninterface Props extends DataSourcePluginOptionsEditorProps<NodeGraphData> {}\n\nexport function NodeGraphSettings({ options, onOptionsChange }: Props) {\n  const styles = useStyles(getStyles);\n\n  return (\n    <div className={styles.container}>\n      <h3 className=\"page-heading\">Node Graph</h3>\n      <InlineFieldRow className={styles.row}>\n        <InlineField\n          tooltip=\"Enables the Node Graph visualization in the trace viewer.\"\n          label=\"Enable Node Graph\"\n          labelWidth={26}\n        >\n          <InlineSwitch\n            id=\"enableNodeGraph\"\n            value={options.jsonData.nodeGraph?.enabled}\n            onChange={(event: React.SyntheticEvent<HTMLInputElement>) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'nodeGraph', {\n                ...options.jsonData.nodeGraph,\n                enabled: event.currentTarget.checked,\n              })\n            }\n          />\n        </InlineField>\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme) => ({\n  container: css`\n    label: container;\n    width: 100%;\n  `,\n  row: css`\n    label: row;\n    align-items: baseline;\n  `,\n});\n","import { css } from '@emotion/css';\nimport {\n  DataSourceJsonData,\n  DataSourcePluginOptionsEditorProps,\n  GrafanaTheme,\n  updateDatasourcePluginJsonDataOption,\n} from '@grafana/data';\nimport { DataSourcePicker } from '@grafana/runtime';\nimport { InlineField, InlineFieldRow, Input, TagsInput, useStyles, InlineSwitch } from '@grafana/ui';\nimport React from 'react';\n\nexport interface TraceToLogsOptions {\n  datasourceUid?: string;\n  tags?: string[];\n  spanStartTimeShift?: string;\n  spanEndTimeShift?: string;\n  filterByTraceID?: boolean;\n  filterBySpanID?: boolean;\n  lokiSearch?: boolean;\n}\n\nexport interface TraceToLogsData extends DataSourceJsonData {\n  tracesToLogs?: TraceToLogsOptions;\n}\n\ninterface Props extends DataSourcePluginOptionsEditorProps<TraceToLogsData> {}\n\nexport function TraceToLogsSettings({ options, onOptionsChange }: Props) {\n  const styles = useStyles(getStyles);\n\n  return (\n    <div className={css({ width: '100%' })}>\n      <h3 className=\"page-heading\">Trace to logs</h3>\n\n      <div className={styles.infoText}>\n        Trace to logs lets you navigate from a trace span to the selected data source&apos;s log.\n      </div>\n\n      <InlineFieldRow>\n        <InlineField tooltip=\"The data source the trace is going to navigate to\" label=\"Data source\" labelWidth={26}>\n          <DataSourcePicker\n            inputId=\"trace-to-logs-data-source-picker\"\n            pluginId=\"loki\"\n            current={options.jsonData.tracesToLogs?.datasourceUid}\n            noDefault={true}\n            width={40}\n            onChange={(ds) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'tracesToLogs', {\n                datasourceUid: ds.uid,\n                tags: options.jsonData.tracesToLogs?.tags,\n              })\n            }\n          />\n        </InlineField>\n      </InlineFieldRow>\n\n      <InlineFieldRow>\n        <InlineField\n          tooltip=\"Tags that will be used in the Loki query. Default tags: 'cluster', 'hostname', 'namespace', 'pod'\"\n          label=\"Tags\"\n          labelWidth={26}\n        >\n          <TagsInput\n            tags={options.jsonData.tracesToLogs?.tags}\n            width={40}\n            onChange={(tags) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'tracesToLogs', {\n                datasourceUid: options.jsonData.tracesToLogs?.datasourceUid,\n                tags: tags,\n              })\n            }\n          />\n        </InlineField>\n      </InlineFieldRow>\n\n      <InlineFieldRow>\n        <InlineField\n          label=\"Span start time shift\"\n          labelWidth={26}\n          grow\n          tooltip=\"Shifts the start time of the span. Default 0 (Time units can be used here, for example: 5s, 1m, 3h)\"\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"1h\"\n            width={40}\n            onChange={(v) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'tracesToLogs', {\n                ...options.jsonData.tracesToLogs,\n                spanStartTimeShift: v.currentTarget.value,\n              })\n            }\n            value={options.jsonData.tracesToLogs?.spanStartTimeShift || ''}\n          />\n        </InlineField>\n      </InlineFieldRow>\n\n      <InlineFieldRow>\n        <InlineField\n          label=\"Span end time shift\"\n          labelWidth={26}\n          grow\n          tooltip=\"Shifts the end time of the span. Default 0 Time units can be used here, for example: 5s, 1m, 3h\"\n        >\n          <Input\n            type=\"text\"\n            placeholder=\"1h\"\n            width={40}\n            onChange={(v) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'tracesToLogs', {\n                ...options.jsonData.tracesToLogs,\n                spanEndTimeShift: v.currentTarget.value,\n              })\n            }\n            value={options.jsonData.tracesToLogs?.spanEndTimeShift || ''}\n          />\n        </InlineField>\n      </InlineFieldRow>\n\n      <InlineFieldRow>\n        <InlineField\n          label=\"Filter by Trace ID\"\n          labelWidth={26}\n          grow\n          tooltip=\"Filters logs by Trace ID. Appends '|=<trace id>' to the query.\"\n        >\n          <InlineSwitch\n            id=\"filterByTraceID\"\n            value={options.jsonData.tracesToLogs?.filterByTraceID}\n            onChange={(event: React.SyntheticEvent<HTMLInputElement>) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'tracesToLogs', {\n                ...options.jsonData.tracesToLogs,\n                filterByTraceID: event.currentTarget.checked,\n              })\n            }\n          />\n        </InlineField>\n      </InlineFieldRow>\n\n      <InlineFieldRow>\n        <InlineField\n          label=\"Filter by Span ID\"\n          labelWidth={26}\n          grow\n          tooltip=\"Filters logs by Span ID. Appends '|=<span id>' to the query.\"\n        >\n          <InlineSwitch\n            id=\"filterBySpanID\"\n            value={options.jsonData.tracesToLogs?.filterBySpanID}\n            onChange={(event: React.SyntheticEvent<HTMLInputElement>) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'tracesToLogs', {\n                ...options.jsonData.tracesToLogs,\n                filterBySpanID: event.currentTarget.checked,\n              })\n            }\n          />\n        </InlineField>\n      </InlineFieldRow>\n      <InlineFieldRow>\n        <InlineField label=\"Loki Search\" labelWidth={26} grow tooltip=\"Use this logs data source to search for traces.\">\n          <InlineSwitch\n            id=\"lokiSearch\"\n            defaultChecked={true}\n            value={options.jsonData.tracesToLogs?.lokiSearch}\n            onChange={(event: React.SyntheticEvent<HTMLInputElement>) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'tracesToLogs', {\n                ...options.jsonData.tracesToLogs,\n                lokiSearch: event.currentTarget.checked,\n              })\n            }\n          />\n        </InlineField>\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme) => ({\n  infoText: css`\n    padding-bottom: ${theme.spacing.md};\n    color: ${theme.colors.textSemiWeak};\n  `,\n});\n","/**\n * Get non overlapping duration of the ranges as they can overlap or have gaps.\n */\nimport { FieldType, MutableDataFrame, NodeGraphDataFrameFieldNames as Fields } from '@grafana/data';\n\nexport function getNonOverlappingDuration(ranges: Array<[number, number]>): number {\n  ranges.sort((a, b) => a[0] - b[0]);\n  const mergedRanges = ranges.reduce((acc, range) => {\n    if (!acc.length) {\n      return [range];\n    }\n    const tail = acc.slice(-1)[0];\n    const [prevStart, prevEnd] = tail;\n    const [start, end] = range;\n    if (end < prevEnd) {\n      // In this case the range is completely inside the prev range so we can just ignore it.\n      return acc;\n    }\n\n    if (start > prevEnd) {\n      // There is no overlap so we can just add it to stack\n      return [...acc, range];\n    }\n\n    // We know there is overlap and current range ends later than previous so we can just extend the range\n    return [...acc.slice(0, -1), [prevStart, end]] as Array<[number, number]>;\n  }, [] as Array<[number, number]>);\n\n  return mergedRanges.reduce((acc, range) => {\n    return acc + (range[1] - range[0]);\n  }, 0);\n}\n\n/**\n * Returns a map of the spans with children array for easier processing. It will also contain empty spans in case\n * span is missing but other spans are it's children. This is more generic because it needs to allow iterating over\n * both arrays and dataframe views.\n */\nexport function makeSpanMap<T>(getSpan: (index: number) => { span: T; id: string; parentIds: string[] } | undefined): {\n  [id: string]: { span: T; children: string[] };\n} {\n  const spanMap: { [id: string]: { span?: T; children: string[] } } = {};\n\n  let span;\n  for (let index = 0; (span = getSpan(index)), !!span; index++) {\n    if (!spanMap[span.id]) {\n      spanMap[span.id] = {\n        span: span.span,\n        children: [],\n      };\n    } else {\n      spanMap[span.id].span = span.span;\n    }\n\n    for (const parentId of span.parentIds) {\n      if (parentId) {\n        if (!spanMap[parentId]) {\n          spanMap[parentId] = {\n            span: undefined,\n            children: [span.id],\n          };\n        } else {\n          spanMap[parentId].children.push(span.id);\n        }\n      }\n    }\n  }\n  return spanMap as { [id: string]: { span: T; children: string[] } };\n}\n\nexport function getStats(duration: number, traceDuration: number, selfDuration: number) {\n  return {\n    main: `${toFixedNoTrailingZeros(duration)}ms (${toFixedNoTrailingZeros((duration / traceDuration) * 100)}%)`,\n    secondary: `${toFixedNoTrailingZeros(selfDuration)}ms (${toFixedNoTrailingZeros(\n      (selfDuration / duration) * 100\n    )}%)`,\n  };\n}\n\nfunction toFixedNoTrailingZeros(n: number) {\n  return parseFloat(n.toFixed(2));\n}\n\n/**\n * Create default frames used when returning data for node graph.\n */\nexport function makeFrames() {\n  const nodesFrame = new MutableDataFrame({\n    fields: [\n      { name: Fields.id, type: FieldType.string },\n      { name: Fields.title, type: FieldType.string },\n      { name: Fields.subTitle, type: FieldType.string },\n      { name: Fields.mainStat, type: FieldType.string, config: { displayName: 'Total time (% of trace)' } },\n      { name: Fields.secondaryStat, type: FieldType.string, config: { displayName: 'Self time (% of total)' } },\n      {\n        name: Fields.color,\n        type: FieldType.number,\n        config: { color: { mode: 'continuous-GrYlRd' }, displayName: 'Self time / Trace duration' },\n      },\n    ],\n    meta: {\n      preferredVisualisationType: 'nodeGraph',\n    },\n  });\n\n  const edgesFrame = new MutableDataFrame({\n    fields: [\n      { name: Fields.id, type: FieldType.string },\n      { name: Fields.target, type: FieldType.string },\n      { name: Fields.source, type: FieldType.string },\n    ],\n    meta: {\n      preferredVisualisationType: 'nodeGraph',\n    },\n  });\n\n  return [nodesFrame, edgesFrame];\n}\n","import { css } from '@emotion/css';\nimport { DataSourcePluginOptionsEditorProps, GrafanaTheme, updateDatasourcePluginJsonDataOption } from '@grafana/data';\nimport { DataSourcePicker } from '@grafana/runtime';\nimport { Button, InlineField, InlineFieldRow, useStyles } from '@grafana/ui';\nimport React from 'react';\nimport { TempoJsonData } from '../datasource';\n\ninterface Props extends DataSourcePluginOptionsEditorProps<TempoJsonData> {}\n\nexport function ServiceGraphSettings({ options, onOptionsChange }: Props) {\n  const styles = useStyles(getStyles);\n\n  return (\n    <div className={css({ width: '100%' })}>\n      <h3 className=\"page-heading\">Service Graph</h3>\n\n      <div className={styles.infoText}>\n        To allow querying service graph data you have to select a Prometheus instance where the data is stored.\n      </div>\n\n      <InlineFieldRow className={styles.row}>\n        <InlineField\n          tooltip=\"The Prometheus data source with the service graph data\"\n          label=\"Data source\"\n          labelWidth={26}\n        >\n          <DataSourcePicker\n            inputId=\"service-graph-data-source-picker\"\n            pluginId=\"prometheus\"\n            current={options.jsonData.serviceMap?.datasourceUid}\n            noDefault={true}\n            width={40}\n            onChange={(ds) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'serviceMap', {\n                datasourceUid: ds.uid,\n              })\n            }\n          />\n        </InlineField>\n        <Button\n          type={'button'}\n          variant={'secondary'}\n          size={'sm'}\n          fill={'text'}\n          onClick={() => {\n            updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'serviceMap', {\n              datasourceUid: undefined,\n            });\n          }}\n        >\n          Clear\n        </Button>\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme) => ({\n  infoText: css`\n    label: infoText;\n    padding-bottom: ${theme.spacing.md};\n    color: ${theme.colors.textSemiWeak};\n  `,\n\n  row: css`\n    label: row;\n    align-items: baseline;\n  `,\n});\n","import { css } from '@emotion/css';\nimport { DataSourcePluginOptionsEditorProps, GrafanaTheme, updateDatasourcePluginJsonDataOption } from '@grafana/data';\nimport { InlineField, InlineFieldRow, InlineSwitch, useStyles } from '@grafana/ui';\nimport React from 'react';\nimport { TempoJsonData } from '../datasource';\n\ninterface Props extends DataSourcePluginOptionsEditorProps<TempoJsonData> {}\n\nexport function SearchSettings({ options, onOptionsChange }: Props) {\n  const styles = useStyles(getStyles);\n\n  return (\n    <div className={styles.container}>\n      <h3 className=\"page-heading\">Search</h3>\n      <InlineFieldRow className={styles.row}>\n        <InlineField tooltip=\"Removes the Search tab from the Tempo query editor.\" label=\"Hide search\" labelWidth={26}>\n          <InlineSwitch\n            id=\"hideSearch\"\n            value={options.jsonData.search?.hide}\n            onChange={(event: React.SyntheticEvent<HTMLInputElement>) =>\n              updateDatasourcePluginJsonDataOption({ onOptionsChange, options }, 'search', {\n                ...options.jsonData.search,\n                hide: event.currentTarget.checked,\n              })\n            }\n          />\n        </InlineField>\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nconst getStyles = (theme: GrafanaTheme) => ({\n  container: css`\n    label: container;\n    width: 100%;\n  `,\n  row: css`\n    label: row;\n    align-items: baseline;\n  `,\n});\n","import { EMPTY, from, merge, Observable, of, throwError } from 'rxjs';\nimport { catchError, map, mergeMap, toArray } from 'rxjs/operators';\nimport {\n  DataQuery,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataSourceApi,\n  DataSourceInstanceSettings,\n  DataSourceJsonData,\n  isValidGoDuration,\n  LoadingState,\n} from '@grafana/data';\nimport { TraceToLogsOptions } from 'app/core/components/TraceToLogsSettings';\nimport { config, BackendSrvRequest, DataSourceWithBackend, getBackendSrv } from '@grafana/runtime';\nimport { serializeParams } from 'app/core/utils/fetch';\nimport { getDatasourceSrv } from 'app/features/plugins/datasource_srv';\nimport { identity, pick, pickBy, groupBy, startCase } from 'lodash';\nimport { LokiOptions, LokiQuery } from '../loki/types';\nimport { PrometheusDatasource } from '../prometheus/datasource';\nimport { PromQuery } from '../prometheus/types';\nimport {\n  failedMetric,\n  histogramMetric,\n  mapPromMetricsToServiceMap,\n  serviceMapMetrics,\n  totalsMetric,\n} from './graphTransform';\nimport {\n  transformTrace,\n  transformTraceList,\n  transformFromOTLP as transformFromOTEL,\n  createTableFrameFromSearch,\n} from './resultTransformer';\nimport { NodeGraphOptions } from 'app/core/components/NodeGraphSettings';\n\n// search = Loki search, nativeSearch = Tempo search for backwards compatibility\nexport type TempoQueryType = 'search' | 'traceId' | 'serviceMap' | 'upload' | 'nativeSearch' | 'clear';\n\nexport interface TempoJsonData extends DataSourceJsonData {\n  tracesToLogs?: TraceToLogsOptions;\n  serviceMap?: {\n    datasourceUid?: string;\n  };\n  search?: {\n    hide?: boolean;\n  };\n  nodeGraph?: NodeGraphOptions;\n}\n\nexport interface TempoQuery extends DataQuery {\n  query: string;\n  // Query to find list of traces, e.g., via Loki\n  linkedQuery?: LokiQuery;\n  search: string;\n  queryType: TempoQueryType;\n  serviceName?: string;\n  spanName?: string;\n  minDuration?: string;\n  maxDuration?: string;\n  limit?: number;\n  serviceMapQuery?: string;\n}\n\ninterface SearchQueryParams {\n  minDuration?: string;\n  maxDuration?: string;\n  limit?: number;\n  tags: string;\n  start?: number;\n  end?: number;\n}\n\nexport const DEFAULT_LIMIT = 20;\n\nexport class TempoDatasource extends DataSourceWithBackend<TempoQuery, TempoJsonData> {\n  tracesToLogs?: TraceToLogsOptions;\n  serviceMap?: {\n    datasourceUid?: string;\n  };\n  search?: {\n    hide?: boolean;\n  };\n  nodeGraph?: NodeGraphOptions;\n  uploadedJson?: string | ArrayBuffer | null = null;\n\n  constructor(private instanceSettings: DataSourceInstanceSettings<TempoJsonData>) {\n    super(instanceSettings);\n    this.tracesToLogs = instanceSettings.jsonData.tracesToLogs;\n    this.serviceMap = instanceSettings.jsonData.serviceMap;\n    this.search = instanceSettings.jsonData.search;\n    this.nodeGraph = instanceSettings.jsonData.nodeGraph;\n  }\n\n  query(options: DataQueryRequest<TempoQuery>): Observable<DataQueryResponse> {\n    const subQueries: Array<Observable<DataQueryResponse>> = [];\n    const filteredTargets = options.targets.filter((target) => !target.hide);\n    const targets: { [type: string]: TempoQuery[] } = groupBy(filteredTargets, (t) => t.queryType || 'traceId');\n\n    if (targets.clear) {\n      return of({ data: [], state: LoadingState.Done });\n    }\n\n    // Run search queries on linked datasource\n    if (this.tracesToLogs?.datasourceUid && targets.search?.length > 0) {\n      const dsSrv = getDatasourceSrv();\n      subQueries.push(\n        from(dsSrv.get(this.tracesToLogs.datasourceUid)).pipe(\n          mergeMap((linkedDatasource: DataSourceApi) => {\n            // Wrap linked query into a data request based on original request\n            const linkedRequest: DataQueryRequest = { ...options, targets: targets.search.map((t) => t.linkedQuery!) };\n            // Find trace matchers in derived fields of the linked datasource that's identical to this datasource\n            const settings: DataSourceInstanceSettings<LokiOptions> = (linkedDatasource as any).instanceSettings;\n            const traceLinkMatcher: string[] =\n              settings.jsonData.derivedFields\n                ?.filter((field) => field.datasourceUid === this.uid && field.matcherRegex)\n                .map((field) => field.matcherRegex) || [];\n            if (!traceLinkMatcher || traceLinkMatcher.length === 0) {\n              return throwError(\n                () =>\n                  new Error(\n                    'No Loki datasource configured for search. Set up Derived Fields for traces in a Loki datasource settings and link it to this Tempo datasource.'\n                  )\n              );\n            } else {\n              return (linkedDatasource.query(linkedRequest) as Observable<DataQueryResponse>).pipe(\n                map((response) =>\n                  response.error ? response : transformTraceList(response, this.uid, this.name, traceLinkMatcher)\n                )\n              );\n            }\n          })\n        )\n      );\n    }\n\n    if (targets.nativeSearch?.length) {\n      try {\n        const timeRange = config.featureToggles.tempoBackendSearch\n          ? { startTime: options.range.from.unix(), endTime: options.range.to.unix() }\n          : undefined;\n        const searchQuery = this.buildSearchQuery(targets.nativeSearch[0], timeRange);\n        subQueries.push(\n          this._request('/api/search', searchQuery).pipe(\n            map((response) => {\n              return {\n                data: [createTableFrameFromSearch(response.data.traces, this.instanceSettings)],\n              };\n            }),\n            catchError((error) => {\n              return of({ error: { message: error.data.message }, data: [] });\n            })\n          )\n        );\n      } catch (error) {\n        return of({ error: { message: error.message }, data: [] });\n      }\n    }\n\n    if (targets.upload?.length) {\n      if (this.uploadedJson) {\n        const otelTraceData = JSON.parse(this.uploadedJson as string);\n        if (!otelTraceData.batches) {\n          subQueries.push(of({ error: { message: 'JSON is not valid OpenTelemetry format' }, data: [] }));\n        } else {\n          subQueries.push(of(transformFromOTEL(otelTraceData.batches, this.nodeGraph?.enabled)));\n        }\n      } else {\n        subQueries.push(of({ data: [], state: LoadingState.Done }));\n      }\n    }\n\n    if (this.serviceMap?.datasourceUid && targets.serviceMap?.length > 0) {\n      subQueries.push(serviceMapQuery(options, this.serviceMap.datasourceUid));\n    }\n\n    if (targets.traceId?.length > 0) {\n      subQueries.push(this.handleTraceIdQuery(options, targets.traceId));\n    }\n\n    return merge(...subQueries);\n  }\n\n  /**\n   * Handles the simplest of the queries where we have just a trace id and return trace data for it.\n   * @param options\n   * @param targets\n   * @private\n   */\n  private handleTraceIdQuery(\n    options: DataQueryRequest<TempoQuery>,\n    targets: TempoQuery[]\n  ): Observable<DataQueryResponse> {\n    const validTargets = targets.filter((t) => t.query);\n    if (!validTargets.length) {\n      return EMPTY;\n    }\n\n    const traceRequest: DataQueryRequest<TempoQuery> = { ...options, targets: validTargets };\n    return super.query(traceRequest).pipe(\n      map((response) => {\n        if (response.error) {\n          return response;\n        }\n        return transformTrace(response, this.nodeGraph?.enabled);\n      })\n    );\n  }\n\n  async metadataRequest(url: string, params = {}) {\n    return await this._request(url, params, { method: 'GET', hideFromInspector: true }).toPromise();\n  }\n\n  private _request(apiUrl: string, data?: any, options?: Partial<BackendSrvRequest>): Observable<Record<string, any>> {\n    const params = data ? serializeParams(data) : '';\n    const url = `${this.instanceSettings.url}${apiUrl}${params.length ? `?${params}` : ''}`;\n    const req = { ...options, url };\n\n    return getBackendSrv().fetch(req);\n  }\n\n  async testDatasource(): Promise<any> {\n    const options: BackendSrvRequest = {\n      headers: {},\n      method: 'GET',\n      url: `${this.instanceSettings.url}/api/echo`,\n    };\n    const response = await getBackendSrv().fetch<any>(options).toPromise();\n\n    if (response?.ok) {\n      return { status: 'success', message: 'Data source is working' };\n    }\n  }\n\n  getQueryDisplayText(query: TempoQuery) {\n    if (query.queryType === 'nativeSearch') {\n      let result = [];\n      for (const key of ['serviceName', 'spanName', 'search', 'minDuration', 'maxDuration', 'limit']) {\n        if (query.hasOwnProperty(key) && query[key as keyof TempoQuery]) {\n          result.push(`${startCase(key)}: ${query[key as keyof TempoQuery]}`);\n        }\n      }\n      return result.join(', ');\n    }\n    return query.query;\n  }\n\n  buildSearchQuery(query: TempoQuery, timeRange?: { startTime: number; endTime?: number }): SearchQueryParams {\n    let tags = query.search ?? '';\n\n    let tempoQuery = pick(query, ['minDuration', 'maxDuration', 'limit']);\n    // Remove empty properties\n    tempoQuery = pickBy(tempoQuery, identity);\n\n    if (query.serviceName) {\n      tags += ` service.name=\"${query.serviceName}\"`;\n    }\n    if (query.spanName) {\n      tags += ` name=\"${query.spanName}\"`;\n    }\n\n    // Set default limit\n    if (!tempoQuery.limit) {\n      tempoQuery.limit = DEFAULT_LIMIT;\n    }\n\n    // Validate query inputs and remove spaces if valid\n    if (tempoQuery.minDuration) {\n      if (!isValidGoDuration(tempoQuery.minDuration)) {\n        throw new Error('Please enter a valid min duration.');\n      }\n      tempoQuery.minDuration = tempoQuery.minDuration.replace(/\\s/g, '');\n    }\n    if (tempoQuery.maxDuration) {\n      if (!isValidGoDuration(tempoQuery.maxDuration)) {\n        throw new Error('Please enter a valid max duration.');\n      }\n      tempoQuery.maxDuration = tempoQuery.maxDuration.replace(/\\s/g, '');\n    }\n\n    if (!Number.isInteger(tempoQuery.limit) || tempoQuery.limit <= 0) {\n      throw new Error('Please enter a valid limit.');\n    }\n\n    let searchQuery: SearchQueryParams = { tags, ...tempoQuery };\n\n    if (timeRange) {\n      searchQuery.start = timeRange.startTime;\n      searchQuery.end = timeRange.endTime;\n    }\n\n    return searchQuery;\n  }\n\n  async getServiceGraphLabels() {\n    const ds = await getDatasourceSrv().get(this.serviceMap!.datasourceUid);\n    return ds.getTagKeys!();\n  }\n\n  async getServiceGraphLabelValues(key: string) {\n    const ds = await getDatasourceSrv().get(this.serviceMap!.datasourceUid);\n    return ds.getTagValues!({ key });\n  }\n}\n\nfunction queryServiceMapPrometheus(request: DataQueryRequest<PromQuery>, datasourceUid: string) {\n  return from(getDatasourceSrv().get(datasourceUid)).pipe(\n    mergeMap((ds) => {\n      return (ds as PrometheusDatasource).query(request);\n    })\n  );\n}\n\nfunction serviceMapQuery(request: DataQueryRequest<TempoQuery>, datasourceUid: string) {\n  return queryServiceMapPrometheus(makePromServiceMapRequest(request), datasourceUid).pipe(\n    // Just collect all the responses first before processing into node graph data\n    toArray(),\n    map((responses: DataQueryResponse[]) => {\n      const errorRes = responses.find((res) => !!res.error);\n      if (errorRes) {\n        throw new Error(errorRes.error!.message);\n      }\n\n      const { nodes, edges } = mapPromMetricsToServiceMap(responses, request.range);\n      nodes.fields[0].config = {\n        links: [\n          makePromLink(\n            'Request rate',\n            `rate(${totalsMetric}{server=\"\\${__data.fields.id}\"}[$__rate_interval])`,\n            datasourceUid\n          ),\n          makePromLink(\n            'Request histogram',\n            `histogram_quantile(0.9, sum(rate(${histogramMetric}{server=\"\\${__data.fields.id}\"}[$__rate_interval])) by (le, client, server))`,\n            datasourceUid\n          ),\n          makePromLink(\n            'Failed request rate',\n            `rate(${failedMetric}{server=\"\\${__data.fields.id}\"}[$__rate_interval])`,\n            datasourceUid\n          ),\n        ],\n      };\n\n      return {\n        data: [nodes, edges],\n        state: LoadingState.Done,\n      };\n    })\n  );\n}\n\nfunction makePromLink(title: string, metric: string, datasourceUid: string) {\n  return {\n    url: '',\n    title,\n    internal: {\n      query: {\n        expr: metric,\n      } as PromQuery,\n      datasourceUid,\n      datasourceName: 'Prometheus',\n    },\n  };\n}\n\nfunction makePromServiceMapRequest(options: DataQueryRequest<TempoQuery>): DataQueryRequest<PromQuery> {\n  return {\n    ...options,\n    targets: serviceMapMetrics.map((metric) => {\n      return {\n        refId: metric,\n        // options.targets[0] is not correct here, but not sure what should happen if you have multiple queries for\n        // service map at the same time anyway\n        expr: `delta(${metric}${options.targets[0].serviceMapQuery || ''}[$__range])`,\n        instant: true,\n      };\n    }),\n  };\n}\n","import { HistoryItem, LanguageProvider, SelectableValue } from '@grafana/data';\nimport { CompletionItemGroup, TypeaheadInput, TypeaheadOutput } from '@grafana/ui';\nimport { Value } from 'slate';\nimport { TempoDatasource } from './datasource';\n\nexport default class TempoLanguageProvider extends LanguageProvider {\n  datasource: TempoDatasource;\n  tags?: string[];\n  constructor(datasource: TempoDatasource, initialValues?: any) {\n    super();\n\n    this.datasource = datasource;\n    Object.assign(this, initialValues);\n  }\n\n  request = async (url: string, params = {}) => {\n    const res = await this.datasource.metadataRequest(url, params);\n    return res?.data;\n  };\n\n  start = async () => {\n    await this.fetchTags();\n    return [];\n  };\n\n  async fetchTags() {\n    const response = await this.request('/api/search/tags', []);\n    this.tags = response.tagNames;\n  }\n\n  provideCompletionItems = async (\n    { prefix, text, value, labelKey, wrapperClasses }: TypeaheadInput,\n    context: { history: Array<HistoryItem<any>> } = { history: [] }\n  ): Promise<TypeaheadOutput> => {\n    const emptyResult: TypeaheadOutput = { suggestions: [] };\n\n    if (!value) {\n      return emptyResult;\n    }\n\n    const query = value.endText.getText();\n    const isValue = query[query.indexOf(text) - 1] === '=';\n    if (isValue || text === '=') {\n      return this.getTagValueCompletionItems(value);\n    }\n    return this.getTagsCompletionItems();\n  };\n\n  getTagsCompletionItems = (): TypeaheadOutput => {\n    const { tags } = this;\n    const suggestions: CompletionItemGroup[] = [];\n\n    if (tags?.length) {\n      suggestions.push({\n        label: `Tag`,\n        items: tags.map((tag) => ({ label: tag })),\n      });\n    }\n\n    return { suggestions };\n  };\n\n  async getTagValueCompletionItems(value: Value) {\n    const tags = value.endText.getText().split(' ');\n\n    let tagName = tags[tags.length - 1] ?? '';\n    tagName = tagName.split('=')[0];\n\n    const response = await this.request(`/api/search/tag/${tagName}/values`, []);\n    const suggestions: CompletionItemGroup[] = [];\n\n    if (response && response.tagValues) {\n      suggestions.push({\n        label: `Tag Values`,\n        items: response.tagValues.map((tagValue: string) => ({ label: tagValue })),\n      });\n    }\n    return { suggestions };\n  }\n\n  async getOptions(tag: string): Promise<Array<SelectableValue<string>>> {\n    const response = await this.request(`/api/search/tag/${tag}/values`);\n    let options: Array<SelectableValue<string>> = [];\n\n    if (response && response.tagValues) {\n      options = response.tagValues.map((v: string) => ({\n        value: v,\n        label: v,\n      }));\n    }\n\n    return options;\n  }\n}\n","import React, { useState, useEffect, useMemo } from 'react';\nimport {\n  InlineFieldRow,\n  InlineField,\n  Input,\n  QueryField,\n  SlatePrism,\n  BracesPlugin,\n  TypeaheadInput,\n  TypeaheadOutput,\n  Select,\n  Alert,\n  useStyles2,\n} from '@grafana/ui';\nimport { tokenizer } from '../syntax';\nimport Prism from 'prismjs';\nimport { Node } from 'slate';\nimport { css } from '@emotion/css';\nimport { GrafanaTheme2, isValidGoDuration, SelectableValue } from '@grafana/data';\nimport TempoLanguageProvider from '../language_provider';\nimport { TempoDatasource, TempoQuery } from '../datasource';\nimport { debounce } from 'lodash';\nimport { dispatch } from 'app/store/store';\nimport { notifyApp } from 'app/core/actions';\nimport { createErrorNotification } from 'app/core/copy/appNotification';\n\ninterface Props {\n  datasource: TempoDatasource;\n  query: TempoQuery;\n  onChange: (value: TempoQuery) => void;\n  onBlur?: () => void;\n  onRunQuery: () => void;\n}\n\nconst PRISM_LANGUAGE = 'tempo';\nconst durationPlaceholder = 'e.g. 1.2s, 100ms';\nconst plugins = [\n  BracesPlugin(),\n  SlatePrism({\n    onlyIn: (node: Node) => node.object === 'block' && node.type === 'code_block',\n    getSyntax: () => PRISM_LANGUAGE,\n  }),\n];\n\nPrism.languages[PRISM_LANGUAGE] = tokenizer;\n\nconst NativeSearch = ({ datasource, query, onChange, onBlur, onRunQuery }: Props) => {\n  const styles = useStyles2(getStyles);\n  const languageProvider = useMemo(() => new TempoLanguageProvider(datasource), [datasource]);\n  const [hasSyntaxLoaded, setHasSyntaxLoaded] = useState(false);\n  const [autocomplete, setAutocomplete] = useState<{\n    serviceNameOptions: Array<SelectableValue<string>>;\n    spanNameOptions: Array<SelectableValue<string>>;\n  }>({\n    serviceNameOptions: [],\n    spanNameOptions: [],\n  });\n  const [error, setError] = useState(null);\n  const [inputErrors, setInputErrors] = useState<{ [key: string]: boolean }>({});\n\n  const fetchServiceNameOptions = useMemo(\n    () =>\n      debounce(\n        async () => {\n          const res = await languageProvider.getOptions('service.name');\n          setAutocomplete((prev) => ({ ...prev, serviceNameOptions: res }));\n        },\n        500,\n        { leading: true, trailing: true }\n      ),\n    [languageProvider]\n  );\n\n  const fetchSpanNameOptions = useMemo(\n    () =>\n      debounce(\n        async () => {\n          const res = await languageProvider.getOptions('name');\n          setAutocomplete((prev) => ({ ...prev, spanNameOptions: res }));\n        },\n        500,\n        { leading: true, trailing: true }\n      ),\n    [languageProvider]\n  );\n\n  useEffect(() => {\n    const fetchAutocomplete = async () => {\n      try {\n        await languageProvider.start();\n        const serviceNameOptions = await languageProvider.getOptions('service.name');\n        const spanNameOptions = await languageProvider.getOptions('name');\n        setHasSyntaxLoaded(true);\n        setAutocomplete({ serviceNameOptions, spanNameOptions });\n      } catch (error) {\n        // Display message if Tempo is connected but search 404's\n        if (error?.status === 404) {\n          setError(error);\n        } else {\n          dispatch(notifyApp(createErrorNotification('Error', error)));\n        }\n      }\n    };\n    fetchAutocomplete();\n  }, [languageProvider, fetchServiceNameOptions, fetchSpanNameOptions]);\n\n  const onTypeahead = async (typeahead: TypeaheadInput): Promise<TypeaheadOutput> => {\n    return await languageProvider.provideCompletionItems(typeahead);\n  };\n\n  const cleanText = (text: string) => {\n    const splittedText = text.split(/\\s+(?=([^\"]*\"[^\"]*\")*[^\"]*$)/g);\n    if (splittedText.length > 1) {\n      return splittedText[splittedText.length - 1];\n    }\n    return text;\n  };\n\n  const onKeyDown = (keyEvent: React.KeyboardEvent) => {\n    if (keyEvent.key === 'Enter' && (keyEvent.shiftKey || keyEvent.ctrlKey)) {\n      onRunQuery();\n    }\n  };\n\n  return (\n    <>\n      <div className={styles.container}>\n        <InlineFieldRow>\n          <InlineField label=\"Service Name\" labelWidth={14} grow>\n            <Select\n              inputId=\"service\"\n              menuShouldPortal\n              options={autocomplete.serviceNameOptions}\n              value={query.serviceName || ''}\n              onChange={(v) => {\n                onChange({\n                  ...query,\n                  serviceName: v?.value || undefined,\n                });\n              }}\n              placeholder=\"Select a service\"\n              onOpenMenu={fetchServiceNameOptions}\n              isClearable\n              onKeyDown={onKeyDown}\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField label=\"Span Name\" labelWidth={14} grow>\n            <Select\n              inputId=\"spanName\"\n              menuShouldPortal\n              options={autocomplete.spanNameOptions}\n              value={query.spanName || ''}\n              onChange={(v) => {\n                onChange({\n                  ...query,\n                  spanName: v?.value || undefined,\n                });\n              }}\n              placeholder=\"Select a span\"\n              onOpenMenu={fetchSpanNameOptions}\n              isClearable\n              onKeyDown={onKeyDown}\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField label=\"Tags\" labelWidth={14} grow tooltip=\"Values should be in the logfmt format.\">\n            <QueryField\n              additionalPlugins={plugins}\n              query={query.search}\n              onTypeahead={onTypeahead}\n              onBlur={onBlur}\n              onChange={(value) => {\n                onChange({\n                  ...query,\n                  search: value,\n                });\n              }}\n              placeholder=\"http.status_code=200 error=true\"\n              cleanText={cleanText}\n              onRunQuery={onRunQuery}\n              syntaxLoaded={hasSyntaxLoaded}\n              portalOrigin=\"tempo\"\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField label=\"Min Duration\" invalid={!!inputErrors.minDuration} labelWidth={14} grow>\n            <Input\n              id=\"minDuration\"\n              value={query.minDuration || ''}\n              placeholder={durationPlaceholder}\n              onBlur={() => {\n                if (query.minDuration && !isValidGoDuration(query.minDuration)) {\n                  setInputErrors({ ...inputErrors, minDuration: true });\n                } else {\n                  setInputErrors({ ...inputErrors, minDuration: false });\n                }\n              }}\n              onChange={(v) =>\n                onChange({\n                  ...query,\n                  minDuration: v.currentTarget.value,\n                })\n              }\n              onKeyDown={onKeyDown}\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField label=\"Max Duration\" invalid={!!inputErrors.maxDuration} labelWidth={14} grow>\n            <Input\n              id=\"maxDuration\"\n              value={query.maxDuration || ''}\n              placeholder={durationPlaceholder}\n              onBlur={() => {\n                if (query.maxDuration && !isValidGoDuration(query.maxDuration)) {\n                  setInputErrors({ ...inputErrors, maxDuration: true });\n                } else {\n                  setInputErrors({ ...inputErrors, maxDuration: false });\n                }\n              }}\n              onChange={(v) =>\n                onChange({\n                  ...query,\n                  maxDuration: v.currentTarget.value,\n                })\n              }\n              onKeyDown={onKeyDown}\n            />\n          </InlineField>\n        </InlineFieldRow>\n        <InlineFieldRow>\n          <InlineField\n            label=\"Limit\"\n            invalid={!!inputErrors.limit}\n            labelWidth={14}\n            grow\n            tooltip=\"Maximum numbers of returned results\"\n          >\n            <Input\n              id=\"limit\"\n              value={query.limit || ''}\n              type=\"number\"\n              onChange={(v) => {\n                let limit = v.currentTarget.value ? parseInt(v.currentTarget.value, 10) : undefined;\n                if (limit && (!Number.isInteger(limit) || limit <= 0)) {\n                  setInputErrors({ ...inputErrors, limit: true });\n                } else {\n                  setInputErrors({ ...inputErrors, limit: false });\n                }\n\n                onChange({\n                  ...query,\n                  limit: v.currentTarget.value ? parseInt(v.currentTarget.value, 10) : undefined,\n                });\n              }}\n              onKeyDown={onKeyDown}\n            />\n          </InlineField>\n        </InlineFieldRow>\n      </div>\n      {error ? (\n        <Alert title=\"Unable to connect to Tempo search\" severity=\"info\" className={styles.alert}>\n          Please ensure that Tempo is configured with search enabled. If you would like to hide this tab, you can\n          configure it in the <a href={`/datasources/edit/${datasource.uid}`}>datasource settings</a>.\n        </Alert>\n      ) : null}\n    </>\n  );\n};\n\nexport default NativeSearch;\n\nconst getStyles = (theme: GrafanaTheme2) => ({\n  container: css`\n    max-width: 500px;\n  `,\n  alert: css`\n    max-width: 75ch;\n    margin-top: ${theme.spacing(2)};\n  `,\n});\n","import { Grammar } from 'prismjs';\n\nexport const tokenizer: Grammar = {\n  key: {\n    pattern: /[^\\s]+(?==)/,\n    alias: 'attr-name',\n  },\n  operator: /[=]/,\n  value: [\n    {\n      pattern: /\"(.+)\"/,\n    },\n    {\n      pattern: /[^\\s]+/,\n    },\n  ],\n};\n","import { DataSourceApi } from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\n\nexport async function getDS(uid?: string): Promise<DataSourceApi | undefined> {\n  if (!uid) {\n    return undefined;\n  }\n\n  const dsSrv = getDataSourceSrv();\n  try {\n    return await dsSrv.get(uid);\n  } catch (error) {\n    console.error('Failed to load data source', error);\n    return undefined;\n  }\n}\n","import React from 'react';\nimport useAsync from 'react-use/lib/useAsync';\nimport { getDS } from './utils';\nimport { InlineField, InlineFieldRow } from '@grafana/ui';\nimport { AdHocVariableFilter } from '../../../../features/variables/types';\nimport { TempoQuery } from '../datasource';\nimport { AdHocFilter } from '../../../../features/variables/adhoc/picker/AdHocFilter';\nimport { PrometheusDatasource } from '../../prometheus/datasource';\n\nexport function ServiceGraphSection({\n  graphDatasourceUid,\n  query,\n  onChange,\n}: {\n  graphDatasourceUid?: string;\n  query: TempoQuery;\n  onChange: (value: TempoQuery) => void;\n}) {\n  const dsState = useAsync(() => getDS(graphDatasourceUid), [graphDatasourceUid]);\n  if (dsState.loading) {\n    return null;\n  }\n\n  const ds = dsState.value as PrometheusDatasource;\n\n  if (!graphDatasourceUid) {\n    return <div className=\"text-warning\">Please set up a service graph datasource in the datasource settings.</div>;\n  }\n\n  if (graphDatasourceUid && !ds) {\n    return (\n      <div className=\"text-warning\">\n        Service graph datasource is configured but the data source no longer exists. Please configure existing data\n        source to use the service graph functionality.\n      </div>\n    );\n  }\n  const filters = queryToFilter(query.serviceMapQuery || '');\n\n  return (\n    <div>\n      <InlineFieldRow>\n        <InlineField label=\"Filter\" labelWidth={14} grow>\n          <AdHocFilter\n            datasource={{ uid: graphDatasourceUid }}\n            filters={filters}\n            getTagKeysOptions={{\n              series: [\n                'traces_service_graph_request_server_seconds_sum',\n                'traces_service_graph_request_total',\n                'traces_service_graph_request_failed_total',\n              ],\n            }}\n            addFilter={(filter: AdHocVariableFilter) => {\n              onChange({\n                ...query,\n                serviceMapQuery: filtersToQuery([...filters, filter]),\n              });\n            }}\n            removeFilter={(index: number) => {\n              const newFilters = [...filters];\n              newFilters.splice(index, 1);\n              onChange({ ...query, serviceMapQuery: filtersToQuery(newFilters) });\n            }}\n            changeFilter={(index: number, filter: AdHocVariableFilter) => {\n              const newFilters = [...filters];\n              newFilters.splice(index, 1, filter);\n              onChange({ ...query, serviceMapQuery: filtersToQuery(newFilters) });\n            }}\n          />\n        </InlineField>\n      </InlineFieldRow>\n    </div>\n  );\n}\n\nfunction queryToFilter(query: string): AdHocVariableFilter[] {\n  let match;\n  let filters: AdHocVariableFilter[] = [];\n  const re = /([\\w_]+)(=|!=|<|>|=~|!~)\"(.*?)\"/g;\n  while ((match = re.exec(query)) !== null) {\n    filters.push({\n      key: match[1],\n      operator: match[2],\n      value: match[3],\n      condition: '',\n    });\n  }\n  return filters;\n}\n\nfunction filtersToQuery(filters: AdHocVariableFilter[]): string {\n  return `{${filters.map((f) => `${f.key}${f.operator}\"${f.value}\"`).join(',')}}`;\n}\n","import { css } from '@emotion/css';\nimport { QueryEditorProps, SelectableValue } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport {\n  Badge,\n  FileDropzone,\n  InlineField,\n  InlineFieldRow,\n  InlineLabel,\n  QueryField,\n  RadioButtonGroup,\n  Themeable2,\n  withTheme2,\n} from '@grafana/ui';\nimport { TraceToLogsOptions } from 'app/core/components/TraceToLogsSettings';\nimport React from 'react';\nimport { LokiQueryField } from '../../loki/components/LokiQueryField';\nimport { LokiQuery } from '../../loki/types';\nimport { TempoDatasource, TempoQuery, TempoQueryType } from '../datasource';\nimport LokiDatasource from '../../loki/datasource';\nimport { PrometheusDatasource } from '../../prometheus/datasource';\nimport useAsync from 'react-use/lib/useAsync';\nimport NativeSearch from './NativeSearch';\nimport { getDS } from './utils';\nimport { ServiceGraphSection } from './ServiceGraphSection';\n\ninterface Props extends QueryEditorProps<TempoDatasource, TempoQuery>, Themeable2 {}\n\nconst DEFAULT_QUERY_TYPE: TempoQueryType = 'traceId';\n\ninterface State {\n  linkedDatasourceUid?: string;\n  linkedDatasource?: LokiDatasource;\n  serviceMapDatasourceUid?: string;\n  serviceMapDatasource?: PrometheusDatasource;\n}\n\nclass TempoQueryFieldComponent extends React.PureComponent<Props, State> {\n  state = {\n    linkedDatasourceUid: undefined,\n    linkedDatasource: undefined,\n    serviceMapDatasourceUid: undefined,\n    serviceMapDatasource: undefined,\n  };\n\n  constructor(props: Props) {\n    super(props);\n  }\n\n  async componentDidMount() {\n    const { datasource } = this.props;\n    // Find query field from linked datasource\n    const tracesToLogsOptions: TraceToLogsOptions = datasource.tracesToLogs || {};\n    const linkedDatasourceUid = tracesToLogsOptions.datasourceUid;\n\n    const serviceMapDsUid = datasource.serviceMap?.datasourceUid;\n\n    // Check status of linked data sources so we can show warnings if needed.\n    const [logsDs, serviceMapDs] = await Promise.all([getDS(linkedDatasourceUid), getDS(serviceMapDsUid)]);\n\n    this.setState({\n      linkedDatasourceUid: linkedDatasourceUid,\n      linkedDatasource: logsDs as LokiDatasource,\n      serviceMapDatasourceUid: serviceMapDsUid,\n      serviceMapDatasource: serviceMapDs as PrometheusDatasource,\n    });\n\n    // Set initial query type to ensure traceID field appears\n    if (!this.props.query.queryType) {\n      this.props.onChange({\n        ...this.props.query,\n        queryType: DEFAULT_QUERY_TYPE,\n      });\n    }\n  }\n\n  onChangeLinkedQuery = (value: LokiQuery) => {\n    const { query, onChange } = this.props;\n    onChange({\n      ...query,\n      linkedQuery: { ...value, refId: 'linked' },\n    });\n  };\n\n  onRunLinkedQuery = () => {\n    this.props.onRunQuery();\n  };\n\n  onClearResults = () => {\n    // Run clear query to clear results\n    const { onChange, query, onRunQuery } = this.props;\n    onChange({\n      ...query,\n      queryType: 'clear',\n    });\n    onRunQuery();\n  };\n\n  render() {\n    const { query, onChange, datasource } = this.props;\n    // Find query field from linked datasource\n    const tracesToLogsOptions: TraceToLogsOptions = datasource.tracesToLogs || {};\n    const logsDatasourceUid = tracesToLogsOptions.datasourceUid;\n    const graphDatasourceUid = datasource.serviceMap?.datasourceUid;\n\n    const queryTypeOptions: Array<SelectableValue<TempoQueryType>> = [\n      { value: 'traceId', label: 'TraceID' },\n      { value: 'upload', label: 'JSON file' },\n    ];\n\n    if (config.featureToggles.tempoServiceGraph) {\n      queryTypeOptions.push({ value: 'serviceMap', label: 'Service Graph' });\n    }\n\n    if (config.featureToggles.tempoSearch && !datasource?.search?.hide) {\n      queryTypeOptions.unshift({ value: 'nativeSearch', label: 'Search - Beta' });\n    }\n\n    if (logsDatasourceUid && tracesToLogsOptions?.lokiSearch !== false) {\n      if (!config.featureToggles.tempoSearch) {\n        // Place at beginning as Search if no native search\n        queryTypeOptions.unshift({ value: 'search', label: 'Search' });\n      } else {\n        // Place at end as Loki Search if native search is enabled\n        queryTypeOptions.push({ value: 'search', label: 'Loki Search' });\n      }\n    }\n\n    return (\n      <>\n        <InlineFieldRow>\n          <InlineField label=\"Query type\">\n            <RadioButtonGroup<TempoQueryType>\n              options={queryTypeOptions}\n              value={query.queryType}\n              onChange={(v) => {\n                this.onClearResults();\n\n                onChange({\n                  ...query,\n                  queryType: v,\n                });\n              }}\n              size=\"md\"\n            />\n          </InlineField>\n        </InlineFieldRow>\n        {query.queryType === 'nativeSearch' && (\n          <p style={{ maxWidth: '65ch' }}>\n            <Badge icon=\"rocket\" text=\"Beta\" color=\"blue\" />\n            {config.featureToggles.tempoBackendSearch ? (\n              <>&nbsp;Tempo search is currently in beta.</>\n            ) : (\n              <>\n                &nbsp;Tempo search is currently in beta and is designed to return recent traces only. It ignores the\n                time range picker. We are actively working on full backend search. Look for improvements in the near\n                future!\n              </>\n            )}\n          </p>\n        )}\n        {query.queryType === 'search' && (\n          <SearchSection\n            linkedDatasourceUid={logsDatasourceUid}\n            query={query}\n            onRunQuery={this.onRunLinkedQuery}\n            onChange={this.onChangeLinkedQuery}\n          />\n        )}\n        {query.queryType === 'nativeSearch' && (\n          <NativeSearch\n            datasource={this.props.datasource}\n            query={query}\n            onChange={onChange}\n            onBlur={this.props.onBlur}\n            onRunQuery={this.props.onRunQuery}\n          />\n        )}\n        {query.queryType === 'upload' && (\n          <div className={css({ padding: this.props.theme.spacing(2) })}>\n            <FileDropzone\n              options={{ multiple: false }}\n              onLoad={(result) => {\n                this.props.datasource.uploadedJson = result;\n                this.props.onRunQuery();\n              }}\n            />\n          </div>\n        )}\n        {query.queryType === 'traceId' && (\n          <InlineFieldRow>\n            <InlineField label=\"Trace ID\" labelWidth={14} grow>\n              <QueryField\n                query={query.query}\n                onChange={(val) => {\n                  onChange({\n                    ...query,\n                    query: val,\n                    queryType: 'traceId',\n                    linkedQuery: undefined,\n                  });\n                }}\n                onBlur={this.props.onBlur}\n                onRunQuery={this.props.onRunQuery}\n                placeholder={'Enter a Trace ID (run with Shift+Enter)'}\n                portalOrigin=\"tempo\"\n              />\n            </InlineField>\n          </InlineFieldRow>\n        )}\n        {query.queryType === 'serviceMap' && (\n          <ServiceGraphSection graphDatasourceUid={graphDatasourceUid} query={query} onChange={onChange} />\n        )}\n      </>\n    );\n  }\n}\n\ninterface SearchSectionProps {\n  linkedDatasourceUid?: string;\n  onChange: (value: LokiQuery) => void;\n  onRunQuery: () => void;\n  query: TempoQuery;\n}\nfunction SearchSection({ linkedDatasourceUid, onChange, onRunQuery, query }: SearchSectionProps) {\n  const dsState = useAsync(() => getDS(linkedDatasourceUid), [linkedDatasourceUid]);\n  if (dsState.loading) {\n    return null;\n  }\n\n  const ds = dsState.value as LokiDatasource;\n\n  if (ds) {\n    return (\n      <>\n        <InlineLabel>Tempo uses {ds.name} to find traces.</InlineLabel>\n\n        <LokiQueryField\n          datasource={ds}\n          onChange={onChange}\n          onRunQuery={onRunQuery}\n          query={query.linkedQuery ?? ({ refId: 'linked' } as any)}\n          history={[]}\n        />\n      </>\n    );\n  }\n\n  if (!linkedDatasourceUid) {\n    return <div className=\"text-warning\">Please set up a Traces-to-logs datasource in the datasource settings.</div>;\n  }\n\n  if (linkedDatasourceUid && !ds) {\n    return (\n      <div className=\"text-warning\">\n        Traces-to-logs datasource is configured but the data source no longer exists. Please configure existing data\n        source to use the search.\n      </div>\n    );\n  }\n\n  return null;\n}\n\nexport const TempoQueryField = withTheme2(TempoQueryFieldComponent);\n","import { DataSourcePlugin } from '@grafana/data';\nimport CheatSheet from './CheatSheet';\nimport { ConfigEditor } from './configuration/ConfigEditor';\nimport { TempoDatasource } from './datasource';\nimport { TempoQueryField } from './QueryEditor/QueryField';\n\nexport const plugin = new DataSourcePlugin(TempoDatasource)\n  .setQueryEditor(TempoQueryField)\n  .setConfigEditor(ConfigEditor)\n  .setQueryEditorHelp(CheatSheet);\n","import { DataSourcePluginOptionsEditorProps } from '@grafana/data';\nimport { DataSourceHttpSettings } from '@grafana/ui';\nimport { TraceToLogsSettings } from 'app/core/components/TraceToLogsSettings';\nimport React from 'react';\nimport { ServiceGraphSettings } from './ServiceGraphSettings';\nimport { config } from '@grafana/runtime';\nimport { SearchSettings } from './SearchSettings';\nimport { NodeGraphSettings } from 'app/core/components/NodeGraphSettings';\n\nexport type Props = DataSourcePluginOptionsEditorProps;\n\nexport const ConfigEditor: React.FC<Props> = ({ options, onOptionsChange }) => {\n  return (\n    <>\n      <DataSourceHttpSettings\n        defaultUrl=\"http://tempo\"\n        dataSourceConfig={options}\n        showAccessOptions={false}\n        onChange={onOptionsChange}\n      />\n\n      <div className=\"gf-form-group\">\n        <TraceToLogsSettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n      {config.featureToggles.tempoServiceGraph && (\n        <div className=\"gf-form-group\">\n          <ServiceGraphSettings options={options} onOptionsChange={onOptionsChange} />\n        </div>\n      )}\n      {config.featureToggles.tempoSearch && (\n        <div className=\"gf-form-group\">\n          <SearchSettings options={options} onOptionsChange={onOptionsChange} />\n        </div>\n      )}\n      <div className=\"gf-form-group\">\n        <NodeGraphSettings options={options} onOptionsChange={onOptionsChange} />\n      </div>\n    </>\n  );\n};\n","import React from 'react';\n\nexport default function CheatSheet() {\n  return (\n    <div>\n      <h2 id=\"tempo-cheat-sheet\">Tempo Cheat Sheet</h2>\n      <p>\n        Tempo is a trace id lookup store. Enter a trace id in the above field and hit Run Query to retrieve your\n        trace. Tempo is generally paired with other datasources such as Loki or Prometheus to find traces.\n      </p>\n      <p>\n        Here are some{' '}\n        <a href=\"https://grafana.com/docs/tempo/latest/guides/instrumentation/\" target=\"blank\">\n          instrumentation examples\n        </a>{' '}\n        to get you started with trace discovery through logs and metrics (exemplars).\n      </p>\n    </div>\n  );\n}\n"],"names":["NodeGraphSettings","options","onOptionsChange","styles","useStyles","getStyles","className","container","InlineFieldRow","row","InlineField","tooltip","label","labelWidth","InlineSwitch","id","value","jsonData","nodeGraph","enabled","onChange","event","updateDatasourcePluginJsonDataOption","currentTarget","checked","theme","css","TraceToLogsSettings","width","infoText","DataSourcePicker","inputId","pluginId","current","tracesToLogs","datasourceUid","noDefault","ds","uid","tags","TagsInput","grow","Input","type","placeholder","v","spanStartTimeShift","spanEndTimeShift","filterByTraceID","filterBySpanID","defaultChecked","lokiSearch","spacing","md","colors","textSemiWeak","getNonOverlappingDuration","ranges","sort","a","b","reduce","acc","range","length","tail","slice","prevStart","prevEnd","start","end","makeSpanMap","getSpan","spanMap","span","index","children","parentId","parentIds","push","undefined","getStats","duration","traceDuration","selfDuration","main","toFixedNoTrailingZeros","secondary","n","parseFloat","toFixed","makeFrames","MutableDataFrame","fields","name","Fields","FieldType","config","displayName","color","mode","meta","preferredVisualisationType","ServiceGraphSettings","serviceMap","Button","variant","size","fill","onClick","SearchSettings","search","hide","TempoDatasource","DataSourceWithBackend","constructor","instanceSettings","super","this","query","subQueries","filteredTargets","targets","filter","target","groupBy","t","queryType","clear","of","data","state","LoadingState","dsSrv","getDatasourceSrv","from","get","pipe","mergeMap","linkedDatasource","linkedRequest","map","linkedQuery","traceLinkMatcher","derivedFields","field","matcherRegex","response","error","transformTraceList","throwError","Error","nativeSearch","timeRange","startTime","unix","endTime","to","searchQuery","buildSearchQuery","_request","createTableFrameFromSearch","traces","catchError","message","upload","uploadedJson","otelTraceData","JSON","parse","batches","transformFromOTEL","request","queryServiceMapPrometheus","serviceMapMetrics","metric","refId","expr","serviceMapQuery","instant","makePromServiceMapRequest","toArray","responses","errorRes","find","res","nodes","edges","mapPromMetricsToServiceMap","links","makePromLink","totalsMetric","histogramMetric","failedMetric","traceId","handleTraceIdQuery","merge","validTargets","EMPTY","traceRequest","transformTrace","url","params","method","hideFromInspector","toPromise","apiUrl","serializeParams","req","getBackendSrv","fetch","headers","ok","status","getQueryDisplayText","result","key","hasOwnProperty","startCase","join","tempoQuery","pick","pickBy","identity","serviceName","spanName","limit","minDuration","isValidGoDuration","replace","maxDuration","Number","isInteger","getTagKeys","getTagValues","title","internal","datasourceName","TempoLanguageProvider","LanguageProvider","datasource","initialValues","async","metadataRequest","fetchTags","prefix","text","labelKey","wrapperClasses","emptyResult","suggestions","endText","getText","isValue","indexOf","getTagValueCompletionItems","getTagsCompletionItems","items","tag","Object","assign","tagNames","split","tagName","tagValues","tagValue","PRISM_LANGUAGE","durationPlaceholder","plugins","BracesPlugin","SlatePrism","onlyIn","node","object","getSyntax","Prism","pattern","alias","operator","onBlur","onRunQuery","useStyles2","languageProvider","useMemo","hasSyntaxLoaded","setHasSyntaxLoaded","useState","autocomplete","setAutocomplete","serviceNameOptions","spanNameOptions","setError","inputErrors","setInputErrors","fetchServiceNameOptions","debounce","getOptions","prev","leading","trailing","fetchSpanNameOptions","useEffect","dispatch","notifyApp","createErrorNotification","fetchAutocomplete","onKeyDown","keyEvent","shiftKey","ctrlKey","Select","menuShouldPortal","onOpenMenu","isClearable","QueryField","additionalPlugins","onTypeahead","provideCompletionItems","typeahead","cleanText","splittedText","syntaxLoaded","portalOrigin","invalid","parseInt","Alert","severity","alert","href","getDS","getDataSourceSrv","console","ServiceGraphSection","graphDatasourceUid","dsState","useAsync","loading","filters","match","re","exec","condition","queryToFilter","AdHocFilter","getTagKeysOptions","series","addFilter","filtersToQuery","removeFilter","newFilters","splice","changeFilter","f","TempoQueryFieldComponent","React","props","linkedDatasourceUid","serviceMapDatasourceUid","serviceMapDatasource","serviceMapDsUid","logsDs","serviceMapDs","Promise","all","setState","render","tracesToLogsOptions","logsDatasourceUid","queryTypeOptions","unshift","RadioButtonGroup","onClearResults","style","maxWidth","Badge","icon","SearchSection","onRunLinkedQuery","onChangeLinkedQuery","padding","FileDropzone","multiple","onLoad","val","InlineLabel","LokiQueryField","history","TempoQueryField","withTheme2","plugin","DataSourcePlugin","setQueryEditor","setConfigEditor","DataSourceHttpSettings","defaultUrl","dataSourceConfig","showAccessOptions","setQueryEditorHelp"],"sourceRoot":""}