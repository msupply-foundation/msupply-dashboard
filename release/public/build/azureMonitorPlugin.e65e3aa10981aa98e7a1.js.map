{"version":3,"file":"azureMonitorPlugin.e65e3aa10981aa98e7a1.js","mappings":"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OAAOC,GCzKI,MAAMoC,EA+PnBC,YAAoBpD,G,YA9Pa,CAC/BqD,aAAc,CACZ,qCACA,kCACA,iDACA,0CACA,gCACA,wBACA,kDACA,yBACA,2CACA,mDACA,uCACA,oCACA,4CACA,8CACA,yCACA,6CACA,kCACA,2CACA,sCACA,kCACA,uCACA,mCACA,iCACA,+BACA,uCACA,oCACA,4CACA,4BACA,yCACA,wCACA,6BACA,yCACA,sCACA,gCACA,8BACA,+BACA,uCACA,gCACA,4BACA,2BACA,2CACA,4BACA,iDACA,gDACA,wDACA,sCACA,kCACA,6BACA,sCACA,mCACA,wCACA,2CACA,yCACA,kDACA,gCACA,2CACA,uDACA,+BACA,gCACA,gCACA,2CACA,yDACA,2CACA,wCACA,6BACA,kCACA,kCACA,mCACA,kCACA,qCACA,iCACA,oCACA,iDACA,iDACA,kDACA,kDACA,4CACA,uDACA,uEACA,8DACA,0CACA,4BACA,sBACA,4BACA,mDACA,iDAEFC,gBAAiB,CACf,qCACA,kCACA,gCACA,wBACA,kDACA,yBACA,2CACA,mDACA,uCACA,oCACA,4CACA,yCACA,+BACA,oCACA,4BACA,yCACA,6BACA,yCACA,sCACA,gCACA,8BACA,uCACA,gCACA,4BACA,4BACA,sCACA,kCACA,6BACA,sCACA,mCACA,wCACA,2CACA,yCACA,kDACA,gCACA,2CACA,uDACA,+BACA,yDACA,2CACA,wCACA,6BACA,kCACA,kCACA,qCACA,iCACA,oCACA,iDACA,iDACA,kDACA,kDACA,4BACA,sBACA,4BACA,mDACA,iDAEFC,oBAAqB,CACnB,qCACA,gCACA,wBACA,kDACA,yBACA,2CACA,mDACA,oCACA,4CACA,+BACA,oCACA,4BACA,yCACA,gCACA,8BACA,uCACA,gCACA,4BACA,sCACA,kCACA,6BACA,sCACA,mCACA,wCACA,2CACA,yCACA,kDACA,gCACA,2CACA,uDACA,+BACA,yDACA,2CACA,wCACA,6BACA,kCACA,kCACA,qCACA,iCACA,oCACA,iDACA,iDACA,kDACA,kD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","sources":["webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/credentials.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/azure_monitor/response_parser.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/azure_monitor/supported_namespaces.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/azure_monitor/url_builder.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/azure_monitor/azure_monitor_datasource.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/app_insights/response_parser.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/app_insights/app_insights_datasource.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/log_analytics/querystring_builder.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/azure_log_analytics/response_parser.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/azure_log_analytics/azure_log_analytics_datasource.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/insights_analytics/insights_analytics_datasource.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/azure_resource_graph/azure_resource_graph_datasource.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/utils/migrateAnnotation.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/grafanaTemplateVariableFns.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/VariableEditor/VariableEditor.tsx","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/variables.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/datasource.ts","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/AzureCredentialsForm.tsx","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/MonitorConfig.tsx","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/AnalyticsConfig.tsx","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/InsightsConfig.tsx","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/components/ConfigEditor.tsx","webpack://grafana/./public/app/plugins/datasource/grafana-azure-monitor-datasource/module.ts"],"sourcesContent":["import { config } from '@grafana/runtime';\nimport {\n  AzureAuthType,\n  AzureCloud,\n  AzureCredentials,\n  AzureDataSourceInstanceSettings,\n  AzureDataSourceSettings,\n  ConcealedSecret,\n} from './types';\n\nconst concealed: ConcealedSecret = Symbol('Concealed client secret');\n\nexport function getAuthType(options: AzureDataSourceSettings | AzureDataSourceInstanceSettings): AzureAuthType {\n  if (!options.jsonData.azureAuthType) {\n    // If authentication type isn't explicitly specified and datasource has client credentials,\n    // then this is existing datasource which is configured for app registration (client secret)\n    if (options.jsonData.tenantId && options.jsonData.clientId) {\n      return 'clientsecret';\n    }\n\n    // For newly created datasource with no configuration, managed identity is the default authentication type\n    // if they are enabled in Grafana config\n    return config.azure.managedIdentityEnabled ? 'msi' : 'clientsecret';\n  }\n\n  return options.jsonData.azureAuthType;\n}\n\nfunction getDefaultAzureCloud(): string {\n  switch (config.azure.cloud) {\n    case AzureCloud.Public:\n    case AzureCloud.None:\n    case undefined:\n      return 'azuremonitor';\n    case AzureCloud.China:\n      return 'chinaazuremonitor';\n    case AzureCloud.USGovernment:\n      return 'govazuremonitor';\n    case AzureCloud.Germany:\n      return 'germanyazuremonitor';\n    default:\n      throw new Error(`The cloud '${config.azure.cloud}' not supported.`);\n  }\n}\n\nexport function getAzurePortalUrl(azureCloud: string): string {\n  switch (azureCloud) {\n    case 'azuremonitor':\n      return 'https://portal.azure.com';\n    case 'chinaazuremonitor':\n      return 'https://portal.azure.cn';\n    case 'govazuremonitor':\n      return 'https://portal.azure.us';\n    case 'germanyazuremonitor':\n      return 'https://portal.microsoftazure.de';\n    default:\n      throw new Error('The cloud not supported.');\n  }\n}\n\nexport function getAzureCloud(options: AzureDataSourceSettings | AzureDataSourceInstanceSettings): string {\n  const authType = getAuthType(options);\n  switch (authType) {\n    case 'msi':\n      // In case of managed identity, the cloud is always same as where Grafana is hosted\n      return getDefaultAzureCloud();\n    case 'clientsecret':\n      return options.jsonData.cloudName || getDefaultAzureCloud();\n  }\n}\n\nfunction getSecret(options: AzureDataSourceSettings): undefined | string | ConcealedSecret {\n  if (options.secureJsonFields.clientSecret) {\n    // The secret is concealed on server\n    return concealed;\n  } else {\n    const secret = options.secureJsonData?.clientSecret;\n    return typeof secret === 'string' && secret.length > 0 ? secret : undefined;\n  }\n}\n\nexport function isCredentialsComplete(credentials: AzureCredentials): boolean {\n  switch (credentials.authType) {\n    case 'msi':\n      return true;\n    case 'clientsecret':\n      return !!(credentials.azureCloud && credentials.tenantId && credentials.clientId && credentials.clientSecret);\n  }\n}\n\nexport function getCredentials(options: AzureDataSourceSettings): AzureCredentials {\n  const authType = getAuthType(options);\n  switch (authType) {\n    case 'msi':\n      if (config.azure.managedIdentityEnabled) {\n        return {\n          authType: 'msi',\n          defaultSubscriptionId: options.jsonData.subscriptionId,\n        };\n      } else {\n        // If authentication type is managed identity but managed identities were disabled in Grafana config,\n        // then we should fallback to an empty app registration (client secret) configuration\n        return {\n          authType: 'clientsecret',\n          azureCloud: getDefaultAzureCloud(),\n        };\n      }\n    case 'clientsecret':\n      return {\n        authType: 'clientsecret',\n        azureCloud: options.jsonData.cloudName || getDefaultAzureCloud(),\n        tenantId: options.jsonData.tenantId,\n        clientId: options.jsonData.clientId,\n        clientSecret: getSecret(options),\n        defaultSubscriptionId: options.jsonData.subscriptionId,\n      };\n  }\n}\n\nexport function updateCredentials(\n  options: AzureDataSourceSettings,\n  credentials: AzureCredentials\n): AzureDataSourceSettings {\n  switch (credentials.authType) {\n    case 'msi':\n      if (!config.azure.managedIdentityEnabled) {\n        throw new Error('Managed Identity authentication is not enabled in Grafana config.');\n      }\n\n      options = {\n        ...options,\n        jsonData: {\n          ...options.jsonData,\n          azureAuthType: 'msi',\n          subscriptionId: credentials.defaultSubscriptionId,\n        },\n      };\n\n      return options;\n\n    case 'clientsecret':\n      options = {\n        ...options,\n        jsonData: {\n          ...options.jsonData,\n          azureAuthType: 'clientsecret',\n          cloudName: credentials.azureCloud || getDefaultAzureCloud(),\n          tenantId: credentials.tenantId,\n          clientId: credentials.clientId,\n          subscriptionId: credentials.defaultSubscriptionId,\n        },\n        secureJsonData: {\n          ...options.secureJsonData,\n          clientSecret:\n            typeof credentials.clientSecret === 'string' && credentials.clientSecret.length > 0\n              ? credentials.clientSecret\n              : undefined,\n        },\n        secureJsonFields: {\n          ...options.secureJsonFields,\n          clientSecret: typeof credentials.clientSecret === 'symbol',\n        },\n      };\n\n      return options;\n  }\n}\n\nexport function isAppInsightsConfigured(options: AzureDataSourceSettings) {\n  return !!(options.jsonData.appInsightsAppId && options.secureJsonFields.appInsightsApiKey);\n}\n","import { find, get } from 'lodash';\nimport TimeGrainConverter from '../time_grain_converter';\nimport {\n  AzureMonitorLocalizedValue,\n  AzureMonitorMetricAvailabilityMetadata,\n  AzureMonitorMetricsMetadataResponse,\n  AzureMonitorOption,\n} from '../types';\nexport default class ResponseParser {\n  static parseResponseValues(\n    result: any,\n    textFieldName: string,\n    valueFieldName: string\n  ): Array<{ text: string; value: string }> {\n    const list: Array<{ text: string; value: string }> = [];\n\n    if (!result) {\n      return list;\n    }\n\n    for (let i = 0; i < result.value.length; i++) {\n      if (!find(list, ['value', get(result.value[i], valueFieldName)])) {\n        const value = get(result.value[i], valueFieldName);\n        const text = get(result.value[i], textFieldName, value);\n\n        list.push({\n          text: text,\n          value: value,\n        });\n      }\n    }\n    return list;\n  }\n\n  static parseResourceNames(result: any, metricDefinition: string): Array<{ text: string; value: string }> {\n    const list: Array<{ text: string; value: string }> = [];\n\n    if (!result) {\n      return list;\n    }\n\n    for (let i = 0; i < result.value.length; i++) {\n      if (\n        typeof result.value[i].type === 'string' &&\n        result.value[i].type.toLocaleLowerCase() === metricDefinition.toLocaleLowerCase()\n      ) {\n        list.push({\n          text: result.value[i].name,\n          value: result.value[i].name,\n        });\n      }\n    }\n\n    return list;\n  }\n\n  static parseMetadata(result: AzureMonitorMetricsMetadataResponse, metricName: string) {\n    const defaultAggTypes = ['None', 'Average', 'Minimum', 'Maximum', 'Total', 'Count'];\n    const metricData = result?.value.find((v) => v.name.value === metricName);\n\n    if (!metricData) {\n      return {\n        primaryAggType: '',\n        supportedAggTypes: defaultAggTypes,\n        supportedTimeGrains: [],\n        dimensions: [],\n      };\n    }\n\n    return {\n      primaryAggType: metricData.primaryAggregationType,\n      supportedAggTypes: metricData.supportedAggregationTypes || defaultAggTypes,\n\n      supportedTimeGrains: [\n        { label: 'Auto', value: 'auto' },\n        ...ResponseParser.parseTimeGrains(metricData.metricAvailabilities ?? []),\n      ],\n      dimensions: ResponseParser.parseDimensions(metricData.dimensions ?? []),\n    };\n  }\n\n  static parseTimeGrains(metricAvailabilities: AzureMonitorMetricAvailabilityMetadata[]): AzureMonitorOption[] {\n    const timeGrains: AzureMonitorOption[] = [];\n\n    if (!metricAvailabilities) {\n      return timeGrains;\n    }\n\n    metricAvailabilities.forEach((avail) => {\n      if (avail.timeGrain) {\n        timeGrains.push({\n          label: TimeGrainConverter.createTimeGrainFromISO8601Duration(avail.timeGrain),\n          value: avail.timeGrain,\n        });\n      }\n    });\n\n    return timeGrains;\n  }\n\n  static parseDimensions(metadataDimensions: AzureMonitorLocalizedValue[]) {\n    return metadataDimensions.map((dimension) => {\n      return {\n        label: dimension.localizedValue || dimension.value,\n        value: dimension.value,\n      };\n    });\n  }\n\n  static parseSubscriptions(result: any): Array<{ text: string; value: string }> {\n    const list: Array<{ text: string; value: string }> = [];\n\n    if (!result) {\n      return list;\n    }\n\n    const valueFieldName = 'subscriptionId';\n    const textFieldName = 'displayName';\n    for (let i = 0; i < result.value.length; i++) {\n      if (!find(list, ['value', get(result.value[i], valueFieldName)])) {\n        list.push({\n          text: `${get(result.value[i], textFieldName)}`,\n          value: get(result.value[i], valueFieldName),\n        });\n      }\n    }\n\n    return list;\n  }\n\n  static parseSubscriptionsForSelect(result: any): Array<{ label: string; value: string }> {\n    const list: Array<{ label: string; value: string }> = [];\n\n    if (!result) {\n      return list;\n    }\n\n    const valueFieldName = 'subscriptionId';\n    const textFieldName = 'displayName';\n    for (let i = 0; i < result.data.value.length; i++) {\n      if (!find(list, ['value', get(result.data.value[i], valueFieldName)])) {\n        list.push({\n          label: `${get(result.data.value[i], textFieldName)} - ${get(result.data.value[i], valueFieldName)}`,\n          value: get(result.data.value[i], valueFieldName),\n        });\n      }\n    }\n\n    return list;\n  }\n\n  static parseWorkspacesForSelect(result: any): Array<{ label: string; value: string }> {\n    const list: Array<{ label: string; value: string }> = [];\n\n    if (!result) {\n      return list;\n    }\n\n    const valueFieldName = 'customerId';\n    const textFieldName = 'name';\n    for (let i = 0; i < result.data.value.length; i++) {\n      if (!find(list, ['value', get(result.data.value[i].properties, valueFieldName)])) {\n        list.push({\n          label: get(result.data.value[i], textFieldName),\n          value: get(result.data.value[i].properties, valueFieldName),\n        });\n      }\n    }\n\n    return list;\n  }\n}\n","export default class SupportedNamespaces {\n  supportedMetricNamespaces: any = {\n    azuremonitor: [\n      'Microsoft.AnalysisServices/servers',\n      'Microsoft.ApiManagement/service',\n      'Microsoft.AppConfiguration/configurationStores',\n      'Microsoft.Automation/automationAccounts',\n      'Microsoft.Batch/batchAccounts',\n      'Microsoft.Cache/redis',\n      'Microsoft.Cdn/cdnwebapplicationfirewallpolicies',\n      'Microsoft.Cdn/profiles',\n      'Microsoft.ClassicCompute/virtualMachines',\n      'Microsoft.ClassicCompute/domainNames/slots/roles',\n      'Microsoft.CognitiveServices/accounts',\n      'Microsoft.Compute/virtualMachines',\n      'Microsoft.Compute/virtualMachineScaleSets',\n      'Microsoft.ContainerInstance/containerGroups',\n      'Microsoft.ContainerRegistry/registries',\n      'Microsoft.ContainerService/managedClusters',\n      'Microsoft.CustomerInsights/hubs',\n      'Microsoft.DataBoxEdge/dataBoxEdgeDevices',\n      'Microsoft.DataFactory/datafactories',\n      'Microsoft.DataFactory/factories',\n      'Microsoft.DataLakeAnalytics/accounts',\n      'Microsoft.DataLakeStore/accounts',\n      'Microsoft.DBforMariaDB/servers',\n      'Microsoft.DBforMySQL/servers',\n      'Microsoft.DBforMySQL/flexibleServers',\n      'Microsoft.DBforPostgreSQL/servers',\n      'Microsoft.DBforPostgreSQL/flexibleServers',\n      'Microsoft.Devices/IotHubs',\n      'Microsoft.Devices/provisioningServices',\n      'Microsoft.DocumentDB/databaseAccounts',\n      'Microsoft.EventGrid/topics',\n      'Microsoft.EventGrid/eventSubscriptions',\n      'Microsoft.EventGrid/extensionTopics',\n      'Microsoft.EventHub/namespaces',\n      'Microsoft.EventHub/clusters',\n      'Microsoft.HDInsight/clusters',\n      'Microsoft.Insights/AutoscaleSettings',\n      'Microsoft.Insights/components',\n      'Microsoft.KeyVault/vaults',\n      'Microsoft.Kusto/clusters',\n      'Microsoft.LocationBasedServices/accounts',\n      'Microsoft.Logic/workflows',\n      'Microsoft.Logic/integrationServiceEnvironments',\n      'Microsoft.NetApp/netAppAccounts/capacityPools',\n      'Microsoft.NetApp/netAppAccounts/capacityPools/volumes',\n      'Microsoft.Network/networkInterfaces',\n      'Microsoft.Network/loadBalancers',\n      'Microsoft.Network/dnsZones',\n      'Microsoft.Network/publicIPAddresses',\n      'Microsoft.Network/azureFirewalls',\n      'Microsoft.Network/applicationGateways',\n      'Microsoft.Network/virtualNetworkGateways',\n      'Microsoft.Network/expressRouteCircuits',\n      'Microsoft.Network/expressRouteCircuits/Peerings',\n      'Microsoft.Network/connections',\n      'Microsoft.Network/trafficManagerProfiles',\n      'Microsoft.Network/networkWatchers/connectionMonitors',\n      'Microsoft.Network/frontdoors',\n      'Microsoft.Network/natGateways',\n      'Microsoft.Network/vpngateways',\n      'Microsoft.Network/virtualNetworkGateways',\n      'Microsoft.NotificationHubs/namespaces/notificationHubs',\n      'Microsoft.OperationalInsights/workspaces',\n      'Microsoft.PowerBIDedicated/capacities',\n      'Microsoft.Relay/namespaces',\n      'Microsoft.Search/searchServices',\n      'Microsoft.ServiceBus/namespaces',\n      'Microsoft.SignalRService/SignalR',\n      'Microsoft.Sql/servers/databases',\n      'Microsoft.Sql/servers/elasticPools',\n      'Microsoft.Sql/managedInstances',\n      'Microsoft.Storage/storageAccounts',\n      'Microsoft.Storage/storageAccounts/blobServices',\n      'Microsoft.Storage/storageAccounts/fileServices',\n      'Microsoft.Storage/storageAccounts/queueServices',\n      'Microsoft.Storage/storageAccounts/tableServices',\n      'Microsoft.StorageSync/storageSyncServices',\n      'Microsoft.StorageSync/storageSyncServices/syncGroups',\n      'Microsoft.StorageSync/storageSyncServices/syncGroups/serverEndpoints',\n      'Microsoft.StorageSync/storageSyncServices/registeredServers',\n      'Microsoft.StreamAnalytics/streamingJobs',\n      'Microsoft.Web/serverfarms',\n      'Microsoft.Web/sites',\n      'Microsoft.Web/sites/slots',\n      'Microsoft.Web/hostingEnvironments/multiRolePools',\n      'Microsoft.Web/hostingEnvironments/workerPools',\n    ],\n    govazuremonitor: [\n      'Microsoft.AnalysisServices/servers',\n      'Microsoft.ApiManagement/service',\n      'Microsoft.Batch/batchAccounts',\n      'Microsoft.Cache/redis',\n      'Microsoft.Cdn/cdnwebapplicationfirewallpolicies',\n      'Microsoft.Cdn/profiles',\n      'Microsoft.ClassicCompute/virtualMachines',\n      'Microsoft.ClassicCompute/domainNames/slots/roles',\n      'Microsoft.CognitiveServices/accounts',\n      'Microsoft.Compute/virtualMachines',\n      'Microsoft.Compute/virtualMachineScaleSets',\n      'Microsoft.ContainerRegistry/registries',\n      'Microsoft.DBforMySQL/servers',\n      'Microsoft.DBforPostgreSQL/servers',\n      'Microsoft.Devices/IotHubs',\n      'Microsoft.Devices/provisioningServices',\n      'Microsoft.EventGrid/topics',\n      'Microsoft.EventGrid/eventSubscriptions',\n      'Microsoft.EventGrid/extensionTopics',\n      'Microsoft.EventHub/namespaces',\n      'Microsoft.EventHub/clusters',\n      'Microsoft.Insights/AutoscaleSettings',\n      'Microsoft.Insights/components',\n      'Microsoft.KeyVault/vaults',\n      'Microsoft.Logic/workflows',\n      'Microsoft.Network/networkInterfaces',\n      'Microsoft.Network/loadBalancers',\n      'Microsoft.Network/dnsZones',\n      'Microsoft.Network/publicIPAddresses',\n      'Microsoft.Network/azureFirewalls',\n      'Microsoft.Network/applicationGateways',\n      'Microsoft.Network/virtualNetworkGateways',\n      'Microsoft.Network/expressRouteCircuits',\n      'Microsoft.Network/expressRouteCircuits/Peerings',\n      'Microsoft.Network/connections',\n      'Microsoft.Network/trafficManagerProfiles',\n      'Microsoft.Network/networkWatchers/connectionMonitors',\n      'Microsoft.Network/frontdoors',\n      'Microsoft.NotificationHubs/namespaces/notificationHubs',\n      'Microsoft.OperationalInsights/workspaces',\n      'Microsoft.PowerBIDedicated/capacities',\n      'Microsoft.Relay/namespaces',\n      'Microsoft.ServiceBus/namespaces',\n      'Microsoft.Sql/servers/databases',\n      'Microsoft.Sql/servers/elasticPools',\n      'Microsoft.Sql/managedInstances',\n      'Microsoft.Storage/storageAccounts',\n      'Microsoft.Storage/storageAccounts/blobServices',\n      'Microsoft.Storage/storageAccounts/fileServices',\n      'Microsoft.Storage/storageAccounts/queueServices',\n      'Microsoft.Storage/storageAccounts/tableServices',\n      'Microsoft.Web/serverfarms',\n      'Microsoft.Web/sites',\n      'Microsoft.Web/sites/slots',\n      'Microsoft.Web/hostingEnvironments/multiRolePools',\n      'Microsoft.Web/hostingEnvironments/workerPools',\n    ],\n    germanyazuremonitor: [\n      'Microsoft.AnalysisServices/servers',\n      'Microsoft.Batch/batchAccounts',\n      'Microsoft.Cache/redis',\n      'Microsoft.Cdn/cdnwebapplicationfirewallpolicies',\n      'Microsoft.Cdn/profiles',\n      'Microsoft.ClassicCompute/virtualMachines',\n      'Microsoft.ClassicCompute/domainNames/slots/roles',\n      'Microsoft.Compute/virtualMachines',\n      'Microsoft.Compute/virtualMachineScaleSets',\n      'Microsoft.DBforMySQL/servers',\n      'Microsoft.DBforPostgreSQL/servers',\n      'Microsoft.Devices/IotHubs',\n      'Microsoft.Devices/provisioningServices',\n      'Microsoft.EventHub/namespaces',\n      'Microsoft.EventHub/clusters',\n      'Microsoft.Insights/AutoscaleSettings',\n      'Microsoft.Insights/components',\n      'Microsoft.KeyVault/vaults',\n      'Microsoft.Network/networkInterfaces',\n      'Microsoft.Network/loadBalancers',\n      'Microsoft.Network/dnsZones',\n      'Microsoft.Network/publicIPAddresses',\n      'Microsoft.Network/azureFirewalls',\n      'Microsoft.Network/applicationGateways',\n      'Microsoft.Network/virtualNetworkGateways',\n      'Microsoft.Network/expressRouteCircuits',\n      'Microsoft.Network/expressRouteCircuits/Peerings',\n      'Microsoft.Network/connections',\n      'Microsoft.Network/trafficManagerProfiles',\n      'Microsoft.Network/networkWatchers/connectionMonitors',\n      'Microsoft.Network/frontdoors',\n      'Microsoft.NotificationHubs/namespaces/notificationHubs',\n      'Microsoft.OperationalInsights/workspaces',\n      'Microsoft.PowerBIDedicated/capacities',\n      'Microsoft.Relay/namespaces',\n      'Microsoft.ServiceBus/namespaces',\n      'Microsoft.Sql/servers/databases',\n      'Microsoft.Sql/servers/elasticPools',\n      'Microsoft.Sql/managedInstances',\n      'Microsoft.Storage/storageAccounts',\n      'Microsoft.Storage/storageAccounts/blobServices',\n      'Microsoft.Storage/storageAccounts/fileServices',\n      'Microsoft.Storage/storageAccounts/queueServices',\n      'Microsoft.Storage/storageAccounts/tableServices',\n      'Microsoft.StreamAnalytics/streamingJobs',\n      'Microsoft.Web/serverfarms',\n      'Microsoft.Web/sites',\n      'Microsoft.Web/sites/slots',\n      'Microsoft.Web/hostingEnvironments/multiRolePools',\n      'Microsoft.Web/hostingEnvironments/workerPools',\n    ],\n    chinaazuremonitor: [\n      'Microsoft.AnalysisServices/servers',\n      'Microsoft.Batch/batchAccounts',\n      'Microsoft.Cache/redis',\n      'Microsoft.Cdn/cdnwebapplicationfirewallpolicies',\n      'Microsoft.Cdn/profiles',\n      'Microsoft.ClassicCompute/virtualMachines',\n      'Microsoft.ClassicCompute/domainNames/slots/roles',\n      'Microsoft.CognitiveServices/accounts',\n      'Microsoft.Compute/virtualMachines',\n      'Microsoft.Compute/virtualMachineScaleSets',\n      'Microsoft.ContainerRegistry/registries',\n      'Microsoft.DBforMySQL/servers',\n      'Microsoft.DBforPostgreSQL/servers',\n      'Microsoft.Devices/IotHubs',\n      'Microsoft.Devices/provisioningServices',\n      'Microsoft.EventHub/namespaces',\n      'Microsoft.Insights/AutoscaleSettings',\n      'Microsoft.Insights/components',\n      'Microsoft.KeyVault/vaults',\n      'Microsoft.Logic/workflows',\n      'Microsoft.Network/networkInterfaces',\n      'Microsoft.Network/loadBalancers',\n      'Microsoft.Network/dnsZones',\n      'Microsoft.Network/publicIPAddresses',\n      'Microsoft.Network/azureFirewalls',\n      'Microsoft.Network/applicationGateways',\n      'Microsoft.Network/virtualNetworkGateways',\n      'Microsoft.Network/expressRouteCircuits',\n      'Microsoft.Network/expressRouteCircuits/Peerings',\n      'Microsoft.Network/connections',\n      'Microsoft.Network/trafficManagerProfiles',\n      'Microsoft.Network/networkWatchers/connectionMonitors',\n      'Microsoft.Network/frontdoors',\n      'Microsoft.NotificationHubs/namespaces/notificationHubs',\n      'Microsoft.PowerBIDedicated/capacities',\n      'Microsoft.Relay/namespaces',\n      'Microsoft.ServiceBus/namespaces',\n      'Microsoft.Sql/servers/databases',\n      'Microsoft.Sql/servers/elasticPools',\n      'Microsoft.Sql/managedInstances',\n      'Microsoft.Storage/storageAccounts',\n      'Microsoft.Storage/storageAccounts/blobServices',\n      'Microsoft.Storage/storageAccounts/fileServices',\n      'Microsoft.Storage/storageAccounts/queueServices',\n      'Microsoft.Storage/storageAccounts/tableServices',\n      'Microsoft.StreamAnalytics/streamingJobs',\n      'Microsoft.Web/serverfarms',\n      'Microsoft.Web/sites',\n      'Microsoft.Web/sites/slots',\n      'Microsoft.Web/hostingEnvironments/multiRolePools',\n      'Microsoft.Web/hostingEnvironments/workerPools',\n    ],\n  };\n\n  constructor(private cloudName: string) {}\n\n  get(): string[] {\n    return this.supportedMetricNamespaces[this.cloudName];\n  }\n}\n","export default class UrlBuilder {\n  static buildAzureMonitorGetMetricNamespacesUrl(\n    baseUrl: string,\n    subscriptionId: string,\n    resourceGroup: string,\n    metricDefinition: string,\n    resourceName: string,\n    apiVersion: string\n  ) {\n    const metricDefinitionArray = metricDefinition.split('/');\n    const resourceNameArray = resourceName.split('/');\n    const provider = metricDefinitionArray.shift();\n    const urlArray = [baseUrl, subscriptionId, 'resourceGroups', resourceGroup, 'providers', provider];\n    for (const i in metricDefinitionArray) {\n      urlArray.push(metricDefinitionArray[i]);\n      urlArray.push(resourceNameArray[i]);\n    }\n    const urlPrefix = urlArray.join('/');\n    return `${urlPrefix}/providers/microsoft.insights/metricNamespaces?api-version=${apiVersion}`;\n  }\n\n  static buildAzureMonitorGetMetricNamesUrl(\n    baseUrl: string,\n    subscriptionId: string,\n    resourceGroup: string,\n    metricDefinition: string,\n    resourceName: string,\n    metricNamespace: string,\n    apiVersion: string\n  ) {\n    const metricDefinitionArray = metricDefinition.split('/');\n    const resourceNameArray = resourceName.split('/');\n    const provider = metricDefinitionArray.shift();\n    const urlArray = [baseUrl, subscriptionId, 'resourceGroups', resourceGroup, 'providers', provider];\n    for (const i in metricDefinitionArray) {\n      urlArray.push(metricDefinitionArray[i]);\n      urlArray.push(resourceNameArray[i]);\n    }\n    const urlPrefix = urlArray.join('/');\n    return (\n      `${urlPrefix}/providers/microsoft.insights/metricdefinitions?api-version=${apiVersion}` +\n      `&metricnamespace=${encodeURIComponent(metricNamespace)}`\n    );\n  }\n}\n","import { DataSourceInstanceSettings, ScopedVars } from '@grafana/data';\nimport { DataSourceWithBackend, getTemplateSrv } from '@grafana/runtime';\nimport { getTimeSrv, TimeSrv } from 'app/features/dashboard/services/TimeSrv';\nimport { filter, startsWith } from 'lodash';\n\nimport { resourceTypeDisplayNames } from '../azureMetadata';\nimport { getAuthType, getAzureCloud, getAzurePortalUrl } from '../credentials';\nimport TimegrainConverter from '../time_grain_converter';\nimport {\n  AzureDataSourceJsonData,\n  AzureMonitorMetricDefinitionsResponse,\n  AzureMonitorQuery,\n  AzureMonitorResourceGroupsResponse,\n  AzureQueryType,\n  DatasourceValidationResult,\n} from '../types';\nimport { routeNames } from '../utils/common';\nimport ResponseParser from './response_parser';\nimport SupportedNamespaces from './supported_namespaces';\nimport UrlBuilder from './url_builder';\n\nconst defaultDropdownValue = 'select';\n\nexport default class AzureMonitorDatasource extends DataSourceWithBackend<AzureMonitorQuery, AzureDataSourceJsonData> {\n  apiVersion = '2018-01-01';\n  apiPreviewVersion = '2017-12-01-preview';\n  listByResourceGroupApiVersion = '2021-04-01';\n  defaultSubscriptionId?: string;\n  resourcePath: string;\n  azurePortalUrl: string;\n  declare resourceGroup: string;\n  declare resourceName: string;\n  supportedMetricNamespaces: string[] = [];\n  timeSrv: TimeSrv;\n\n  constructor(private instanceSettings: DataSourceInstanceSettings<AzureDataSourceJsonData>) {\n    super(instanceSettings);\n\n    this.timeSrv = getTimeSrv();\n    this.defaultSubscriptionId = instanceSettings.jsonData.subscriptionId;\n\n    const cloud = getAzureCloud(instanceSettings);\n    this.resourcePath = `${routeNames.azureMonitor}/subscriptions`;\n    this.supportedMetricNamespaces = new SupportedNamespaces(cloud).get();\n    this.azurePortalUrl = getAzurePortalUrl(cloud);\n  }\n\n  isConfigured(): boolean {\n    // If validation didn't return any error then the data source is properly configured\n    return !this.validateDatasource();\n  }\n\n  filterQuery(item: AzureMonitorQuery): boolean {\n    return !!(\n      item.hide !== true &&\n      item.azureMonitor &&\n      item.azureMonitor.resourceGroup &&\n      item.azureMonitor.resourceGroup !== defaultDropdownValue &&\n      item.azureMonitor.resourceName &&\n      item.azureMonitor.resourceName !== defaultDropdownValue &&\n      item.azureMonitor.metricDefinition &&\n      item.azureMonitor.metricDefinition !== defaultDropdownValue &&\n      item.azureMonitor.metricName &&\n      item.azureMonitor.metricName !== defaultDropdownValue &&\n      item.azureMonitor.aggregation &&\n      item.azureMonitor.aggregation !== defaultDropdownValue\n    );\n  }\n\n  applyTemplateVariables(target: AzureMonitorQuery, scopedVars: ScopedVars): AzureMonitorQuery {\n    const item = target.azureMonitor;\n\n    if (!item) {\n      // return target;\n      throw new Error('Query is not a valid Azure Monitor Metrics query');\n    }\n\n    // fix for timeGrainUnit which is a deprecated/removed field name\n    if (item.timeGrain && item.timeGrainUnit && item.timeGrain !== 'auto') {\n      item.timeGrain = TimegrainConverter.createISO8601Duration(item.timeGrain, item.timeGrainUnit);\n    }\n\n    const templateSrv = getTemplateSrv();\n\n    const subscriptionId = templateSrv.replace(target.subscription || this.defaultSubscriptionId, scopedVars);\n    const resourceGroup = templateSrv.replace(item.resourceGroup, scopedVars);\n    const resourceName = templateSrv.replace(item.resourceName, scopedVars);\n    const metricNamespace = templateSrv.replace(item.metricNamespace, scopedVars);\n    const metricDefinition = templateSrv.replace(item.metricDefinition, scopedVars);\n    const timeGrain = templateSrv.replace((item.timeGrain || '').toString(), scopedVars);\n    const aggregation = templateSrv.replace(item.aggregation, scopedVars);\n    const top = templateSrv.replace(item.top || '', scopedVars);\n\n    const dimensionFilters = (item.dimensionFilters ?? [])\n      .filter((f) => f.dimension && f.dimension !== 'None')\n      .map((f) => {\n        const filter = templateSrv.replace(f.filter ?? '', scopedVars);\n        return {\n          dimension: templateSrv.replace(f.dimension, scopedVars),\n          operator: f.operator || 'eq',\n          filter: filter || '*', // send * when empty\n        };\n      });\n\n    return {\n      refId: target.refId,\n      subscription: subscriptionId,\n      queryType: AzureQueryType.AzureMonitor,\n      azureMonitor: {\n        resourceGroup,\n        resourceName,\n        metricDefinition,\n        timeGrain,\n        allowedTimeGrainsMs: item.allowedTimeGrainsMs,\n        metricName: templateSrv.replace(item.metricName, scopedVars),\n        metricNamespace:\n          metricNamespace && metricNamespace !== defaultDropdownValue ? metricNamespace : metricDefinition,\n        aggregation: aggregation,\n        dimensionFilters,\n        top: top || '10',\n        alias: item.alias,\n      },\n    };\n  }\n\n  async getSubscriptions(): Promise<Array<{ text: string; value: string }>> {\n    if (!this.isConfigured()) {\n      return [];\n    }\n\n    return this.getResource(`${this.resourcePath}?api-version=2019-03-01`).then((result: any) => {\n      return ResponseParser.parseSubscriptions(result);\n    });\n  }\n\n  getResourceGroups(subscriptionId: string) {\n    return this.getResource(\n      `${this.resourcePath}/${subscriptionId}/resourceGroups?api-version=${this.listByResourceGroupApiVersion}`\n    ).then((result: AzureMonitorResourceGroupsResponse) => {\n      return ResponseParser.parseResponseValues(result, 'name', 'name');\n    });\n  }\n\n  getMetricDefinitions(subscriptionId: string, resourceGroup: string) {\n    return this.getResource(\n      `${this.resourcePath}/${subscriptionId}/resourceGroups/${resourceGroup}/resources?api-version=${this.listByResourceGroupApiVersion}`\n    )\n      .then((result: AzureMonitorMetricDefinitionsResponse) => {\n        return ResponseParser.parseResponseValues(result, 'type', 'type');\n      })\n      .then((result) => {\n        return filter(result, (t) => {\n          for (let i = 0; i < this.supportedMetricNamespaces.length; i++) {\n            if (t.value.toLowerCase() === this.supportedMetricNamespaces[i].toLowerCase()) {\n              return true;\n            }\n          }\n\n          return false;\n        });\n      })\n      .then((result) => {\n        let shouldHardcodeBlobStorage = false;\n        for (let i = 0; i < result.length; i++) {\n          if (result[i].value === 'Microsoft.Storage/storageAccounts') {\n            shouldHardcodeBlobStorage = true;\n            break;\n          }\n        }\n\n        if (shouldHardcodeBlobStorage) {\n          result.push({\n            text: 'Microsoft.Storage/storageAccounts/blobServices',\n            value: 'Microsoft.Storage/storageAccounts/blobServices',\n          });\n          result.push({\n            text: 'Microsoft.Storage/storageAccounts/fileServices',\n            value: 'Microsoft.Storage/storageAccounts/fileServices',\n          });\n          result.push({\n            text: 'Microsoft.Storage/storageAccounts/tableServices',\n            value: 'Microsoft.Storage/storageAccounts/tableServices',\n          });\n          result.push({\n            text: 'Microsoft.Storage/storageAccounts/queueServices',\n            value: 'Microsoft.Storage/storageAccounts/queueServices',\n          });\n        }\n\n        return result.map((v) => ({\n          value: v.value,\n          text: resourceTypeDisplayNames[v.value.toLowerCase()] || v.value,\n        }));\n      });\n  }\n\n  getResourceNames(subscriptionId: string, resourceGroup: string, metricDefinition: string, skipToken?: string) {\n    let url =\n      `${this.resourcePath}/${subscriptionId}/resourceGroups/${resourceGroup}/resources?` +\n      `$filter=resourceType eq '${metricDefinition}'&` +\n      `api-version=${this.listByResourceGroupApiVersion}`;\n    if (skipToken) {\n      url += `&$skiptoken=${skipToken}`;\n    }\n    return this.getResource(url).then(async (result: any) => {\n      let list: Array<{ text: string; value: string }> = [];\n      if (startsWith(metricDefinition, 'Microsoft.Storage/storageAccounts/')) {\n        list = ResponseParser.parseResourceNames(result, 'Microsoft.Storage/storageAccounts');\n        for (let i = 0; i < list.length; i++) {\n          list[i].text += '/default';\n          list[i].value += '/default';\n        }\n      } else {\n        list = ResponseParser.parseResourceNames(result, metricDefinition);\n      }\n\n      if (result.nextLink) {\n        // If there is a nextLink, we should request more pages\n        const nextURL = new URL(result.nextLink);\n        const nextToken = nextURL.searchParams.get('$skiptoken');\n        if (!nextToken) {\n          throw Error('unable to request the next page of resources');\n        }\n        const nextPage = await this.getResourceNames(subscriptionId, resourceGroup, metricDefinition, nextToken);\n        list = list.concat(nextPage);\n      }\n\n      return list;\n    });\n  }\n\n  getMetricNamespaces(subscriptionId: string, resourceGroup: string, metricDefinition: string, resourceName: string) {\n    const url = UrlBuilder.buildAzureMonitorGetMetricNamespacesUrl(\n      this.resourcePath,\n      subscriptionId,\n      resourceGroup,\n      metricDefinition,\n      resourceName,\n      this.apiPreviewVersion\n    );\n\n    return this.getResource(url).then((result: any) => {\n      return ResponseParser.parseResponseValues(result, 'name', 'properties.metricNamespaceName');\n    });\n  }\n\n  getMetricNames(\n    subscriptionId: string,\n    resourceGroup: string,\n    metricDefinition: string,\n    resourceName: string,\n    metricNamespace: string\n  ) {\n    const url = UrlBuilder.buildAzureMonitorGetMetricNamesUrl(\n      this.resourcePath,\n      subscriptionId,\n      resourceGroup,\n      metricDefinition,\n      resourceName,\n      metricNamespace,\n      this.apiVersion\n    );\n\n    return this.getResource(url).then((result: any) => {\n      return ResponseParser.parseResponseValues(result, 'name.localizedValue', 'name.value');\n    });\n  }\n\n  getMetricMetadata(\n    subscriptionId: string,\n    resourceGroup: string,\n    metricDefinition: string,\n    resourceName: string,\n    metricNamespace: string,\n    metricName: string\n  ) {\n    const url = UrlBuilder.buildAzureMonitorGetMetricNamesUrl(\n      this.resourcePath,\n      subscriptionId,\n      resourceGroup,\n      metricDefinition,\n      resourceName,\n      metricNamespace,\n      this.apiVersion\n    );\n\n    return this.getResource(url).then((result: any) => {\n      return ResponseParser.parseMetadata(result, metricName);\n    });\n  }\n\n  async testDatasource(): Promise<DatasourceValidationResult> {\n    const validationError = this.validateDatasource();\n    if (validationError) {\n      return Promise.resolve(validationError);\n    }\n\n    try {\n      const url = `${this.resourcePath}?api-version=2019-03-01`;\n\n      return await this.getResource(url).then<DatasourceValidationResult>((response: any) => {\n        return {\n          status: 'success',\n          message: 'Successfully queried the Azure Monitor service.',\n          title: 'Success',\n        };\n      });\n    } catch (e) {\n      let message = 'Azure Monitor: ';\n      message += e.statusText ? e.statusText + ': ' : '';\n\n      if (e.data && e.data.error && e.data.error.code) {\n        message += e.data.error.code + '. ' + e.data.error.message;\n      } else if (e.data && e.data.error) {\n        message += e.data.error;\n      } else if (e.data) {\n        message += e.data;\n      } else {\n        message += 'Cannot connect to Azure Monitor REST API.';\n      }\n      return {\n        status: 'error',\n        message: message,\n      };\n    }\n  }\n\n  private validateDatasource(): DatasourceValidationResult | undefined {\n    const authType = getAuthType(this.instanceSettings);\n\n    if (authType === 'clientsecret') {\n      if (!this.isValidConfigField(this.instanceSettings.jsonData.tenantId)) {\n        return {\n          status: 'error',\n          message: 'The Tenant Id field is required.',\n        };\n      }\n\n      if (!this.isValidConfigField(this.instanceSettings.jsonData.clientId)) {\n        return {\n          status: 'error',\n          message: 'The Client Id field is required.',\n        };\n      }\n    }\n\n    return undefined;\n  }\n\n  private isValidConfigField(field?: string): boolean {\n    return typeof field === 'string' && field.length > 0;\n  }\n}\n","import { concat, filter, find, forEach, indexOf, intersection, isObject, map, without, keys as _keys } from 'lodash';\nimport { dateTime } from '@grafana/data';\n\nexport default class ResponseParser {\n  constructor(private results: any) {}\n\n  parseQueryResult() {\n    let data: any = [];\n    let columns: any = [];\n    for (let i = 0; i < this.results.length; i++) {\n      if (this.results[i].query.raw) {\n        const xaxis = this.results[i].query.xaxis;\n        const yaxises = this.results[i].query.yaxis;\n        const spliton = this.results[i].query.spliton;\n        columns = this.results[i].result.Tables[0].Columns;\n        const rows = this.results[i].result.Tables[0].Rows;\n        data = concat(data, this.parseRawQueryResultRow(this.results[i].query, columns, rows, xaxis, yaxises, spliton));\n      } else {\n        const value = this.results[i].result.value;\n        const alias = this.results[i].query.alias;\n        data = concat(data, this.parseQueryResultRow(this.results[i].query, value, alias));\n      }\n    }\n    return data;\n  }\n\n  parseRawQueryResultRow(query: any, columns: any, rows: any, xaxis: string, yaxises: string, spliton: string) {\n    const data: any[] = [];\n    const columnsForDropdown = map(columns, (column) => ({ text: column.ColumnName, value: column.ColumnName }));\n\n    const xaxisColumn = columns.findIndex((column: any) => column.ColumnName === xaxis);\n    const yaxisesSplit = yaxises.split(',');\n    const yaxisColumns: any = {};\n    forEach(yaxisesSplit, (yaxis) => {\n      yaxisColumns[yaxis] = columns.findIndex((column: any) => column.ColumnName === yaxis);\n    });\n    const splitonColumn = columns.findIndex((column: any) => column.ColumnName === spliton);\n    const convertTimestamp = xaxis === 'timestamp';\n\n    forEach(rows, (row) => {\n      forEach(yaxisColumns, (yaxisColumn, yaxisName) => {\n        const bucket =\n          splitonColumn === -1\n            ? ResponseParser.findOrCreateBucket(data, yaxisName)\n            : ResponseParser.findOrCreateBucket(data, row[splitonColumn]);\n        const epoch = convertTimestamp ? ResponseParser.dateTimeToEpoch(row[xaxisColumn]) : row[xaxisColumn];\n        bucket.datapoints.push([row[yaxisColumn], epoch]);\n        bucket.refId = query.refId;\n        bucket.query = query.query;\n        bucket.columnsForDropdown = columnsForDropdown;\n      });\n    });\n\n    return data;\n  }\n\n  parseQueryResultRow(query: any, value: any, alias: string) {\n    const data: any[] = [];\n\n    if (ResponseParser.isSingleValue(value)) {\n      const metricName = ResponseParser.getMetricFieldKey(value);\n      const aggField = ResponseParser.getKeyForAggregationField(value[metricName]);\n      const epoch = ResponseParser.dateTimeToEpoch(value.end);\n      data.push({\n        target: metricName,\n        datapoints: [[value[metricName][aggField], epoch]],\n        refId: query.refId,\n        query: query.query,\n      });\n      return data;\n    }\n\n    const groupedBy = ResponseParser.hasSegmentsField(value.segments[0]);\n    if (!groupedBy) {\n      const metricName = ResponseParser.getMetricFieldKey(value.segments[0]);\n      const dataTarget = ResponseParser.findOrCreateBucket(data, metricName);\n\n      for (let i = 0; i < value.segments.length; i++) {\n        const epoch = ResponseParser.dateTimeToEpoch(value.segments[i].end);\n        const aggField: string = ResponseParser.getKeyForAggregationField(value.segments[i][metricName]);\n\n        dataTarget.datapoints.push([value.segments[i][metricName][aggField], epoch]);\n      }\n      dataTarget.refId = query.refId;\n      dataTarget.query = query.query;\n    } else {\n      for (let i = 0; i < value.segments.length; i++) {\n        const epoch = ResponseParser.dateTimeToEpoch(value.segments[i].end);\n\n        for (let j = 0; j < value.segments[i].segments.length; j++) {\n          const metricName = ResponseParser.getMetricFieldKey(value.segments[i].segments[j]);\n          const aggField = ResponseParser.getKeyForAggregationField(value.segments[i].segments[j][metricName]);\n          const target = this.getTargetName(value.segments[i].segments[j], alias);\n\n          const bucket = ResponseParser.findOrCreateBucket(data, target);\n          bucket.datapoints.push([value.segments[i].segments[j][metricName][aggField], epoch]);\n          bucket.refId = query.refId;\n          bucket.meta = {\n            query: query.query,\n          };\n        }\n      }\n    }\n\n    return data;\n  }\n\n  getTargetName(segment: { [x: string]: string }, alias: string) {\n    let metric = '';\n    let segmentName = '';\n    let segmentValue = '';\n    for (const prop in segment) {\n      if (isObject(segment[prop])) {\n        metric = prop;\n      } else {\n        segmentName = prop;\n        segmentValue = segment[prop];\n      }\n    }\n\n    if (alias) {\n      const regex = /\\{\\{([\\s\\S]+?)\\}\\}/g;\n      return alias.replace(regex, (match, g1, g2) => {\n        const group = g1 || g2;\n\n        if (group === 'metric') {\n          return metric;\n        } else if (group === 'groupbyname') {\n          return segmentName;\n        } else if (group === 'groupbyvalue') {\n          return segmentValue;\n        }\n\n        return match;\n      });\n    }\n\n    return metric + `{${segmentName}=\"${segmentValue}\"}`;\n  }\n\n  static isSingleValue(value: any) {\n    return !ResponseParser.hasSegmentsField(value);\n  }\n\n  static findOrCreateBucket(data: any[], target: string) {\n    let dataTarget: any = find(data, ['target', target]);\n    if (!dataTarget) {\n      dataTarget = { target: target, datapoints: [] };\n      data.push(dataTarget);\n    }\n\n    return dataTarget;\n  }\n\n  static hasSegmentsField(obj: any) {\n    const keys = _keys(obj);\n    return indexOf(keys, 'segments') > -1;\n  }\n\n  static getMetricFieldKey(segment: { [x: string]: any }) {\n    const keys = _keys(segment);\n\n    return filter(without(keys, 'start', 'end'), (key) => {\n      return isObject(segment[key]);\n    })[0];\n  }\n\n  static getKeyForAggregationField(dataObj: any): string {\n    const keys = _keys(dataObj);\n    return intersection(keys, ['sum', 'avg', 'min', 'max', 'count', 'unique'])[0];\n  }\n\n  static dateTimeToEpoch(dateTimeValue: any) {\n    return dateTime(dateTimeValue).valueOf();\n  }\n\n  static parseMetricNames(result: { metrics: any }) {\n    const keys = _keys(result.metrics);\n\n    return ResponseParser.toTextValueList(keys);\n  }\n\n  parseMetadata(metricName: string) {\n    const metric = this.results.metrics[metricName];\n\n    if (!metric) {\n      throw Error('No data found for metric: ' + metricName);\n    }\n\n    return {\n      primaryAggType: metric.defaultAggregation,\n      supportedAggTypes: metric.supportedAggregations,\n      supportedGroupBy: metric.supportedGroupBy.all,\n    };\n  }\n\n  parseGroupBys() {\n    return ResponseParser.toTextValueList(this.results.supportedGroupBy);\n  }\n\n  parseQuerySchema() {\n    const result: any = {\n      Type: 'AppInsights',\n      Tables: {},\n    };\n    if (this.results && this.results && this.results.Tables) {\n      for (let i = 0; i < this.results.Tables[0].Rows.length; i++) {\n        const column = this.results.Tables[0].Rows[i];\n        const columnTable = column[0];\n        const columnName = column[1];\n        const columnType = column[2];\n        if (result.Tables[columnTable]) {\n          result.Tables[columnTable].OrderedColumns.push({ Name: columnName, Type: columnType });\n        } else {\n          result.Tables[columnTable] = {\n            Name: columnTable,\n            OrderedColumns: [{ Name: columnName, Type: columnType }],\n          };\n        }\n      }\n    }\n    return result;\n  }\n\n  static toTextValueList(values: any) {\n    const list: any[] = [];\n    for (let i = 0; i < values.length; i++) {\n      list.push({\n        text: values[i],\n        value: values[i],\n      });\n    }\n    return list;\n  }\n}\n","import { DataQueryRequest, DataSourceInstanceSettings, ScopedVars } from '@grafana/data';\nimport { getTemplateSrv, DataSourceWithBackend } from '@grafana/runtime';\nimport { isString } from 'lodash';\n\nimport TimegrainConverter from '../time_grain_converter';\nimport { AzureDataSourceJsonData, AzureMonitorQuery, AzureQueryType, DatasourceValidationResult } from '../types';\nimport { routeNames } from '../utils/common';\nimport ResponseParser from './response_parser';\n\nexport interface LogAnalyticsColumn {\n  text: string;\n  value: string;\n}\n\nexport default class AppInsightsDatasource extends DataSourceWithBackend<AzureMonitorQuery, AzureDataSourceJsonData> {\n  resourcePath: string;\n  version = 'beta';\n  applicationId: string;\n  logAnalyticsColumns: { [key: string]: LogAnalyticsColumn[] } = {};\n\n  constructor(instanceSettings: DataSourceInstanceSettings<AzureDataSourceJsonData>) {\n    super(instanceSettings);\n    this.applicationId = instanceSettings.jsonData.appInsightsAppId || '';\n\n    this.resourcePath = `${routeNames.appInsights}/${this.version}/apps/${this.applicationId}`;\n  }\n\n  isConfigured(): boolean {\n    return !!this.applicationId && this.applicationId.length > 0;\n  }\n\n  createRawQueryRequest(item: any, options: DataQueryRequest<AzureMonitorQuery>, target: AzureMonitorQuery) {\n    if (item.xaxis && !item.timeColumn) {\n      item.timeColumn = item.xaxis;\n    }\n\n    if (item.yaxis && !item.valueColumn) {\n      item.valueColumn = item.yaxis;\n    }\n\n    if (item.spliton && !item.segmentColumn) {\n      item.segmentColumn = item.spliton;\n    }\n\n    return {\n      type: 'timeSeriesQuery',\n      raw: false,\n      appInsights: {\n        rawQuery: true,\n        rawQueryString: getTemplateSrv().replace(item.rawQueryString, options.scopedVars),\n        timeColumn: item.timeColumn,\n        valueColumn: item.valueColumn,\n        segmentColumn: item.segmentColumn,\n      },\n    };\n  }\n\n  applyTemplateVariables(target: AzureMonitorQuery, scopedVars: ScopedVars): AzureMonitorQuery {\n    const item = target.appInsights;\n\n    if (!item) {\n      return target;\n    }\n\n    const old: any = item;\n    // fix for timeGrainUnit which is a deprecated/removed field name\n    if (old.timeGrainCount) {\n      item.timeGrain = TimegrainConverter.createISO8601Duration(old.timeGrainCount, item.timeGrainUnit);\n    } else if (item.timeGrain && item.timeGrainUnit && item.timeGrain !== 'auto') {\n      item.timeGrain = TimegrainConverter.createISO8601Duration(item.timeGrain, item.timeGrainUnit);\n    }\n\n    // migration for non-standard names\n    if (old.groupBy && !item.dimension) {\n      item.dimension = [old.groupBy];\n    }\n    if (old.filter && !item.dimensionFilter) {\n      item.dimensionFilter = old.filter;\n    }\n\n    // Migrate single dimension string to array\n    if (isString(item.dimension)) {\n      if (item.dimension === 'None') {\n        item.dimension = [];\n      } else {\n        item.dimension = [item.dimension as string];\n      }\n    }\n    if (!item.dimension) {\n      item.dimension = [];\n    }\n\n    const templateSrv = getTemplateSrv();\n\n    return {\n      refId: target.refId,\n      queryType: AzureQueryType.ApplicationInsights,\n      appInsights: {\n        timeGrain: templateSrv.replace((item.timeGrain || '').toString(), scopedVars),\n        metricName: templateSrv.replace(item.metricName, scopedVars),\n        aggregation: templateSrv.replace(item.aggregation, scopedVars),\n        dimension: item.dimension.map((d) => templateSrv.replace(d, scopedVars)),\n        dimensionFilter: templateSrv.replace(item.dimensionFilter, scopedVars),\n        alias: item.alias,\n      },\n    };\n  }\n\n  testDatasource(): Promise<DatasourceValidationResult> {\n    const path = `${this.resourcePath}/metrics/metadata`;\n    return this.getResource(path)\n      .then<DatasourceValidationResult>((response: any) => {\n        return {\n          status: 'success',\n          message: 'Successfully queried the Application Insights service.',\n          title: 'Success',\n        };\n      })\n      .catch((error: any) => {\n        let message = 'Application Insights: ';\n        message += error.statusText ? error.statusText + ': ' : '';\n\n        if (error.data && error.data.error && error.data.error.code === 'PathNotFoundError') {\n          message += 'Invalid Application Id for Application Insights service.';\n        } else if (error.data && error.data.error) {\n          message += error.data.error.code + '. ' + error.data.error.message;\n        } else {\n          message += 'Cannot connect to Application Insights REST API.';\n        }\n\n        return {\n          status: 'error',\n          message: message,\n        };\n      });\n  }\n\n  getMetricNames() {\n    const path = `${this.resourcePath}/metrics/metadata`;\n    return this.getResource(path).then(ResponseParser.parseMetricNames);\n  }\n\n  getMetricMetadata(metricName: string) {\n    const path = `${this.resourcePath}/metrics/metadata`;\n    return this.getResource(path).then((result: any) => {\n      return new ResponseParser(result).parseMetadata(metricName);\n    });\n  }\n\n  getGroupBys(metricName: string) {\n    return this.getMetricMetadata(metricName).then((result: any) => {\n      return new ResponseParser(result).parseGroupBys();\n    });\n  }\n\n  getQuerySchema() {\n    const path = `${this.resourcePath}/query/schema`;\n    return this.getResource(path).then((result: any) => {\n      const schema = new ResponseParser(result).parseQuerySchema();\n      // console.log(schema);\n      return schema;\n    });\n  }\n}\n","import { dateTime } from '@grafana/data';\n\nexport default class LogAnalyticsQuerystringBuilder {\n  constructor(public rawQueryString: string, public options: any, public defaultTimeField: any) {}\n\n  generate() {\n    let queryString = this.rawQueryString;\n    const macroRegexp = /\\$__([_a-zA-Z0-9]+)\\(([^()]*)\\)/gi;\n    queryString = queryString.replace(macroRegexp, (match, p1, p2) => {\n      if (p1 === 'contains') {\n        return this.getMultiContains(p2);\n      }\n\n      return match;\n    });\n\n    queryString = queryString.replace(/\\$__escapeMulti\\(('[^]*')\\)/gi, (match, p1) => this.escape(p1));\n\n    if (this.options) {\n      queryString = queryString.replace(macroRegexp, (match, p1, p2) => {\n        if (p1 === 'timeFilter') {\n          return this.getTimeFilter(p2, this.options);\n        }\n        if (p1 === 'timeFrom') {\n          return this.getFrom(this.options);\n        }\n        if (p1 === 'timeTo') {\n          return this.getUntil(this.options);\n        }\n\n        return match;\n      });\n      queryString = queryString.replace(/\\$__interval/gi, this.options.interval);\n    }\n    const rawQuery = queryString;\n    queryString = encodeURIComponent(queryString);\n    const uriString = `query=${queryString}`;\n\n    return { uriString, rawQuery };\n  }\n\n  getFrom(options: any) {\n    const from = options.range.from;\n    return `datetime(${dateTime(from).startOf('minute').toISOString()})`;\n  }\n\n  getUntil(options: any) {\n    if (options.rangeRaw?.to === 'now') {\n      const now = Date.now();\n      return `datetime(${dateTime(now).startOf('minute').toISOString()})`;\n    } else {\n      const until = options.range.to;\n      return `datetime(${dateTime(until).startOf('minute').toISOString()})`;\n    }\n  }\n\n  getTimeFilter(timeFieldArg: any, options: any) {\n    const timeField = timeFieldArg || this.defaultTimeField;\n    if (options.rangeRaw?.to === 'now') {\n      return `${timeField} >= ${this.getFrom(options)}`;\n    } else {\n      return `${timeField}  >= ${this.getFrom(options)} and ${timeField} <= ${this.getUntil(options)}`;\n    }\n  }\n\n  getMultiContains(inputs: string) {\n    const firstCommaIndex = inputs.indexOf(',');\n    const field = inputs.substring(0, firstCommaIndex);\n    const templateVar = inputs.substring(inputs.indexOf(',') + 1);\n\n    if (templateVar && templateVar.toLowerCase().trim() === 'all') {\n      return '1 == 1';\n    }\n\n    return `${field.trim()} in (${templateVar.trim()})`;\n  }\n\n  escape(inputs: string) {\n    return inputs\n      .substring(1, inputs.length - 1)\n      .split(`','`)\n      .map((v) => `@'${v}'`)\n      .join(', ');\n  }\n}\n","import { concat, find, flattenDeep, forEach, get, map } from 'lodash';\nimport { AnnotationEvent, dateTime, TimeSeries } from '@grafana/data';\nimport { AzureLogsTableData, AzureLogsVariable } from '../types';\nimport { AzureLogAnalyticsMetadata } from '../types/logAnalyticsMetadata';\n\nexport default class ResponseParser {\n  declare columns: string[];\n  constructor(private results: any) {}\n\n  parseQueryResult(): any {\n    let data: any[] = [];\n    let columns: any[] = [];\n    for (let i = 0; i < this.results.length; i++) {\n      if (this.results[i].result.tables.length === 0) {\n        continue;\n      }\n      columns = this.results[i].result.tables[0].columns;\n      const rows = this.results[i].result.tables[0].rows;\n\n      if (this.results[i].query.resultFormat === 'time_series') {\n        data = concat(data, this.parseTimeSeriesResult(this.results[i].query, columns, rows));\n      } else {\n        data = concat(data, this.parseTableResult(this.results[i].query, columns, rows));\n      }\n    }\n\n    return data;\n  }\n\n  parseTimeSeriesResult(query: { refId: string; query: any }, columns: any[], rows: any): TimeSeries[] {\n    const data: TimeSeries[] = [];\n    let timeIndex = -1;\n    let metricIndex = -1;\n    let valueIndex = -1;\n\n    for (let i = 0; i < columns.length; i++) {\n      if (timeIndex === -1 && columns[i].type === 'datetime') {\n        timeIndex = i;\n      }\n\n      if (metricIndex === -1 && columns[i].type === 'string') {\n        metricIndex = i;\n      }\n\n      if (valueIndex === -1 && ['int', 'long', 'real', 'double'].indexOf(columns[i].type) > -1) {\n        valueIndex = i;\n      }\n    }\n\n    if (timeIndex === -1) {\n      throw new Error('No datetime column found in the result. The Time Series format requires a time column.');\n    }\n\n    forEach(rows, (row) => {\n      const epoch = ResponseParser.dateTimeToEpoch(row[timeIndex]);\n      const metricName = metricIndex > -1 ? row[metricIndex] : columns[valueIndex].name;\n      const bucket = ResponseParser.findOrCreateBucket(data, metricName);\n      bucket.datapoints.push([row[valueIndex], epoch]);\n      bucket.refId = query.refId;\n      bucket.meta = {\n        executedQueryString: query.query,\n      };\n    });\n\n    return data;\n  }\n\n  parseTableResult(query: { refId: string; query: string }, columns: any[], rows: any[]): AzureLogsTableData {\n    const tableResult: AzureLogsTableData = {\n      type: 'table',\n      columns: map(columns, (col) => {\n        return { text: col.name, type: col.type };\n      }),\n      rows: rows,\n      refId: query.refId,\n      meta: {\n        executedQueryString: query.query,\n      },\n    };\n\n    return tableResult;\n  }\n\n  parseToVariables(): AzureLogsVariable[] {\n    const queryResult = this.parseQueryResult();\n\n    const variables: AzureLogsVariable[] = [];\n    forEach(queryResult, (result) => {\n      forEach(flattenDeep(result.rows), (row) => {\n        variables.push({\n          text: row,\n          value: row,\n        } as AzureLogsVariable);\n      });\n    });\n\n    return variables;\n  }\n\n  transformToAnnotations(options: any) {\n    const queryResult = this.parseQueryResult();\n\n    const list: AnnotationEvent[] = [];\n\n    forEach(queryResult, (result) => {\n      let timeIndex = -1;\n      let textIndex = -1;\n      let tagsIndex = -1;\n\n      for (let i = 0; i < result.columns.length; i++) {\n        if (timeIndex === -1 && result.columns[i].type === 'datetime') {\n          timeIndex = i;\n        }\n\n        if (textIndex === -1 && result.columns[i].text.toLowerCase() === 'text') {\n          textIndex = i;\n        }\n\n        if (tagsIndex === -1 && result.columns[i].text.toLowerCase() === 'tags') {\n          tagsIndex = i;\n        }\n      }\n\n      forEach(result.rows, (row) => {\n        list.push({\n          annotation: options.annotation,\n          time: Math.floor(ResponseParser.dateTimeToEpoch(row[timeIndex])),\n          text: row[textIndex] ? row[textIndex].toString() : '',\n          tags: row[tagsIndex] ? row[tagsIndex].trim().split(/\\s*,\\s*/) : [],\n        });\n      });\n    });\n\n    return list;\n  }\n\n  static findOrCreateBucket(data: TimeSeries[], target: any): TimeSeries {\n    let dataTarget: any = find(data, ['target', target]);\n    if (!dataTarget) {\n      dataTarget = { target: target, datapoints: [], refId: '', query: '' };\n      data.push(dataTarget);\n    }\n\n    return dataTarget;\n  }\n\n  static dateTimeToEpoch(dateTimeValue: any) {\n    return dateTime(dateTimeValue).valueOf();\n  }\n\n  static parseSubscriptions(result: any): Array<{ text: string; value: string }> {\n    const list: Array<{ text: string; value: string }> = [];\n\n    if (!result) {\n      return list;\n    }\n\n    const valueFieldName = 'subscriptionId';\n    const textFieldName = 'displayName';\n    for (let i = 0; i < result.value.length; i++) {\n      if (!find(list, ['value', get(result.value[i], valueFieldName)])) {\n        list.push({\n          text: `${get(result.value[i], textFieldName)}`,\n          value: get(result.value[i], valueFieldName),\n        });\n      }\n    }\n\n    return list;\n  }\n}\n\n// matches (name):(type) = (defaultValue)\n// e.g. fromRangeStart:datetime = datetime(null)\n//  - name: fromRangeStart\n//  - type: datetime\n//  - defaultValue: datetime(null)\nconst METADATA_FUNCTION_PARAMS = /([\\w\\W]+):([\\w]+)(?:\\s?=\\s?([\\w\\W]+))?/;\n\nfunction transformMetadataFunction(sourceSchema: AzureLogAnalyticsMetadata) {\n  if (!sourceSchema.functions) {\n    return [];\n  }\n\n  return sourceSchema.functions.map((fn) => {\n    const params =\n      fn.parameters &&\n      fn.parameters\n        .split(', ')\n        .map((arg) => {\n          const match = arg.match(METADATA_FUNCTION_PARAMS);\n          if (!match) {\n            return;\n          }\n\n          const [, name, type, defaultValue] = match;\n\n          return {\n            name,\n            type,\n            defaultValue,\n            cslDefaultValue: defaultValue,\n          };\n        })\n        .filter(<T>(v: T): v is Exclude<T, undefined> => !!v);\n\n    return {\n      name: fn.name,\n      body: fn.body,\n      inputParameters: params || [],\n    };\n  });\n}\n\nexport function transformMetadataToKustoSchema(sourceSchema: AzureLogAnalyticsMetadata, nameOrIdOrSomething: string) {\n  const database = {\n    name: nameOrIdOrSomething,\n    tables: sourceSchema.tables,\n    functions: transformMetadataFunction(sourceSchema),\n    majorVersion: 0,\n    minorVersion: 0,\n  };\n\n  return {\n    clusterType: 'Engine',\n    cluster: {\n      connectionString: nameOrIdOrSomething,\n      databases: [database],\n    },\n    database: database,\n  };\n}\n","import { map } from 'lodash';\nimport LogAnalyticsQuerystringBuilder from '../log_analytics/querystring_builder';\nimport ResponseParser, { transformMetadataToKustoSchema } from './response_parser';\nimport {\n  AzureMonitorQuery,\n  AzureDataSourceJsonData,\n  AzureLogsVariable,\n  AzureQueryType,\n  DatasourceValidationResult,\n} from '../types';\nimport {\n  DataQueryRequest,\n  DataQueryResponse,\n  ScopedVars,\n  DataSourceInstanceSettings,\n  DataSourceRef,\n} from '@grafana/data';\nimport { getTemplateSrv, DataSourceWithBackend } from '@grafana/runtime';\nimport { Observable, from } from 'rxjs';\nimport { mergeMap } from 'rxjs/operators';\nimport { getAuthType, getAzureCloud, getAzurePortalUrl } from '../credentials';\nimport { isGUIDish } from '../components/ResourcePicker/utils';\nimport { interpolateVariable, routeNames } from '../utils/common';\n\ninterface AdhocQuery {\n  datasource: DataSourceRef;\n  path: string;\n  resultFormat: string;\n}\n\nexport default class AzureLogAnalyticsDatasource extends DataSourceWithBackend<\n  AzureMonitorQuery,\n  AzureDataSourceJsonData\n> {\n  resourcePath: string;\n  azurePortalUrl: string;\n  declare applicationId: string;\n\n  defaultSubscriptionId?: string;\n\n  azureMonitorPath: string;\n  firstWorkspace?: string;\n  cache: Map<string, any>;\n\n  constructor(private instanceSettings: DataSourceInstanceSettings<AzureDataSourceJsonData>) {\n    super(instanceSettings);\n    this.cache = new Map();\n\n    this.resourcePath = `${routeNames.logAnalytics}`;\n    this.azureMonitorPath = `${routeNames.azureMonitor}/subscriptions`;\n    const cloud = getAzureCloud(instanceSettings);\n    this.azurePortalUrl = getAzurePortalUrl(cloud);\n\n    this.defaultSubscriptionId = this.instanceSettings.jsonData.subscriptionId || '';\n  }\n\n  isConfigured(): boolean {\n    // If validation didn't return any error then the data source is properly configured\n    return !this.validateDatasource();\n  }\n\n  filterQuery(item: AzureMonitorQuery): boolean {\n    return item.hide !== true && !!item.azureLogAnalytics?.query && !!item.azureLogAnalytics.resource;\n  }\n\n  async getSubscriptions(): Promise<Array<{ text: string; value: string }>> {\n    if (!this.isConfigured()) {\n      return [];\n    }\n\n    const path = `${this.azureMonitorPath}?api-version=2019-03-01`;\n    return await this.getResource(path).then((result: any) => {\n      return ResponseParser.parseSubscriptions(result);\n    });\n  }\n\n  async getWorkspaces(subscription: string): Promise<AzureLogsVariable[]> {\n    const response = await this.getWorkspaceList(subscription);\n\n    return (\n      map(response.value, (val: any) => {\n        return {\n          text: val.name,\n          value: val.id,\n        };\n      }) || []\n    );\n  }\n\n  private getWorkspaceList(subscription: string): Promise<any> {\n    const subscriptionId = getTemplateSrv().replace(subscription || this.defaultSubscriptionId);\n\n    const workspaceListUrl =\n      this.azureMonitorPath +\n      `/${subscriptionId}/providers/Microsoft.OperationalInsights/workspaces?api-version=2017-04-26-preview`;\n    return this.getResource(workspaceListUrl);\n  }\n\n  async getMetadata(resourceUri: string) {\n    const path = `${this.resourcePath}/v1${resourceUri}/metadata`;\n\n    const resp = await this.getResource(path);\n    return resp;\n  }\n\n  async getKustoSchema(resourceUri: string) {\n    const metadata = await this.getMetadata(resourceUri);\n    return transformMetadataToKustoSchema(metadata, resourceUri);\n  }\n\n  applyTemplateVariables(target: AzureMonitorQuery, scopedVars: ScopedVars): AzureMonitorQuery {\n    const item = target.azureLogAnalytics;\n    if (!item) {\n      return target;\n    }\n\n    const templateSrv = getTemplateSrv();\n    const resource = templateSrv.replace(item.resource, scopedVars);\n    let workspace = templateSrv.replace(item.workspace, scopedVars);\n\n    if (!workspace && !resource && this.firstWorkspace) {\n      workspace = this.firstWorkspace;\n    }\n\n    const query = templateSrv.replace(item.query, scopedVars, interpolateVariable);\n\n    return {\n      refId: target.refId,\n      queryType: AzureQueryType.LogAnalytics,\n\n      azureLogAnalytics: {\n        resultFormat: item.resultFormat,\n        query,\n        resource,\n\n        // Workspace was removed in Grafana 8, but remains for backwards compat\n        workspace,\n      },\n    };\n  }\n\n  /**\n   * Augment the results with links back to the azure console\n   */\n  query(request: DataQueryRequest<AzureMonitorQuery>): Observable<DataQueryResponse> {\n    return super.query(request).pipe(\n      mergeMap((res: DataQueryResponse) => {\n        return from(this.processResponse(res));\n      })\n    );\n  }\n\n  async processResponse(res: DataQueryResponse): Promise<DataQueryResponse> {\n    if (res.data) {\n      for (const df of res.data) {\n        const encodedQuery = df.meta?.custom?.encodedQuery;\n        if (encodedQuery && encodedQuery.length > 0) {\n          const url = await this.buildDeepLink(df.meta.custom);\n          if (url?.length) {\n            for (const field of df.fields) {\n              field.config.links = [\n                {\n                  url: url,\n                  title: 'View in Azure Portal',\n                  targetBlank: true,\n                },\n              ];\n            }\n          }\n        }\n      }\n    }\n    return res;\n  }\n\n  private async buildDeepLink(customMeta: Record<string, any>) {\n    const base64Enc = encodeURIComponent(customMeta.encodedQuery);\n    const workspaceId = customMeta.workspace;\n    const subscription = customMeta.subscription;\n\n    const details = await this.getWorkspaceDetails(workspaceId);\n    if (!details.workspace || !details.resourceGroup) {\n      return '';\n    }\n\n    const url =\n      `${this.azurePortalUrl}/#blade/Microsoft_OperationsManagementSuite_Workspace/` +\n      `AnalyticsBlade/initiator/AnalyticsShareLinkToQuery/isQueryEditorVisible/true/scope/` +\n      `%7B%22resources%22%3A%5B%7B%22resourceId%22%3A%22%2Fsubscriptions%2F${subscription}` +\n      `%2Fresourcegroups%2F${details.resourceGroup}%2Fproviders%2Fmicrosoft.operationalinsights%2Fworkspaces%2F${details.workspace}` +\n      `%22%7D%5D%7D/query/${base64Enc}/isQueryBase64Compressed/true/timespanInIsoFormat/P1D`;\n    return url;\n  }\n\n  async getWorkspaceDetails(workspaceId: string) {\n    if (!this.defaultSubscriptionId) {\n      return {};\n    }\n    const response = await this.getWorkspaceList(this.defaultSubscriptionId);\n\n    const details = response.value.find((o: any) => {\n      return o.properties.customerId === workspaceId;\n    });\n\n    if (!details) {\n      return {};\n    }\n\n    const regex = /.*resourcegroups\\/(.*)\\/providers.*/;\n    const results = regex.exec(details.id);\n    if (!results || results.length < 2) {\n      return {};\n    }\n\n    return {\n      workspace: details.name,\n      resourceGroup: results[1],\n    };\n  }\n\n  /*\n    In 7.5.x it used to be possible to set a default workspace id in the config on the auth page.\n    This has been deprecated, however is still used by a few legacy template queries.\n  */\n  getDeprecatedDefaultWorkSpace() {\n    return this.instanceSettings.jsonData.logAnalyticsDefaultWorkspace;\n  }\n\n  private buildQuery(query: string, options: any, workspace: string): AdhocQuery[] {\n    const querystringBuilder = new LogAnalyticsQuerystringBuilder(\n      getTemplateSrv().replace(query, {}, interpolateVariable),\n      options,\n      'TimeGenerated'\n    );\n\n    const querystring = querystringBuilder.generate().uriString;\n    const path = isGUIDish(workspace)\n      ? `${this.resourcePath}/v1/workspaces/${workspace}/query?${querystring}`\n      : `${this.resourcePath}/v1${workspace}/query?${querystring}`;\n\n    const queries = [\n      {\n        datasource: this.getRef(),\n        path: path,\n        resultFormat: 'table',\n      },\n    ];\n\n    return queries;\n  }\n\n  async getDefaultOrFirstSubscription(): Promise<string | undefined> {\n    if (this.defaultSubscriptionId) {\n      return this.defaultSubscriptionId;\n    }\n    const subscriptions = await this.getSubscriptions();\n    return subscriptions[0]?.value;\n  }\n\n  async getFirstWorkspace(): Promise<string | undefined> {\n    if (this.firstWorkspace) {\n      return this.firstWorkspace;\n    }\n\n    const subscriptionId = await this.getDefaultOrFirstSubscription();\n    if (!subscriptionId) {\n      return undefined;\n    }\n\n    const workspaces = await this.getWorkspaces(subscriptionId);\n    const workspace = workspaces[0]?.value;\n\n    if (workspace) {\n      this.firstWorkspace = workspace;\n    }\n\n    return workspace;\n  }\n\n  annotationQuery(options: any) {\n    if (!options.annotation.rawQuery) {\n      return Promise.reject({\n        message: 'Query missing in annotation definition',\n      });\n    }\n\n    const queries = this.buildQuery(options.annotation.rawQuery, options, options.annotation.workspace);\n    const promises = this.doQueries(queries);\n\n    return Promise.all(promises).then((results) => {\n      const annotations = new ResponseParser(results).transformToAnnotations(options);\n      return annotations;\n    });\n  }\n\n  doQueries(queries: AdhocQuery[]) {\n    return map(queries, (query) => {\n      return this.getResource(query.path)\n        .then((result: any) => {\n          return {\n            result: result,\n            query: query,\n          };\n        })\n        .catch((err: any) => {\n          throw {\n            error: err,\n            query: query,\n          };\n        });\n    });\n  }\n\n  async testDatasource(): Promise<DatasourceValidationResult> {\n    const validationError = this.validateDatasource();\n    if (validationError) {\n      return validationError;\n    }\n\n    let resourceOrWorkspace: string;\n    try {\n      const result = await this.getFirstWorkspace();\n      if (!result) {\n        return {\n          status: 'error',\n          message: 'Workspace not found.',\n        };\n      }\n      resourceOrWorkspace = result;\n    } catch (e) {\n      let message = 'Azure Log Analytics requires access to Azure Monitor but had the following error: ';\n      return {\n        status: 'error',\n        message: this.getErrorMessage(message, e),\n      };\n    }\n\n    try {\n      const path = isGUIDish(resourceOrWorkspace)\n        ? `${this.resourcePath}/v1/workspaces/${resourceOrWorkspace}/metadata`\n        : `${this.resourcePath}/v1${resourceOrWorkspace}/metadata`;\n\n      return await this.getResource(path).then<DatasourceValidationResult>((response: any) => {\n        return {\n          status: 'success',\n          message: 'Successfully queried the Azure Log Analytics service.',\n          title: 'Success',\n        };\n      });\n    } catch (e) {\n      let message = 'Azure Log Analytics: ';\n      return {\n        status: 'error',\n        message: this.getErrorMessage(message, e),\n      };\n    }\n  }\n\n  private getErrorMessage(message: string, error: any) {\n    message += error.statusText ? error.statusText + ': ' : '';\n    if (error.data && error.data.error && error.data.error.code) {\n      message += error.data.error.code + '. ' + error.data.error.message;\n    } else if (error.data && error.data.error) {\n      message += error.data.error;\n    } else if (error.data) {\n      message += error.data;\n    } else {\n      message += 'Cannot connect to Azure Log Analytics REST API.';\n    }\n    return message;\n  }\n\n  private validateDatasource(): DatasourceValidationResult | undefined {\n    const authType = getAuthType(this.instanceSettings);\n\n    if (authType === 'clientsecret') {\n      if (!this.isValidConfigField(this.instanceSettings.jsonData.tenantId)) {\n        return {\n          status: 'error',\n          message: 'The Tenant Id field is required.',\n        };\n      }\n\n      if (!this.isValidConfigField(this.instanceSettings.jsonData.clientId)) {\n        return {\n          status: 'error',\n          message: 'The Client Id field is required.',\n        };\n      }\n    }\n\n    return undefined;\n  }\n\n  private isValidConfigField(field: string | undefined): boolean {\n    return typeof field === 'string' && field.length > 0;\n  }\n}\n","import { ScopedVars, DataSourceInstanceSettings } from '@grafana/data';\nimport { getTemplateSrv } from '@grafana/runtime';\n\nimport { AzureDataSourceJsonData, AzureMonitorQuery, AzureQueryType } from '../types';\nimport AppInsightsDatasource from '../app_insights/app_insights_datasource';\n\nexport default class InsightsAnalyticsDatasource extends AppInsightsDatasource {\n  constructor(instanceSettings: DataSourceInstanceSettings<AzureDataSourceJsonData>) {\n    super(instanceSettings);\n  }\n\n  applyTemplateVariables(target: AzureMonitorQuery, scopedVars: ScopedVars): AzureMonitorQuery {\n    const item = target.insightsAnalytics;\n    if (!item) {\n      return target;\n    }\n\n    const query = item.rawQueryString && !item.query ? item.rawQueryString : item.query;\n\n    return {\n      refId: target.refId,\n      queryType: AzureQueryType.InsightsAnalytics,\n      insightsAnalytics: {\n        query: getTemplateSrv().replace(query, scopedVars),\n        resultFormat: item.resultFormat,\n      },\n    };\n  }\n}\n","// eslint-disable-next-line lodash/import-scope\nimport _ from 'lodash';\nimport { AzureMonitorQuery, AzureDataSourceJsonData, AzureQueryType } from '../types';\nimport { ScopedVars } from '@grafana/data';\nimport { getTemplateSrv, DataSourceWithBackend } from '@grafana/runtime';\nimport { interpolateVariable } from '../utils/common';\n\nexport default class AzureResourceGraphDatasource extends DataSourceWithBackend<\n  AzureMonitorQuery,\n  AzureDataSourceJsonData\n> {\n  filterQuery(item: AzureMonitorQuery): boolean {\n    return !!item.azureResourceGraph?.query;\n  }\n\n  applyTemplateVariables(target: AzureMonitorQuery, scopedVars: ScopedVars): AzureMonitorQuery {\n    const item = target.azureResourceGraph;\n    if (!item) {\n      return target;\n    }\n\n    const templateSrv = getTemplateSrv();\n    const variableNames = templateSrv.getVariables().map((v) => `$${v.name}`);\n    const subscriptionVar = _.find(target.subscriptions, (sub) => _.includes(variableNames, sub));\n    const interpolatedSubscriptions = templateSrv\n      .replace(subscriptionVar, scopedVars, (v: any) => v)\n      .split(',')\n      .filter((v) => v.length > 0);\n    const subscriptions = [\n      ...interpolatedSubscriptions,\n      ..._.filter(target.subscriptions, (sub) => !_.includes(variableNames, sub)),\n    ];\n    const query = templateSrv.replace(item.query, scopedVars, interpolateVariable);\n\n    return {\n      refId: target.refId,\n      queryType: AzureQueryType.AzureResourceGraph,\n      subscriptions,\n      azureResourceGraph: {\n        resultFormat: 'table',\n        query,\n      },\n    };\n  }\n}\n","import { AzureMonitorQuery, AzureQueryType } from '../types';\nimport { AnnotationQuery } from '@grafana/data';\n\n// The old Angular annotations editor put some properties (rawQuery, workspace, subscription)\n// on the root annotation object, rather than down in the 'targets' query value\n// This migration moves them to a Log Analytics query compatible with the React query editor\n// The old Angular annotations editor did not support any other query types.\nexport default function migrateAnnotation(annotation: AnnotationQuery<AzureMonitorQuery>) {\n  const oldQuery = typeof annotation.rawQuery === 'string' ? annotation.rawQuery : null;\n  const oldWorkspace = typeof annotation.workspace === 'string' ? annotation.workspace : null;\n\n  if (!(oldQuery && oldWorkspace && !annotation.target?.azureLogAnalytics?.query)) {\n    return annotation;\n  }\n\n  const newQuery: AzureMonitorQuery = {\n    ...(annotation.target ?? {}),\n    refId: annotation.target?.refId ?? 'Anno',\n    queryType: AzureQueryType.LogAnalytics,\n    azureLogAnalytics: {\n      query: oldQuery,\n      resource: oldWorkspace,\n    },\n  };\n\n  return {\n    ...annotation,\n    rawQuery: undefined,\n    workspace: undefined,\n    subscription: undefined,\n    queryType: undefined,\n    target: newQuery,\n  };\n}\n","import { AzureMonitorQuery, AzureQueryType } from './types';\nimport DataSource from './datasource';\nimport {\n  AppInsightsGroupByQuery,\n  AppInsightsMetricNameQuery,\n  GrafanaTemplateVariableQuery,\n  MetricDefinitionsQuery,\n  MetricNamespaceQuery,\n  MetricNamesQuery,\n  ResourceGroupsQuery,\n  ResourceNamesQuery,\n  SubscriptionsQuery,\n  WorkspacesQuery,\n} from './types/templateVariables';\nimport { isGUIDish } from './components/ResourcePicker/utils';\n\n/* \n  Grafana Template Variable Functions\n  ex: Subscriptions()\n\n  These are helper functions we have created and exposed to users to make the writing of template variables easier. \n  Due to legacy reasons, we still need to parse strings to determine if a query is a Grafana Template Variable Function \n  or if it's a KQL-type query\n*/\n\nexport const grafanaTemplateVariableFnMatches = (query: string) => {\n  return {\n    subscriptions: query.match(/^Subscriptions\\(\\)/i),\n    resourceGroups: query.match(/^ResourceGroups\\(\\)/i),\n    resourceGroupsWithSub: query.match(/^ResourceGroups\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/i),\n    metricDefinitions: query.match(/^Namespaces\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/i),\n    metricDefinitionsWithSub: query.match(/^Namespaces\\(([^,]+?),\\s?([^,]+?)\\)/i),\n    resourceNames: query.match(/^ResourceNames\\(([^,]+?),\\s?([^,]+?)\\)/i),\n    resourceNamesWithSub: query.match(/^ResourceNames\\(([^,]+?),\\s?([^,]+?),\\s?(.+?)\\)/i),\n    metricNamespace: query.match(/^MetricNamespace\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?)\\)/i),\n    metricNamespaceWithSub: query.match(/^metricnamespace\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)\\)/i),\n    metricNames: query.match(/^MetricNames\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)\\)/i),\n    metricNamesWithSub: query.match(/^MetricNames\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?(.+?)\\)/i),\n    appInsightsMetricNameQuery: query.match(/^AppInsightsMetricNames\\(\\)/i),\n    appInsightsGroupByQuery: query.match(/^AppInsightsGroupBys\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/i),\n    workspacesQuery: query.match(/^workspaces\\(\\)/i),\n    workspacesQueryWithSub: query.match(/^workspaces\\([\"']?([^\\)]+?)[\"']?\\)/i),\n  };\n};\n\nconst isGrafanaTemplateVariableFnQuery = (query: string) => {\n  const matches: Record<string, RegExpMatchArray | null> = grafanaTemplateVariableFnMatches(query);\n  return Object.keys(matches).some((key) => !!matches[key]);\n};\n\nconst createGrafanaTemplateVariableQuery = (rawQuery: string, datasource: DataSource): AzureMonitorQuery => {\n  const matchesForQuery = grafanaTemplateVariableFnMatches(rawQuery);\n  const defaultSubscriptionId = datasource.azureMonitorDatasource.defaultSubscriptionId;\n  const createGrafanaTemplateVariableDetails = (): GrafanaTemplateVariableQuery => {\n    // deprecated app insights template variables (will most likely remove in grafana 9)\n    if (matchesForQuery.appInsightsMetricNameQuery) {\n      const queryDetails: AppInsightsMetricNameQuery = { rawQuery, kind: 'AppInsightsMetricNameQuery' };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.appInsightsGroupByQuery) {\n      const queryDetails: AppInsightsGroupByQuery = {\n        kind: 'AppInsightsGroupByQuery',\n        rawQuery,\n        metricName: matchesForQuery.appInsightsGroupByQuery[1],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.subscriptions) {\n      const queryDetails: SubscriptionsQuery = {\n        kind: 'SubscriptionsQuery',\n        rawQuery,\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.resourceGroupsWithSub) {\n      const queryDetails: ResourceGroupsQuery = {\n        kind: 'ResourceGroupsQuery',\n        rawQuery,\n        subscription: matchesForQuery.resourceGroupsWithSub[1],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.resourceGroups && defaultSubscriptionId) {\n      const queryDetails: ResourceGroupsQuery = {\n        kind: 'ResourceGroupsQuery',\n        rawQuery,\n        subscription: defaultSubscriptionId,\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.metricDefinitionsWithSub) {\n      const queryDetails: MetricDefinitionsQuery = {\n        kind: 'MetricDefinitionsQuery',\n        rawQuery,\n        subscription: matchesForQuery.metricDefinitionsWithSub[1],\n        resourceGroup: matchesForQuery.metricDefinitionsWithSub[2],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.metricDefinitions && defaultSubscriptionId) {\n      const queryDetails: MetricDefinitionsQuery = {\n        kind: 'MetricDefinitionsQuery',\n        rawQuery,\n        subscription: defaultSubscriptionId,\n        resourceGroup: matchesForQuery.metricDefinitions[1],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.resourceNamesWithSub) {\n      const queryDetails: ResourceNamesQuery = {\n        kind: 'ResourceNamesQuery',\n        rawQuery,\n        subscription: matchesForQuery.resourceNamesWithSub[1],\n        resourceGroup: matchesForQuery.resourceNamesWithSub[2],\n        metricDefinition: matchesForQuery.resourceNamesWithSub[3],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.resourceNames && defaultSubscriptionId) {\n      const queryDetails: ResourceNamesQuery = {\n        kind: 'ResourceNamesQuery',\n        rawQuery,\n        subscription: defaultSubscriptionId,\n        resourceGroup: matchesForQuery.resourceNames[1],\n        metricDefinition: matchesForQuery.resourceNames[2],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.metricNamespaceWithSub) {\n      const queryDetails: MetricNamespaceQuery = {\n        kind: 'MetricNamespaceQuery',\n        rawQuery,\n        subscription: matchesForQuery.metricNamespaceWithSub[1],\n        resourceGroup: matchesForQuery.metricNamespaceWithSub[2],\n        metricDefinition: matchesForQuery.metricNamespaceWithSub[3],\n        resourceName: matchesForQuery.metricNamespaceWithSub[4],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.metricNamespace && defaultSubscriptionId) {\n      const queryDetails: MetricNamespaceQuery = {\n        kind: 'MetricNamespaceQuery',\n        rawQuery,\n        subscription: defaultSubscriptionId,\n        resourceGroup: matchesForQuery.metricNamespace[1],\n        metricDefinition: matchesForQuery.metricNamespace[2],\n        resourceName: matchesForQuery.metricNamespace[3],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.metricNames && defaultSubscriptionId) {\n      if (matchesForQuery.metricNames[3].indexOf(',') === -1) {\n        const queryDetails: MetricNamesQuery = {\n          kind: 'MetricNamesQuery',\n          rawQuery,\n          subscription: defaultSubscriptionId,\n          resourceGroup: matchesForQuery.metricNames[1],\n          metricDefinition: matchesForQuery.metricNames[2],\n          resourceName: matchesForQuery.metricNames[3],\n          metricNamespace: matchesForQuery.metricNames[4],\n        };\n        return queryDetails;\n      }\n    }\n\n    if (matchesForQuery.metricNamesWithSub) {\n      const queryDetails: MetricNamesQuery = {\n        kind: 'MetricNamesQuery',\n        rawQuery,\n        subscription: matchesForQuery.metricNamesWithSub[1],\n        resourceGroup: matchesForQuery.metricNamesWithSub[2],\n        metricDefinition: matchesForQuery.metricNamesWithSub[3],\n        resourceName: matchesForQuery.metricNamesWithSub[4],\n        metricNamespace: matchesForQuery.metricNamesWithSub[5],\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.workspacesQueryWithSub) {\n      const queryDetails: WorkspacesQuery = {\n        kind: 'WorkspacesQuery',\n        rawQuery,\n        subscription: (matchesForQuery.workspacesQueryWithSub[1] || '').trim(),\n      };\n      return queryDetails;\n    }\n\n    if (matchesForQuery.workspacesQuery && defaultSubscriptionId) {\n      const queryDetails: WorkspacesQuery = {\n        kind: 'WorkspacesQuery',\n        rawQuery,\n        subscription: defaultSubscriptionId,\n      };\n      return queryDetails;\n    }\n\n    // fallback\n    const queryDetails: SubscriptionsQuery = { kind: 'SubscriptionsQuery', rawQuery };\n    return queryDetails;\n  };\n\n  const query: AzureMonitorQuery = {\n    refId: 'A',\n    queryType: AzureQueryType.GrafanaTemplateVariableFn,\n    grafanaTemplateVariableFn: createGrafanaTemplateVariableDetails(),\n    subscription: defaultSubscriptionId,\n  };\n  return query;\n};\n\nconst createLogAnalyticsTemplateVariableQuery = async (\n  rawQuery: string,\n  datasource: DataSource\n): Promise<AzureMonitorQuery> => {\n  const defaultSubscriptionId = datasource.azureMonitorDatasource.defaultSubscriptionId;\n  let resource = '';\n  // if there's an existing query, we try to get the resourcesuri from a deprecated default workspace\n  // a note this is very similar logic to what is used in useMigrations but moved out of the react-hook land\n  if (rawQuery) {\n    const defaultWorkspaceId = datasource.azureLogAnalyticsDatasource.getDeprecatedDefaultWorkSpace();\n    if (defaultWorkspaceId) {\n      const isWorkspaceGUID = isGUIDish(defaultWorkspaceId);\n      if (isWorkspaceGUID) {\n        resource = await datasource.resourcePickerData.getResourceURIFromWorkspace(defaultWorkspaceId);\n      } else {\n        resource = defaultWorkspaceId;\n      }\n    } else {\n      const maybeFirstWorkspace = await datasource.azureLogAnalyticsDatasource.getFirstWorkspace();\n      resource = maybeFirstWorkspace || '';\n    }\n  }\n\n  return {\n    refId: 'A',\n    queryType: AzureQueryType.LogAnalytics,\n    azureLogAnalytics: {\n      query: rawQuery,\n      resource,\n    },\n    subscription: defaultSubscriptionId,\n  };\n};\n\nexport const migrateStringQueriesToObjectQueries = async (\n  rawQuery: string | AzureMonitorQuery,\n  options: { datasource: DataSource }\n): Promise<AzureMonitorQuery> => {\n  // no need to migrate already migrated queries\n  if (typeof rawQuery !== 'string') {\n    return rawQuery;\n  }\n\n  return isGrafanaTemplateVariableFnQuery(rawQuery)\n    ? createGrafanaTemplateVariableQuery(rawQuery, options.datasource)\n    : createLogAnalyticsTemplateVariableQuery(rawQuery, options.datasource);\n};\n","import { SelectableValue } from '@grafana/data';\nimport { Alert, InlineField, Input, Select } from '@grafana/ui';\nimport React, { ChangeEvent, useCallback, useEffect, useState } from 'react';\nimport { AzureMonitorQuery, AzureQueryType } from '../../types';\nimport LogsQueryEditor from '../LogsQueryEditor';\nimport DataSource from '../../datasource';\nimport useLastError from '../../utils/useLastError';\nimport { Space } from '../Space';\nimport { migrateStringQueriesToObjectQueries } from '../../grafanaTemplateVariableFns';\n\nconst AZURE_QUERY_VARIABLE_TYPE_OPTIONS = [\n  { label: 'Grafana Query Function', value: AzureQueryType.GrafanaTemplateVariableFn },\n  { label: 'Logs', value: AzureQueryType.LogAnalytics },\n];\n\nconst GrafanaTemplateVariableFnInput = ({\n  query,\n  updateQuery,\n  datasource,\n}: {\n  query: AzureMonitorQuery;\n  updateQuery: (val: AzureMonitorQuery) => void;\n  datasource: DataSource;\n}) => {\n  const [inputVal, setInputVal] = useState('');\n  useEffect(() => {\n    setInputVal(query.grafanaTemplateVariableFn?.rawQuery || '');\n  }, [query.grafanaTemplateVariableFn?.rawQuery]);\n\n  const onRunQuery = useCallback(\n    (newQuery: string) => {\n      migrateStringQueriesToObjectQueries(newQuery, { datasource }).then((updatedQuery) => {\n        if (updatedQuery.queryType === AzureQueryType.GrafanaTemplateVariableFn) {\n          updateQuery(updatedQuery);\n        } else {\n          updateQuery({\n            ...query,\n            grafanaTemplateVariableFn: {\n              kind: 'UnknownQuery',\n              rawQuery: newQuery,\n            },\n          });\n        }\n      });\n    },\n    [datasource, query, updateQuery]\n  );\n\n  const onChange = (event: ChangeEvent<HTMLInputElement>) => {\n    setInputVal(event.target.value);\n  };\n\n  return (\n    <InlineField label=\"Grafana template variable function\">\n      <Input\n        placeholder={'type a grafana template variable function, ex: Subscriptions()'}\n        value={inputVal}\n        onChange={onChange}\n        onBlur={() => onRunQuery(inputVal)}\n      />\n    </InlineField>\n  );\n};\n\ntype Props = {\n  query: AzureMonitorQuery | string;\n  onChange: (query: AzureMonitorQuery) => void;\n  datasource: DataSource;\n};\n\nconst VariableEditor = (props: Props) => {\n  const defaultQuery: AzureMonitorQuery = {\n    refId: 'A',\n    queryType: AzureQueryType.GrafanaTemplateVariableFn,\n  };\n  const [query, setQuery] = useState(defaultQuery);\n\n  useEffect(() => {\n    migrateStringQueriesToObjectQueries(props.query, { datasource: props.datasource }).then((migratedQuery) => {\n      setQuery(migratedQuery);\n    });\n  }, [props.query, props.datasource]);\n\n  const onQueryTypeChange = (selectableValue: SelectableValue) => {\n    if (selectableValue.value) {\n      setQuery({\n        ...query,\n        queryType: selectableValue.value,\n      });\n    }\n  };\n  const onLogsQueryChange = (queryChange: AzureMonitorQuery) => {\n    setQuery(queryChange);\n\n    // only hit backend if there's something to query (prevents error when selecting the resource before pinging a query)\n    if (queryChange.azureLogAnalytics?.query) {\n      props.onChange(queryChange);\n    }\n  };\n\n  const [errorMessage, setError] = useLastError();\n\n  const variableOptionGroup = {\n    label: 'Template Variables',\n    // TODO: figure out a way to filter out the current variable from the variables list\n    // options: props.datasource.getVariables().map((v) => ({ label: v, value: v })),\n    options: [],\n  };\n\n  return (\n    <>\n      <InlineField label=\"Select query type\">\n        <Select\n          aria-label=\"select query type\"\n          onChange={onQueryTypeChange}\n          options={AZURE_QUERY_VARIABLE_TYPE_OPTIONS}\n          width={25}\n          value={query.queryType}\n        />\n      </InlineField>\n      {query.queryType === AzureQueryType.LogAnalytics && (\n        <>\n          <LogsQueryEditor\n            subscriptionId={query.subscription}\n            query={query}\n            datasource={props.datasource}\n            onChange={onLogsQueryChange}\n            variableOptionGroup={variableOptionGroup}\n            setError={setError}\n            hideFormatAs={true}\n          />\n          {errorMessage && (\n            <>\n              <Space v={2} />\n              <Alert severity=\"error\" title=\"An error occurred while requesting metadata from Azure Monitor\">\n                {errorMessage}\n              </Alert>\n            </>\n          )}\n        </>\n      )}\n      {query.queryType === AzureQueryType.GrafanaTemplateVariableFn && (\n        <GrafanaTemplateVariableFnInput query={query} updateQuery={props.onChange} datasource={props.datasource} />\n      )}\n    </>\n  );\n};\n\nexport default VariableEditor;\n","import { from, lastValueFrom, Observable } from 'rxjs';\nimport {\n  CustomVariableSupport,\n  DataQueryRequest,\n  DataQueryResponse,\n  MetricFindValue,\n  toDataFrame,\n} from '@grafana/data';\nimport VariableEditor from './components/VariableEditor/VariableEditor';\nimport DataSource from './datasource';\nimport { AzureQueryType, AzureMonitorQuery } from './types';\nimport { getTemplateSrv } from '@grafana/runtime';\nimport { migrateStringQueriesToObjectQueries } from './grafanaTemplateVariableFns';\nimport { GrafanaTemplateVariableQuery } from './types/templateVariables';\nimport messageFromError from './utils/messageFromError';\nexport class VariableSupport extends CustomVariableSupport<DataSource, AzureMonitorQuery> {\n  constructor(private readonly datasource: DataSource) {\n    super();\n    this.datasource = datasource;\n    this.query = this.query.bind(this);\n  }\n\n  editor = VariableEditor;\n\n  query(request: DataQueryRequest<AzureMonitorQuery>): Observable<DataQueryResponse> {\n    const promisedResults = async () => {\n      const queryObj = await migrateStringQueriesToObjectQueries(request.targets[0], { datasource: this.datasource });\n\n      if (queryObj.queryType === AzureQueryType.GrafanaTemplateVariableFn && queryObj.grafanaTemplateVariableFn) {\n        try {\n          const templateVariablesResults = await this.callGrafanaTemplateVariableFn(queryObj.grafanaTemplateVariableFn);\n          return {\n            data: templateVariablesResults ? [toDataFrame(templateVariablesResults)] : [],\n          };\n        } catch (err) {\n          return { data: [], error: { message: messageFromError(err) } };\n        }\n      }\n      request.targets[0] = queryObj;\n      return lastValueFrom(this.datasource.query(request));\n    };\n\n    return from(promisedResults());\n  }\n\n  callGrafanaTemplateVariableFn(query: GrafanaTemplateVariableQuery): Promise<MetricFindValue[]> | null {\n    // deprecated app insights template variables (will most likely remove in grafana 9)\n    if (this.datasource.insightsAnalyticsDatasource) {\n      if (query.kind === 'AppInsightsMetricNameQuery') {\n        return this.datasource.insightsAnalyticsDatasource.getMetricNames();\n      }\n\n      if (query.kind === 'AppInsightsGroupByQuery') {\n        return this.datasource.insightsAnalyticsDatasource.getGroupBys(getTemplateSrv().replace(query.metricName));\n      }\n    }\n\n    if (query.kind === 'SubscriptionsQuery') {\n      return this.datasource.getSubscriptions();\n    }\n\n    if (query.kind === 'ResourceGroupsQuery') {\n      return this.datasource.getResourceGroups(this.replaceVariable(query.subscription));\n    }\n\n    if (query.kind === 'MetricDefinitionsQuery') {\n      return this.datasource.getMetricDefinitions(\n        this.replaceVariable(query.subscription),\n        this.replaceVariable(query.resourceGroup)\n      );\n    }\n\n    if (query.kind === 'ResourceNamesQuery') {\n      return this.datasource.getResourceNames(\n        this.replaceVariable(query.subscription),\n        this.replaceVariable(query.resourceGroup),\n        this.replaceVariable(query.metricDefinition)\n      );\n    }\n\n    if (query.kind === 'MetricNamespaceQuery') {\n      return this.datasource.getMetricNamespaces(\n        this.replaceVariable(query.subscription),\n        this.replaceVariable(query.resourceGroup),\n        this.replaceVariable(query.metricDefinition),\n        this.replaceVariable(query.resourceName)\n      );\n    }\n\n    if (query.kind === 'MetricNamesQuery') {\n      return this.datasource.getMetricNames(\n        this.replaceVariable(query.subscription),\n        this.replaceVariable(query.resourceGroup),\n        this.replaceVariable(query.metricDefinition),\n        this.replaceVariable(query.resourceName),\n        this.replaceVariable(query.metricNamespace)\n      );\n    }\n\n    if (query.kind === 'WorkspacesQuery') {\n      return this.datasource.azureLogAnalyticsDatasource.getWorkspaces(this.replaceVariable(query.subscription));\n    }\n\n    return null;\n  }\n\n  replaceVariable(metric: string) {\n    return getTemplateSrv().replace((metric || '').trim());\n  }\n}\n","import { cloneDeep, upperFirst } from 'lodash';\nimport AzureMonitorDatasource from './azure_monitor/azure_monitor_datasource';\nimport AppInsightsDatasource from './app_insights/app_insights_datasource';\nimport AzureLogAnalyticsDatasource from './azure_log_analytics/azure_log_analytics_datasource';\nimport ResourcePickerData from './resourcePicker/resourcePickerData';\nimport { AzureDataSourceJsonData, AzureMonitorQuery, AzureQueryType, DatasourceValidationResult } from './types';\nimport {\n  DataFrame,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataSourceApi,\n  DataSourceInstanceSettings,\n  LoadingState,\n  ScopedVars,\n} from '@grafana/data';\nimport { forkJoin, Observable, of } from 'rxjs';\nimport { getTemplateSrv, TemplateSrv } from 'app/features/templating/template_srv';\nimport InsightsAnalyticsDatasource from './insights_analytics/insights_analytics_datasource';\nimport { datasourceMigrations } from './utils/migrateQuery';\nimport { map } from 'rxjs/operators';\nimport AzureResourceGraphDatasource from './azure_resource_graph/azure_resource_graph_datasource';\nimport { getAzureCloud } from './credentials';\nimport migrateAnnotation from './utils/migrateAnnotation';\nimport { VariableSupport } from './variables';\nexport default class Datasource extends DataSourceApi<AzureMonitorQuery, AzureDataSourceJsonData> {\n  annotations = {\n    prepareAnnotation: migrateAnnotation,\n  };\n\n  azureMonitorDatasource: AzureMonitorDatasource;\n  azureLogAnalyticsDatasource: AzureLogAnalyticsDatasource;\n  resourcePickerData: ResourcePickerData;\n  azureResourceGraphDatasource: AzureResourceGraphDatasource;\n  /** @deprecated */\n  appInsightsDatasource?: AppInsightsDatasource;\n  /** @deprecated */\n  insightsAnalyticsDatasource?: InsightsAnalyticsDatasource;\n\n  pseudoDatasource: {\n    [key in AzureQueryType]?:\n      | AzureMonitorDatasource\n      | AzureLogAnalyticsDatasource\n      | AzureResourceGraphDatasource\n      | AppInsightsDatasource\n      | InsightsAnalyticsDatasource;\n  } = {};\n\n  declare optionsKey: Record<AzureQueryType, string>;\n\n  constructor(\n    instanceSettings: DataSourceInstanceSettings<AzureDataSourceJsonData>,\n    private readonly templateSrv: TemplateSrv = getTemplateSrv()\n  ) {\n    super(instanceSettings);\n    this.azureMonitorDatasource = new AzureMonitorDatasource(instanceSettings);\n    this.azureLogAnalyticsDatasource = new AzureLogAnalyticsDatasource(instanceSettings);\n    this.azureResourceGraphDatasource = new AzureResourceGraphDatasource(instanceSettings);\n    this.resourcePickerData = new ResourcePickerData(instanceSettings);\n\n    this.pseudoDatasource = {\n      [AzureQueryType.AzureMonitor]: this.azureMonitorDatasource,\n      [AzureQueryType.LogAnalytics]: this.azureLogAnalyticsDatasource,\n      [AzureQueryType.AzureResourceGraph]: this.azureResourceGraphDatasource,\n    };\n\n    const cloud = getAzureCloud(instanceSettings);\n    if (cloud === 'azuremonitor' || cloud === 'chinaazuremonitor') {\n      // AppInsights and InsightAnalytics are only supported for Public and Azure China clouds\n      this.appInsightsDatasource = new AppInsightsDatasource(instanceSettings);\n      this.insightsAnalyticsDatasource = new InsightsAnalyticsDatasource(instanceSettings);\n      this.pseudoDatasource[AzureQueryType.ApplicationInsights] = this.appInsightsDatasource;\n      this.pseudoDatasource[AzureQueryType.InsightsAnalytics] = this.insightsAnalyticsDatasource;\n    }\n\n    this.variables = new VariableSupport(this);\n  }\n\n  filterQuery(item: AzureMonitorQuery): boolean {\n    if (!item.queryType) {\n      return true;\n    }\n    const ds = this.pseudoDatasource[item.queryType];\n    return ds?.filterQuery?.(item) ?? true;\n  }\n\n  query(options: DataQueryRequest<AzureMonitorQuery>): Observable<DataQueryResponse> {\n    const byType = new Map<AzureQueryType, DataQueryRequest<AzureMonitorQuery>>();\n\n    for (const baseTarget of options.targets) {\n      // Migrate old query structures\n      const target = datasourceMigrations(baseTarget);\n\n      // Skip hidden or invalid queries or ones without properties\n      if (!target.queryType || target.hide || !hasQueryForType(target)) {\n        continue;\n      }\n\n      // Initialize the list of queries\n      if (!byType.has(target.queryType)) {\n        const queryForType = cloneDeep(options);\n        queryForType.requestId = `${queryForType.requestId}-${target.refId}`;\n        queryForType.targets = [];\n        byType.set(target.queryType, queryForType);\n      }\n\n      const queryForType = byType.get(target.queryType);\n      queryForType?.targets.push(target);\n    }\n\n    const observables: Array<Observable<DataQueryResponse>> = Array.from(byType.entries()).map(([queryType, req]) => {\n      const ds = this.pseudoDatasource[queryType];\n      if (!ds) {\n        throw new Error('Data source not created for query type ' + queryType);\n      }\n\n      return ds.query(req);\n    });\n\n    // Single query can skip merge\n    if (observables.length === 1) {\n      return observables[0];\n    }\n\n    if (observables.length > 1) {\n      return forkJoin(observables).pipe(\n        map((results: DataQueryResponse[]) => {\n          const data: DataFrame[] = [];\n          for (const result of results) {\n            for (const frame of result.data) {\n              data.push(frame);\n            }\n          }\n\n          return { state: LoadingState.Done, data };\n        })\n      );\n    }\n\n    return of({ state: LoadingState.Done, data: [] });\n  }\n\n  targetContainsTemplate(query: AzureMonitorQuery) {\n    if (query.subscription && this.templateSrv.variableExists(query.subscription)) {\n      return true;\n    }\n\n    let subQuery;\n    if (query.queryType === AzureQueryType.AzureMonitor) {\n      subQuery = JSON.stringify(query.azureMonitor);\n    } else if (query.queryType === AzureQueryType.LogAnalytics) {\n      subQuery = JSON.stringify(query.azureLogAnalytics);\n    } else if (query.queryType === AzureQueryType.AzureResourceGraph) {\n      subQuery = JSON.stringify([query.azureResourceGraph, query.subscriptions]);\n    }\n\n    return !!subQuery && this.templateSrv.variableExists(subQuery);\n  }\n\n  async annotationQuery(options: any) {\n    return this.azureLogAnalyticsDatasource.annotationQuery(options);\n  }\n\n  async testDatasource(): Promise<DatasourceValidationResult> {\n    const promises: Array<Promise<DatasourceValidationResult>> = [];\n\n    promises.push(this.azureMonitorDatasource.testDatasource());\n    promises.push(this.azureLogAnalyticsDatasource.testDatasource());\n\n    if (this.appInsightsDatasource?.isConfigured()) {\n      promises.push(this.appInsightsDatasource.testDatasource());\n    }\n\n    return await Promise.all(promises).then((results) => {\n      let status: 'success' | 'error' = 'success';\n      let message = '';\n\n      for (let i = 0; i < results.length; i++) {\n        if (results[i].status !== 'success') {\n          status = results[i].status;\n        }\n        message += `${i + 1}. ${results[i].message} `;\n      }\n\n      return {\n        status: status,\n        message: message,\n        title: upperFirst(status),\n      };\n    });\n  }\n\n  /* Azure Monitor REST API methods */\n  getResourceGroups(subscriptionId: string) {\n    return this.azureMonitorDatasource.getResourceGroups(this.replaceTemplateVariable(subscriptionId));\n  }\n\n  getMetricDefinitions(subscriptionId: string, resourceGroup: string) {\n    return this.azureMonitorDatasource.getMetricDefinitions(\n      this.replaceTemplateVariable(subscriptionId),\n      this.replaceTemplateVariable(resourceGroup)\n    );\n  }\n\n  getResourceNames(subscriptionId: string, resourceGroup: string, metricDefinition: string) {\n    return this.azureMonitorDatasource.getResourceNames(\n      this.replaceTemplateVariable(subscriptionId),\n      this.replaceTemplateVariable(resourceGroup),\n      this.replaceTemplateVariable(metricDefinition)\n    );\n  }\n\n  getMetricNames(\n    subscriptionId: string,\n    resourceGroup: string,\n    metricDefinition: string,\n    resourceName: string,\n    metricNamespace: string\n  ) {\n    return this.azureMonitorDatasource.getMetricNames(\n      this.replaceTemplateVariable(subscriptionId),\n      this.replaceTemplateVariable(resourceGroup),\n      this.replaceTemplateVariable(metricDefinition),\n      this.replaceTemplateVariable(resourceName),\n      this.replaceTemplateVariable(metricNamespace)\n    );\n  }\n\n  getMetricNamespaces(subscriptionId: string, resourceGroup: string, metricDefinition: string, resourceName: string) {\n    return this.azureMonitorDatasource.getMetricNamespaces(\n      this.replaceTemplateVariable(subscriptionId),\n      this.replaceTemplateVariable(resourceGroup),\n      this.replaceTemplateVariable(metricDefinition),\n      this.replaceTemplateVariable(resourceName)\n    );\n  }\n\n  getMetricMetadata(\n    subscriptionId: string,\n    resourceGroup: string,\n    metricDefinition: string,\n    resourceName: string,\n    metricNamespace: string,\n    metricName: string\n  ) {\n    return this.azureMonitorDatasource.getMetricMetadata(\n      this.replaceTemplateVariable(subscriptionId),\n      this.replaceTemplateVariable(resourceGroup),\n      this.replaceTemplateVariable(metricDefinition),\n      this.replaceTemplateVariable(resourceName),\n      this.replaceTemplateVariable(metricNamespace),\n      this.replaceTemplateVariable(metricName)\n    );\n  }\n\n  /* Application Insights API method */\n  getAppInsightsMetricNames() {\n    return this.appInsightsDatasource?.getMetricNames();\n  }\n\n  getAppInsightsMetricMetadata(metricName: string) {\n    return this.appInsightsDatasource?.getMetricMetadata(metricName);\n  }\n\n  getAppInsightsColumns(refId: string | number) {\n    return this.appInsightsDatasource?.logAnalyticsColumns[refId];\n  }\n\n  /*Azure Log Analytics */\n  getAzureLogAnalyticsWorkspaces(subscriptionId: string) {\n    return this.azureLogAnalyticsDatasource.getWorkspaces(subscriptionId);\n  }\n\n  getSubscriptions() {\n    return this.azureMonitorDatasource.getSubscriptions();\n  }\n\n  interpolateVariablesInQueries(queries: AzureMonitorQuery[], scopedVars: ScopedVars): AzureMonitorQuery[] {\n    const mapped = queries.map((query) => {\n      if (!query.queryType) {\n        return query;\n      }\n\n      const ds = this.pseudoDatasource[query.queryType];\n      return ds?.applyTemplateVariables(query, scopedVars) ?? query;\n    });\n\n    return mapped;\n  }\n\n  replaceTemplateVariable(variable: string) {\n    return this.templateSrv.replace(variable);\n  }\n\n  getVariables() {\n    return this.templateSrv.getVariables().map((v) => `$${v.name}`);\n  }\n\n  isTemplateVariable(value: string) {\n    return this.getVariables().includes(value);\n  }\n}\n\nfunction hasQueryForType(query: AzureMonitorQuery): boolean {\n  switch (query.queryType) {\n    case AzureQueryType.AzureMonitor:\n      return !!query.azureMonitor;\n\n    case AzureQueryType.LogAnalytics:\n      return !!query.azureLogAnalytics;\n\n    case AzureQueryType.AzureResourceGraph:\n      return !!query.azureResourceGraph;\n\n    case AzureQueryType.GrafanaTemplateVariableFn:\n      return !!query.grafanaTemplateVariableFn;\n\n    case AzureQueryType.ApplicationInsights:\n      return !!query.appInsights;\n\n    case AzureQueryType.InsightsAnalytics:\n      return !!query.insightsAnalytics;\n\n    default:\n      return false;\n  }\n}\n","import React, { ChangeEvent, FunctionComponent, useEffect, useReducer, useState } from 'react';\nimport { SelectableValue } from '@grafana/data';\nimport { InlineFormLabel, LegacyForms, Button, Select } from '@grafana/ui';\nimport { AzureAuthType, AzureCredentials } from '../types';\nimport { isCredentialsComplete } from '../credentials';\nconst { Input } = LegacyForms;\n\nexport interface Props {\n  managedIdentityEnabled: boolean;\n  credentials: AzureCredentials;\n  azureCloudOptions?: SelectableValue[];\n  onCredentialsChange?: (updatedCredentials: AzureCredentials) => void;\n  getSubscriptions?: () => Promise<SelectableValue[]>;\n  disabled?: boolean;\n  children?: JSX.Element;\n}\n\nconst authTypeOptions: Array<SelectableValue<AzureAuthType>> = [\n  {\n    value: 'msi',\n    label: 'Managed Identity',\n  },\n  {\n    value: 'clientsecret',\n    label: 'App Registration',\n  },\n];\n\nexport const AzureCredentialsForm: FunctionComponent<Props> = (props: Props) => {\n  const { credentials, azureCloudOptions, onCredentialsChange, getSubscriptions, disabled } = props;\n  const hasRequiredFields = isCredentialsComplete(credentials);\n\n  const [subscriptions, setSubscriptions] = useState<Array<SelectableValue<string>>>([]);\n  const [loadSubscriptionsClicked, onLoadSubscriptions] = useReducer((val) => val + 1, 0);\n  useEffect(() => {\n    if (!getSubscriptions || !hasRequiredFields) {\n      updateSubscriptions([]);\n      return;\n    }\n    let canceled = false;\n    getSubscriptions().then((result) => {\n      if (!canceled) {\n        updateSubscriptions(result, loadSubscriptionsClicked);\n      }\n    });\n    return () => {\n      canceled = true;\n    };\n    // This effect is intended to be called only once initially and on Load Subscriptions click\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [loadSubscriptionsClicked]);\n\n  const updateSubscriptions = (received: Array<SelectableValue<string>>, autoSelect = false) => {\n    setSubscriptions(received);\n    if (getSubscriptions) {\n      if (autoSelect && !credentials.defaultSubscriptionId && received.length > 0) {\n        // Selecting the default subscription if subscriptions received but no default subscription selected\n        onSubscriptionChange(received[0]);\n      } else if (credentials.defaultSubscriptionId) {\n        const found = received.find((opt) => opt.value === credentials.defaultSubscriptionId);\n        if (!found) {\n          // Unselecting the default subscription if it isn't found among the received subscriptions\n          onSubscriptionChange(undefined);\n        }\n      }\n    }\n  };\n\n  const onAuthTypeChange = (selected: SelectableValue<AzureAuthType>) => {\n    if (onCredentialsChange) {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        authType: selected.value || 'msi',\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onAzureCloudChange = (selected: SelectableValue<string>) => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        azureCloud: selected.value,\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onTenantIdChange = (event: ChangeEvent<HTMLInputElement>) => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        tenantId: event.target.value,\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onClientIdChange = (event: ChangeEvent<HTMLInputElement>) => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        clientId: event.target.value,\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onClientSecretChange = (event: ChangeEvent<HTMLInputElement>) => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        clientSecret: event.target.value,\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onClientSecretReset = () => {\n    if (onCredentialsChange && credentials.authType === 'clientsecret') {\n      setSubscriptions([]);\n      const updated: AzureCredentials = {\n        ...credentials,\n        clientSecret: '',\n        defaultSubscriptionId: undefined,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  const onSubscriptionChange = (selected: SelectableValue<string> | undefined) => {\n    if (onCredentialsChange) {\n      const updated: AzureCredentials = {\n        ...credentials,\n        defaultSubscriptionId: selected?.value,\n      };\n      onCredentialsChange(updated);\n    }\n  };\n\n  return (\n    <div className=\"gf-form-group\">\n      {props.managedIdentityEnabled && (\n        <div className=\"gf-form-inline\">\n          <div className=\"gf-form\">\n            <InlineFormLabel className=\"width-12\" tooltip=\"Choose the type of authentication to Azure services\">\n              Authentication\n            </InlineFormLabel>\n            <Select\n              menuShouldPortal\n              className=\"width-15\"\n              value={authTypeOptions.find((opt) => opt.value === credentials.authType)}\n              options={authTypeOptions}\n              onChange={onAuthTypeChange}\n              disabled={disabled}\n            />\n          </div>\n        </div>\n      )}\n      {credentials.authType === 'clientsecret' && (\n        <>\n          {azureCloudOptions && (\n            <div className=\"gf-form-inline\">\n              <div className=\"gf-form\">\n                <InlineFormLabel className=\"width-12\" tooltip=\"Choose an Azure Cloud\">\n                  Azure Cloud\n                </InlineFormLabel>\n                <Select\n                  aria-label=\"Azure Cloud\"\n                  menuShouldPortal\n                  className=\"width-15\"\n                  value={azureCloudOptions.find((opt) => opt.value === credentials.azureCloud)}\n                  options={azureCloudOptions}\n                  onChange={onAzureCloudChange}\n                  disabled={disabled}\n                />\n              </div>\n            </div>\n          )}\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineFormLabel className=\"width-12\">Directory (tenant) ID</InlineFormLabel>\n              <div className=\"width-15\">\n                <Input\n                  className=\"width-30\"\n                  placeholder=\"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\"\n                  value={credentials.tenantId || ''}\n                  onChange={onTenantIdChange}\n                  disabled={disabled}\n                />\n              </div>\n            </div>\n          </div>\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineFormLabel className=\"width-12\">Application (client) ID</InlineFormLabel>\n              <div className=\"width-15\">\n                <Input\n                  className=\"width-30\"\n                  placeholder=\"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\"\n                  value={credentials.clientId || ''}\n                  onChange={onClientIdChange}\n                  disabled={disabled}\n                />\n              </div>\n            </div>\n          </div>\n          {!disabled &&\n            (typeof credentials.clientSecret === 'symbol' ? (\n              <div className=\"gf-form-inline\">\n                <div className=\"gf-form\">\n                  <InlineFormLabel className=\"width-12\">Client Secret</InlineFormLabel>\n                  <Input data-testid=\"client-secret\" className=\"width-25\" placeholder=\"configured\" disabled={true} />\n                </div>\n                <div className=\"gf-form\">\n                  <div className=\"max-width-30 gf-form-inline\">\n                    <Button variant=\"secondary\" type=\"button\" onClick={onClientSecretReset} disabled={disabled}>\n                      reset\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            ) : (\n              <div className=\"gf-form-inline\">\n                <div className=\"gf-form\">\n                  <InlineFormLabel className=\"width-12\">Client Secret</InlineFormLabel>\n                  <div className=\"width-15\">\n                    <Input\n                      className=\"width-30\"\n                      placeholder=\"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\"\n                      value={credentials.clientSecret || ''}\n                      onChange={onClientSecretChange}\n                      disabled={disabled}\n                    />\n                  </div>\n                </div>\n              </div>\n            ))}\n        </>\n      )}\n      {getSubscriptions && (\n        <>\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineFormLabel className=\"width-12\">Default Subscription</InlineFormLabel>\n              <div className=\"width-30\">\n                <Select\n                  aria-label=\"Default Subscription\"\n                  menuShouldPortal\n                  value={\n                    credentials.defaultSubscriptionId\n                      ? subscriptions.find((opt) => opt.value === credentials.defaultSubscriptionId)\n                      : undefined\n                  }\n                  options={subscriptions}\n                  onChange={onSubscriptionChange}\n                  disabled={disabled}\n                />\n              </div>\n            </div>\n          </div>\n          {!disabled && (\n            <div className=\"gf-form-inline\">\n              <div className=\"gf-form\">\n                <div className=\"max-width-30 gf-form-inline\">\n                  <Button\n                    variant=\"secondary\"\n                    size=\"sm\"\n                    type=\"button\"\n                    onClick={onLoadSubscriptions}\n                    disabled={!hasRequiredFields}\n                  >\n                    Load Subscriptions\n                  </Button>\n                </div>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n      {props.children}\n    </div>\n  );\n};\n\nexport default AzureCredentialsForm;\n","import React, { FunctionComponent, useMemo } from 'react';\nimport { SelectableValue } from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { AzureCredentialsForm } from './AzureCredentialsForm';\nimport { AzureDataSourceSettings, AzureCredentials } from '../types';\nimport { getCredentials, updateCredentials } from '../credentials';\n\nconst azureClouds = [\n  { value: 'azuremonitor', label: 'Azure' },\n  { value: 'govazuremonitor', label: 'Azure US Government' },\n  { value: 'germanyazuremonitor', label: 'Azure Germany' },\n  { value: 'chinaazuremonitor', label: 'Azure China' },\n] as SelectableValue[];\n\nexport interface Props {\n  options: AzureDataSourceSettings;\n  updateOptions: (optionsFunc: (options: AzureDataSourceSettings) => AzureDataSourceSettings) => void;\n  getSubscriptions: () => Promise<Array<SelectableValue<string>>>;\n}\n\nexport const MonitorConfig: FunctionComponent<Props> = (props: Props) => {\n  const { updateOptions, getSubscriptions } = props;\n  const credentials = useMemo(() => getCredentials(props.options), [props.options]);\n\n  const onCredentialsChange = (credentials: AzureCredentials): void => {\n    updateOptions((options) => updateCredentials(options, credentials));\n  };\n\n  return (\n    <>\n      <h3 className=\"page-heading\">Authentication</h3>\n      <AzureCredentialsForm\n        managedIdentityEnabled={config.azure.managedIdentityEnabled}\n        credentials={credentials}\n        azureCloudOptions={azureClouds}\n        onCredentialsChange={onCredentialsChange}\n        getSubscriptions={getSubscriptions}\n        disabled={props.options.readOnly}\n      />\n    </>\n  );\n};\n\nexport default MonitorConfig;\n","import React, { FunctionComponent, useMemo } from 'react';\nimport { AzureCredentialsForm } from './AzureCredentialsForm';\nimport { Button, Alert } from '@grafana/ui';\nimport { AzureDataSourceSettings } from '../types';\nimport { getCredentials } from '../credentials';\n\nexport interface Props {\n  options: AzureDataSourceSettings;\n  updateOptions: (optionsFunc: (options: AzureDataSourceSettings) => AzureDataSourceSettings) => void;\n}\n\nexport const AnalyticsConfig: FunctionComponent<Props> = (props: Props) => {\n  const { updateOptions } = props;\n  const primaryCredentials = useMemo(() => getCredentials(props.options), [props.options]);\n\n  // Only show a section for setting LogAnalytics credentials if\n  // they were set from before with different values and the\n  // authType is supported\n  const logCredentialsEnabled =\n    primaryCredentials.authType === 'clientsecret' && props.options.jsonData.azureLogAnalyticsSameAs === false;\n\n  const onClearAzLogsCreds = () => {\n    updateOptions((options) => {\n      return {\n        ...options,\n        jsonData: {\n          ...options.jsonData,\n          azureLogAnalyticsSameAs: true,\n        },\n      };\n    });\n  };\n\n  return logCredentialsEnabled ? (\n    <>\n      <h3 className=\"page-heading\">Azure Monitor Logs</h3>\n      <>\n        <Alert severity=\"error\" title=\"Deprecated\">\n          Using different credentials for Azure Monitor Logs is no longer supported. Authentication information above\n          will be used instead. Please create a new data source with the credentials below.\n        </Alert>\n\n        <AzureCredentialsForm\n          managedIdentityEnabled={false}\n          credentials={{\n            ...primaryCredentials,\n            authType: 'clientsecret',\n            // Use deprecated Log Analytics credentials read-only\n            // to help with a possible migration\n            tenantId: props.options.jsonData.logAnalyticsTenantId,\n            clientId: props.options.jsonData.logAnalyticsClientId,\n          }}\n          disabled={true}\n        >\n          <Button onClick={onClearAzLogsCreds}>Clear Azure Monitor Logs Credentials</Button>\n        </AzureCredentialsForm>\n      </>\n    </>\n  ) : null;\n};\n\nexport default AnalyticsConfig;\n","import React, { PureComponent } from 'react';\nimport { InlineFormLabel, Button, LegacyForms, Alert } from '@grafana/ui';\nconst { Input } = LegacyForms;\nimport { AzureDataSourceSettings, AzureDataSourceJsonData, AzureDataSourceSecureJsonData } from '../types';\n\nexport interface Props {\n  options: AzureDataSourceSettings;\n  onUpdateJsonDataOption: (\n    key: keyof AzureDataSourceJsonData\n  ) => (event: React.SyntheticEvent<HTMLInputElement | HTMLSelectElement>) => void;\n  onUpdateSecureJsonDataOption: (\n    key: keyof AzureDataSourceSecureJsonData\n  ) => (event: React.SyntheticEvent<HTMLInputElement | HTMLSelectElement>) => void;\n  onResetOptionKey: (key: keyof AzureDataSourceSecureJsonData) => void;\n}\nexport class InsightsConfig extends PureComponent<Props> {\n  onAppInsightsResetApiKey = () => {\n    this.props.onResetOptionKey('appInsightsApiKey');\n  };\n\n  render() {\n    const { options, onUpdateJsonDataOption, onUpdateSecureJsonDataOption } = this.props;\n    return (\n      <>\n        <h3 className=\"page-heading\">Azure Application Insights</h3>\n        <Alert severity=\"info\" title=\"Application Insights credentials are deprecated\">\n          Configure using Azure AD App Registration above and update existing queries to use Metrics or Logs.\n        </Alert>\n        <div className=\"gf-form-group\">\n          {options.secureJsonFields.appInsightsApiKey ? (\n            <div className=\"gf-form-inline\">\n              <div className=\"gf-form\">\n                <InlineFormLabel className=\"width-12\">API Key</InlineFormLabel>\n                <Input className=\"width-25\" placeholder=\"configured\" disabled={true} />\n              </div>\n              <div className=\"gf-form\">\n                <div className=\"max-width-30 gf-form-inline\">\n                  <Button\n                    variant=\"secondary\"\n                    type=\"button\"\n                    onClick={this.onAppInsightsResetApiKey}\n                    disabled={this.props.options.readOnly}\n                  >\n                    reset\n                  </Button>\n                </div>\n              </div>\n            </div>\n          ) : (\n            <div className=\"gf-form-inline\">\n              <div className=\"gf-form\">\n                <InlineFormLabel className=\"width-12\">API Key</InlineFormLabel>\n                <div className=\"width-15\">\n                  <Input\n                    className=\"width-30\"\n                    placeholder=\"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\"\n                    value={options.secureJsonData!.appInsightsApiKey || ''}\n                    onChange={onUpdateSecureJsonDataOption('appInsightsApiKey')}\n                    disabled={this.props.options.readOnly}\n                  />\n                </div>\n              </div>\n            </div>\n          )}\n          <div className=\"gf-form-inline\">\n            <div className=\"gf-form\">\n              <InlineFormLabel className=\"width-12\">Application ID</InlineFormLabel>\n              <div className=\"width-15\">\n                <Input\n                  className=\"width-30\"\n                  value={options.jsonData.appInsightsAppId || ''}\n                  onChange={onUpdateJsonDataOption('appInsightsAppId')}\n                  disabled={this.props.options.readOnly}\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n      </>\n    );\n  }\n}\n\nexport default InsightsConfig;\n","import React, { PureComponent } from 'react';\nimport {\n  DataSourcePluginOptionsEditorProps,\n  SelectableValue,\n  updateDatasourcePluginJsonDataOption,\n  updateDatasourcePluginOption,\n  updateDatasourcePluginResetOption,\n  updateDatasourcePluginSecureJsonDataOption,\n} from '@grafana/data';\nimport { Alert } from '@grafana/ui';\nimport { MonitorConfig } from './MonitorConfig';\nimport { AnalyticsConfig } from './AnalyticsConfig';\nimport { getBackendSrv, getTemplateSrv, TemplateSrv } from '@grafana/runtime';\nimport { InsightsConfig } from './InsightsConfig';\nimport ResponseParser from '../azure_monitor/response_parser';\nimport { AzureDataSourceJsonData, AzureDataSourceSecureJsonData, AzureDataSourceSettings } from '../types';\nimport { isAppInsightsConfigured } from '../credentials';\nimport { routeNames } from '../utils/common';\n\nexport type Props = DataSourcePluginOptionsEditorProps<AzureDataSourceJsonData, AzureDataSourceSecureJsonData>;\n\ninterface ErrorMessage {\n  title: string;\n  description: string;\n  details?: string;\n}\n\nexport interface State {\n  unsaved: boolean;\n  appInsightsInitiallyConfigured: boolean;\n  error?: ErrorMessage;\n}\n\nexport class ConfigEditor extends PureComponent<Props, State> {\n  templateSrv: TemplateSrv = getTemplateSrv();\n  baseURL: string;\n\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {\n      unsaved: false,\n      appInsightsInitiallyConfigured: isAppInsightsConfigured(props.options),\n    };\n    this.baseURL = `/api/datasources/${this.props.options.id}/resources/${routeNames.azureMonitor}/subscriptions`;\n  }\n\n  private updateOptions = (optionsFunc: (options: AzureDataSourceSettings) => AzureDataSourceSettings): void => {\n    const updated = optionsFunc(this.props.options);\n    this.props.onOptionsChange(updated);\n\n    this.setState({ unsaved: true });\n  };\n\n  private saveOptions = async (): Promise<void> => {\n    if (this.state.unsaved) {\n      await getBackendSrv()\n        .put(`/api/datasources/${this.props.options.id}`, this.props.options)\n        .then((result: { datasource: AzureDataSourceSettings }) => {\n          updateDatasourcePluginOption(this.props, 'version', result.datasource.version);\n        });\n\n      this.setState({ unsaved: false });\n    }\n  };\n\n  private getSubscriptions = async (): Promise<Array<SelectableValue<string>>> => {\n    await this.saveOptions();\n\n    const query = `?api-version=2019-03-01`;\n    try {\n      const result = await getBackendSrv()\n        .fetch({\n          url: this.baseURL + query,\n          method: 'GET',\n        })\n        .toPromise();\n\n      this.setState({ error: undefined });\n      return ResponseParser.parseSubscriptionsForSelect(result);\n    } catch (err) {\n      this.setState({\n        error: {\n          title: 'Error requesting subscriptions',\n          description: 'Could not request subscriptions from Azure. Check your credentials and try again.',\n          details: err?.data?.message,\n        },\n      });\n      return Promise.resolve([]);\n    }\n  };\n\n  // TODO: Used only by InsightsConfig\n  private onUpdateJsonDataOption =\n    (key: keyof AzureDataSourceJsonData) => (event: React.SyntheticEvent<HTMLInputElement | HTMLSelectElement>) => {\n      updateDatasourcePluginJsonDataOption(this.props, key, event.currentTarget.value);\n    };\n\n  // TODO: Used only by InsightsConfig\n  private onUpdateSecureJsonDataOption =\n    (key: keyof AzureDataSourceSecureJsonData) =>\n    (event: React.SyntheticEvent<HTMLInputElement | HTMLSelectElement>) => {\n      updateDatasourcePluginSecureJsonDataOption(this.props, key, event.currentTarget.value);\n    };\n\n  // TODO: Used only by InsightsConfig\n  private resetSecureKey = (key: keyof AzureDataSourceSecureJsonData) => {\n    updateDatasourcePluginResetOption(this.props, key);\n  };\n\n  render() {\n    const { options } = this.props;\n    const { error } = this.state;\n\n    return (\n      <>\n        <MonitorConfig options={options} updateOptions={this.updateOptions} getSubscriptions={this.getSubscriptions} />\n        <AnalyticsConfig options={options} updateOptions={this.updateOptions} />\n        {this.state.appInsightsInitiallyConfigured && (\n          <InsightsConfig\n            options={options}\n            onUpdateJsonDataOption={this.onUpdateJsonDataOption}\n            onUpdateSecureJsonDataOption={this.onUpdateSecureJsonDataOption}\n            onResetOptionKey={this.resetSecureKey}\n          />\n        )}\n\n        {error && (\n          <Alert severity=\"error\" title={error.title}>\n            <p>{error.description}</p>\n            {error.details && <details style={{ whiteSpace: 'pre-wrap' }}>{error.details}</details>}\n          </Alert>\n        )}\n      </>\n    );\n  }\n}\n\nexport default ConfigEditor;\n","import { DataSourcePlugin } from '@grafana/data';\nimport Datasource from './datasource';\nimport { ConfigEditor } from './components/ConfigEditor';\nimport AzureMonitorQueryEditor from './components/QueryEditor';\nimport { AzureMonitorQuery, AzureDataSourceJsonData } from './types';\n\nexport const plugin = new DataSourcePlugin<Datasource, AzureMonitorQuery, AzureDataSourceJsonData>(Datasource)\n  .setConfigEditor(ConfigEditor)\n  .setQueryEditor(AzureMonitorQueryEditor);\n"],"names":["concealed","Symbol","getAuthType","options","jsonData","azureAuthType","tenantId","clientId","config","getDefaultAzureCloud","AzureCloud","undefined","Error","getAzurePortalUrl","azureCloud","getAzureCloud","cloudName","getSecret","secureJsonFields","clientSecret","secret","secureJsonData","length","getCredentials","authType","defaultSubscriptionId","subscriptionId","ResponseParser","result","textFieldName","valueFieldName","list","i","value","find","get","text","push","metricDefinition","type","toLocaleLowerCase","name","metricName","defaultAggTypes","metricData","v","primaryAggType","primaryAggregationType","supportedAggTypes","supportedAggregationTypes","supportedTimeGrains","label","parseTimeGrains","metricAvailabilities","dimensions","parseDimensions","timeGrains","forEach","avail","timeGrain","TimeGrainConverter","metadataDimensions","map","dimension","localizedValue","data","properties","SupportedNamespaces","constructor","azuremonitor","govazuremonitor","germanyazuremonitor","chinaazuremonitor","this","supportedMetricNamespaces","UrlBuilder","baseUrl","resourceGroup","resourceName","apiVersion","metricDefinitionArray","split","resourceNameArray","urlArray","shift","join","metricNamespace","encodeURIComponent","defaultDropdownValue","AzureMonitorDatasource","DataSourceWithBackend","instanceSettings","super","timeSrv","getTimeSrv","cloud","resourcePath","routeNames","azurePortalUrl","isConfigured","validateDatasource","filterQuery","item","hide","azureMonitor","aggregation","applyTemplateVariables","target","scopedVars","timeGrainUnit","TimegrainConverter","templateSrv","getTemplateSrv","replace","subscription","toString","top","dimensionFilters","filter","f","operator","refId","queryType","AzureQueryType","allowedTimeGrainsMs","alias","getResource","then","parseSubscriptions","getResourceGroups","listByResourceGroupApiVersion","parseResponseValues","getMetricDefinitions","t","toLowerCase","shouldHardcodeBlobStorage","resourceTypeDisplayNames","getResourceNames","skipToken","url","async","startsWith","parseResourceNames","nextLink","nextToken","URL","searchParams","nextPage","concat","getMetricNamespaces","buildAzureMonitorGetMetricNamespacesUrl","apiPreviewVersion","getMetricNames","buildAzureMonitorGetMetricNamesUrl","getMetricMetadata","parseMetadata","validationError","Promise","resolve","response","status","message","title","e","statusText","error","code","isValidConfigField","field","results","parseQueryResult","columns","query","raw","xaxis","yaxises","yaxis","spliton","Tables","Columns","rows","Rows","parseRawQueryResultRow","parseQueryResultRow","columnsForDropdown","column","ColumnName","xaxisColumn","findIndex","yaxisesSplit","yaxisColumns","splitonColumn","convertTimestamp","row","yaxisColumn","yaxisName","bucket","findOrCreateBucket","epoch","dateTimeToEpoch","datapoints","isSingleValue","getMetricFieldKey","aggField","getKeyForAggregationField","end","hasSegmentsField","segments","j","getTargetName","meta","dataTarget","segment","metric","segmentName","segmentValue","prop","isObject","regex","match","g1","g2","group","obj","keys","_keys","indexOf","without","key","dataObj","intersection","dateTimeValue","dateTime","valueOf","metrics","toTextValueList","defaultAggregation","supportedAggregations","supportedGroupBy","all","parseGroupBys","parseQuerySchema","Type","columnTable","columnName","columnType","OrderedColumns","Name","values","AppInsightsDatasource","applicationId","appInsightsAppId","version","createRawQueryRequest","timeColumn","valueColumn","segmentColumn","appInsights","rawQuery","rawQueryString","old","timeGrainCount","groupBy","dimensionFilter","isString","d","testDatasource","path","catch","getGroupBys","getQuerySchema","LogAnalyticsQuerystringBuilder","defaultTimeField","generate","queryString","macroRegexp","p1","p2","getMultiContains","escape","getTimeFilter","getFrom","getUntil","interval","uriString","from","range","startOf","toISOString","rangeRaw","to","now","Date","until","timeFieldArg","timeField","inputs","firstCommaIndex","substring","templateVar","trim","tables","resultFormat","parseTimeSeriesResult","parseTableResult","timeIndex","metricIndex","valueIndex","executedQueryString","col","parseToVariables","queryResult","variables","flattenDeep","transformToAnnotations","textIndex","tagsIndex","annotation","time","Math","floor","tags","METADATA_FUNCTION_PARAMS","transformMetadataFunction","sourceSchema","functions","fn","params","parameters","arg","defaultValue","cslDefaultValue","body","inputParameters","AzureLogAnalyticsDatasource","cache","Map","azureMonitorPath","azureLogAnalytics","resource","getWorkspaceList","val","id","workspaceListUrl","resourceUri","nameOrIdOrSomething","database","majorVersion","minorVersion","clusterType","cluster","connectionString","databases","transformMetadataToKustoSchema","getMetadata","workspace","firstWorkspace","interpolateVariable","request","pipe","mergeMap","res","processResponse","df","encodedQuery","custom","buildDeepLink","fields","links","targetBlank","customMeta","base64Enc","workspaceId","details","getWorkspaceDetails","o","customerId","exec","getDeprecatedDefaultWorkSpace","logAnalyticsDefaultWorkspace","buildQuery","querystring","isGUIDish","datasource","getRef","getSubscriptions","getDefaultOrFirstSubscription","getWorkspaces","annotationQuery","reject","queries","promises","doQueries","err","resourceOrWorkspace","getFirstWorkspace","getErrorMessage","InsightsAnalyticsDatasource","insightsAnalytics","AzureResourceGraphDatasource","azureResourceGraph","variableNames","getVariables","subscriptionVar","_","subscriptions","sub","migrateAnnotation","oldQuery","oldWorkspace","newQuery","grafanaTemplateVariableFnMatches","resourceGroups","resourceGroupsWithSub","metricDefinitions","metricDefinitionsWithSub","resourceNames","resourceNamesWithSub","metricNamespaceWithSub","metricNames","metricNamesWithSub","appInsightsMetricNameQuery","appInsightsGroupByQuery","workspacesQuery","workspacesQueryWithSub","migrateStringQueriesToObjectQueries","matches","Object","some","isGrafanaTemplateVariableFnQuery","matchesForQuery","azureMonitorDatasource","grafanaTemplateVariableFn","kind","createGrafanaTemplateVariableQuery","defaultWorkspaceId","azureLogAnalyticsDatasource","resourcePickerData","getResourceURIFromWorkspace","createLogAnalyticsTemplateVariableQuery","AZURE_QUERY_VARIABLE_TYPE_OPTIONS","GrafanaTemplateVariableFnInput","updateQuery","inputVal","setInputVal","useState","useEffect","onRunQuery","useCallback","updatedQuery","InlineField","Input","placeholder","onChange","event","onBlur","props","defaultQuery","setQuery","migratedQuery","errorMessage","setError","useLastError","Select","selectableValue","width","LogsQueryEditor","queryChange","variableOptionGroup","hideFormatAs","Space","Alert","severity","VariableSupport","CustomVariableSupport","VariableEditor","bind","queryObj","targets","templateVariablesResults","callGrafanaTemplateVariableFn","toDataFrame","messageFromError","lastValueFrom","promisedResults","insightsAnalyticsDatasource","replaceVariable","Datasource","DataSourceApi","prepareAnnotation","azureResourceGraphDatasource","ResourcePickerData","pseudoDatasource","appInsightsDatasource","ds","byType","baseTarget","datasourceMigrations","hasQueryForType","has","queryForType","cloneDeep","requestId","set","observables","Array","entries","req","forkJoin","frame","state","LoadingState","of","targetContainsTemplate","variableExists","subQuery","JSON","stringify","upperFirst","replaceTemplateVariable","getAppInsightsMetricNames","getAppInsightsMetricMetadata","getAppInsightsColumns","logAnalyticsColumns","getAzureLogAnalyticsWorkspaces","interpolateVariablesInQueries","variable","isTemplateVariable","includes","LegacyForms","authTypeOptions","AzureCredentialsForm","credentials","azureCloudOptions","onCredentialsChange","disabled","hasRequiredFields","isCredentialsComplete","setSubscriptions","loadSubscriptionsClicked","onLoadSubscriptions","useReducer","updateSubscriptions","canceled","received","autoSelect","onSubscriptionChange","opt","selected","updated","className","managedIdentityEnabled","InlineFormLabel","tooltip","menuShouldPortal","Button","variant","onClick","size","children","azureClouds","MonitorConfig","updateOptions","useMemo","updateCredentials","readOnly","AnalyticsConfig","primaryCredentials","azureLogAnalyticsSameAs","logAnalyticsTenantId","logAnalyticsClientId","InsightsConfig","PureComponent","onResetOptionKey","render","onUpdateJsonDataOption","onUpdateSecureJsonDataOption","appInsightsApiKey","onAppInsightsResetApiKey","ConfigEditor","optionsFunc","onOptionsChange","setState","unsaved","getBackendSrv","put","updateDatasourcePluginOption","saveOptions","fetch","baseURL","method","toPromise","parseSubscriptionsForSelect","description","updateDatasourcePluginJsonDataOption","currentTarget","updateDatasourcePluginSecureJsonDataOption","updateDatasourcePluginResetOption","appInsightsInitiallyConfigured","resetSecureKey","style","whiteSpace","plugin","DataSourcePlugin","setConfigEditor","setQueryEditor","AzureMonitorQueryEditor"],"sourceRoot":""}