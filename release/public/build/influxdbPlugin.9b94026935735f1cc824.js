(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{NluS:function(e,t,a){"use strict";function r(e){return"function"==typeof e?e():e}function n(){var e={};return e.promise=new Promise((function(t,a){e.resolve=t,e.reject=a})),e}e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=void 0,i=void 0,o=void 0,l=[];return function(){var u=r(t),d=(new Date).getTime(),m=!s||d-s>u;s=d;for(var p=arguments.length,h=Array(p),g=0;g<p;g++)h[g]=arguments[g];if(m&&a.leading)return a.accumulate?Promise.resolve(e.call(this,[h])).then((function(e){return e[0]})):Promise.resolve(e.call.apply(e,[this].concat(h)));if(i?clearTimeout(o):i=n(),l.push(h),o=setTimeout(c.bind(this),u),a.accumulate){var f=l.length-1;return i.promise.then((function(e){return e[f]}))}return i.promise};function c(){var t=i;clearTimeout(o),Promise.resolve(a.accumulate?e.call(this,l):e.apply(this,l[l.length-1])).then(t.resolve,t.reject),l=[],i=null}}},sl8e:function(e,t,a){"use strict";a.r(t);var r=a("LvDl"),n=a("Obii"),s=a("7Cbv"),i=a("iZOS");function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class l{constructor(e){o(this,"refId",void 0),o(this,"series",void 0),o(this,"alias",void 0),o(this,"annotation",void 0),o(this,"meta",void 0),this.series=e.series,this.alias=e.alias,this.annotation=e.annotation,this.meta=e.meta,this.refId=e.refId}getTimeSeries(){const e=[];let t,a;return 0===this.series.length||Object(r.each)(this.series,n=>{const s=n.columns.length,i=Object(r.map)(n.tags,(e,t)=>t+": "+e);for(a=1;a<s;a++){let r=n.name;const s=n.columns[a];"value"!==s&&(r=r+"."+s),this.alias?r=this._getSeriesName(n,a):n.tags&&(r=r+" {"+i.join(", ")+"}");const o=[];if(n.values)for(t=0;t<n.values.length;t++)o[t]=[n.values[t][a],n.values[t][0]];e.push({title:r,target:r,datapoints:o,tags:n.tags,meta:this.meta,refId:this.refId})}}),e}_getSeriesName(e,t){const a=e.name.split(".");return this.alias.replace(/\$(\w+)|\[\[([\s\S]+?)\]\]/g,(r,n,s)=>{const i=n||s,o=parseInt(i,10);if("m"===i||"measurement"===i)return e.name;if("col"===i)return e.columns[t];if(!isNaN(o))return a[o];if(0!==i.indexOf("tag_"))return r;const l=i.replace("tag_","");return e.tags?e.tags[l]:r})}getAnnotations(){const e=[];return Object(r.each)(this.series,t=>{let a=null,n=null,s=null;const i=[];let o=null;Object(r.each)(t.columns,(e,t)=>{"time"!==e?"sequence_number"!==e&&(e!==this.annotation.titleColumn?Object(r.includes)((this.annotation.tagsColumn||"").replace(" ","").split(","),e)?i.push(t):e!==this.annotation.textColumn?e!==this.annotation.timeEndColumn?a||o===t||(a=t):s=t:o=t:a=t):n=t}),Object(r.each)(t.values,t=>{const l={annotation:this.annotation,time:+new Date(t[n]),title:t[a],timeEnd:t[s],tags:Object(r.flatten)(i.filter(e=>t[e]).map(e=>t[e].split(","))),text:t[o]};e.push(l)})}),e}getTable(){const e=new i.a;let t,a;return e.refId=this.refId,e.meta=this.meta,0===this.series.length||Object(r.each)(this.series,(s,i)=>{if(0===i)for(a=0,"time"===s.columns[0]&&(e.columns.push({text:"Time",type:n.FieldType.time}),a++),Object(r.each)(Object(r.keys)(s.tags),t=>{e.columns.push({text:t})});a<s.columns.length;a++)e.columns.push({text:s.columns[a]});if(s.values)for(t=0;t<s.values.length;t++){const r=s.values[t],n=[r[0]];if(s.tags)for(const e in s.tags)s.tags.hasOwnProperty(e)&&n.push(s.tags[e]);for(a=1;a<r.length;a++)n.push(r[a]);e.rows.push(n)}}),e}}var c=a("QNPh");const u=[],d={Aggregations:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function m(e){const t=u[e.type];if(!t)throw{message:"Could not find query part "+e.type};return new c.a(e,t)}function p(e){u[e.type]=new c.b(e),e.category.push(u[e.type])}const h=[];function g(e,t){return"*"===e.params[0]?"*":'"'+e.params[0]+'"'}function f(e,t){for(let a=0;a<e.length;a++){const r=e[a];if(r.def.category===d.Aggregations){if(r.def.type===t.def.type)return;if("count"===r.def.type&&"distinct"===t.def.type)break;if("distinct"===r.def.type){const r=e.length>=a+2;if("count"!==t.def.type&&r){e[a+1].def.category===d.Aggregations&&e.splice(a+1,1)}else if("count"===t.def.type)return void(r&&"count"===e[a+1].def.type||e.splice(a+1,0,t))}return void(e[a]=t)}if(r.def.category===d.Selectors)return void(e[a]=t)}e.splice(1,0,t)}function b(e,t){let a;for(a=0;a<e.length;a++){const t=e[a];if(t.def.category===d.Math||t.def.category===d.Aliasing)break}e.splice(a,0,t)}p({type:"field",addStrategy:function(e,t,a){const n=Object(r.map)(e,e=>m({type:e.def.type,params:Object(r.clone)(e.params)}));a.selectModels.push(n)},category:d.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:g}),p({type:"count",addStrategy:f,category:d.Aggregations,params:[],defaultParams:[],renderer:c.c}),p({type:"distinct",addStrategy:f,category:d.Aggregations,params:[],defaultParams:[],renderer:c.c}),p({type:"integral",addStrategy:f,category:d.Aggregations,params:[],defaultParams:[],renderer:c.c}),p({type:"mean",addStrategy:f,category:d.Aggregations,params:[],defaultParams:[],renderer:c.c}),p({type:"median",addStrategy:f,category:d.Aggregations,params:[],defaultParams:[],renderer:c.c}),p({type:"mode",addStrategy:f,category:d.Aggregations,params:[],defaultParams:[],renderer:c.c}),p({type:"sum",addStrategy:f,category:d.Aggregations,params:[],defaultParams:[],renderer:c.c}),p({type:"derivative",addStrategy:b,category:d.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:c.c}),p({type:"spread",addStrategy:b,category:d.Transformations,params:[],defaultParams:[],renderer:c.c}),p({type:"non_negative_derivative",addStrategy:b,category:d.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:c.c}),p({type:"difference",addStrategy:b,category:d.Transformations,params:[],defaultParams:[],renderer:c.c}),p({type:"non_negative_difference",addStrategy:b,category:d.Transformations,params:[],defaultParams:[],renderer:c.c}),p({type:"moving_average",addStrategy:b,category:d.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:c.c}),p({type:"cumulative_sum",addStrategy:b,category:d.Transformations,params:[],defaultParams:[],renderer:c.c}),p({type:"stddev",addStrategy:b,category:d.Transformations,params:[],defaultParams:[],renderer:c.c}),p({type:"time",category:h,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:c.c}),p({type:"fill",category:h,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:c.c}),p({type:"elapsed",addStrategy:b,category:d.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:c.c}),p({type:"holt_winters",addStrategy:b,category:d.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:c.c}),p({type:"holt_winters_with_fit",addStrategy:b,category:d.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:c.c}),p({type:"bottom",addStrategy:f,category:d.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:c.c}),p({type:"first",addStrategy:f,category:d.Selectors,params:[],defaultParams:[],renderer:c.c}),p({type:"last",addStrategy:f,category:d.Selectors,params:[],defaultParams:[],renderer:c.c}),p({type:"max",addStrategy:f,category:d.Selectors,params:[],defaultParams:[],renderer:c.c}),p({type:"min",addStrategy:f,category:d.Selectors,params:[],defaultParams:[],renderer:c.c}),p({type:"percentile",addStrategy:f,category:d.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:c.c}),p({type:"top",addStrategy:f,category:d.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:c.c}),p({type:"tag",category:h,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:g}),p({type:"math",addStrategy:function(e,t){const a=e.length;if(a>0){if("math"===e[a-1].def.type)return void(e[a-1]=t);if(a>1&&"math"===e[a-2].def.type)return void(e[a-2]=t);if("alias"===e[a-1].def.type)return void e.splice(a-1,0,t)}e.push(t)},category:d.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:c.d}),p({type:"alias",addStrategy:function(e,t){const a=e.length;a>0&&"alias"===e[a-1].def.type?e[a-1]=t:e.push(t)},category:d.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:function(e,t){return t+' AS "'+e.params[0]+'"'}});var j={create:m,getCategories:()=>d,replaceAggregationAdd:f},v=a("PbtU");function y(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class O{constructor(e,t,a){y(this,"target",void 0),y(this,"selectModels",[]),y(this,"queryBuilder",void 0),y(this,"groupByParts",void 0),y(this,"templateSrv",void 0),y(this,"scopedVars",void 0),y(this,"refId",void 0),this.target=e,this.templateSrv=t,this.scopedVars=a,e.policy=e.policy||"default",e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=Object(r.map)(this.target.select,e=>Object(r.map)(e,j.create)),this.groupByParts=Object(r.map)(this.target.groupBy,j.create)}updatePersistedParts(){this.target.select=Object(r.map)(this.selectModels,e=>Object(r.map)(e,e=>({type:e.def.type,params:e.params})))}hasGroupByTime(){return Object(r.find)(this.target.groupBy,e=>"time"===e.type)}hasFill(){return Object(r.find)(this.target.groupBy,e=>"fill"===e.type)}addGroupBy(e){let t=e.match(/^(\w+)\((.*)\)$/);if(!t||!this.target.groupBy)return;const a=t[1],r=t[2],n=j.create({type:a,params:[r]}),s=this.target.groupBy.length;0===s?this.target.groupBy.push(n.part):"time"===a?this.target.groupBy.splice(0,0,n.part):"tag"===a&&"fill"===this.target.groupBy[s-1].type?this.target.groupBy.splice(s-1,0,n.part):this.target.groupBy.push(n.part),this.updateProjection()}removeGroupByPart(e,t){const a=j.getCategories();"time"===e.def.type&&(this.target.groupBy=Object(r.filter)(this.target.groupBy,e=>"fill"!==e.type),this.target.select=Object(r.map)(this.target.select,e=>Object(r.filter)(e,e=>{const t=j.create(e);return t.def.category!==a.Aggregations&&t.def.category!==a.Selectors}))),this.target.groupBy.splice(t,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,t){if("field"===t.def.type){if(this.selectModels.length>1){const t=Object(r.indexOf)(this.selectModels,e);this.selectModels.splice(t,1)}}else{const a=Object(r.indexOf)(e,t);e.splice(a,1)}this.updatePersistedParts()}addSelectPart(e,t){const a=j.create({type:t});a.def.addStrategy(e,a,this),this.updatePersistedParts()}renderTagCondition(e,t,a){let r="",n=e.operator,s=e.value;return t>0&&(r=(e.condition||"AND")+" "),n||(n=/^\/.*\/$/.test(s)?"=~":"="),"=~"!==n&&"!~"!==n?(a&&(s=this.templateSrv.replace(s,this.scopedVars)),">"!==n&&"<"!==n&&(s="'"+s.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'")):a&&(s=this.templateSrv.replace(s,this.scopedVars,"regex")),r+'"'+e.key+'" '+n+" "+s}getMeasurementAndPolicy(e){let t=this.target.policy,a=this.target.measurement||"measurement";return a.match("^/.*/$")?e&&(a=this.templateSrv.replace(a,this.scopedVars,"regex")):a='"'+a+'"',t="default"!==t?'"'+this.target.policy+'".':"",t+a}interpolateQueryStr(e,t,a){if(!t.multi&&!t.includeAll)return e;if("string"==typeof e)return v.a.regexEscape(e);return"("+Object(r.map)(e,v.a.regexEscape).join("|")+")"}render(e){const t=this.target;if(t.rawQuery)return e?this.templateSrv.replace(t.query,this.scopedVars,this.interpolateQueryStr):t.query;let a,n,s="SELECT ";for(a=0;a<this.selectModels.length;a++){const e=this.selectModels[a];let t="";for(n=0;n<e.length;n++){t=e[n].render(t)}a>0&&(s+=", "),s+=t}s+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const i=Object(r.map)(t.tags,(t,a)=>this.renderTagCondition(t,a,e));i.length>0&&(s+="("+i.join(" ")+") AND "),s+="$timeFilter";let o="";for(a=0;a<this.groupByParts.length;a++){const e=this.groupByParts[a];a>0&&(o+="fill"===e.def.type?" ":", "),o+=e.render("")}return o.length&&(s+=" GROUP BY "+o),t.fill&&(s+=" fill("+t.fill+")"),"DESC"===t.orderByTime&&(s+=" ORDER BY time DESC"),t.limit&&(s+=" LIMIT "+t.limit),t.slimit&&(s+=" SLIMIT "+t.slimit),t.tz&&(s+=" tz('"+t.tz+"')"),s}renderAdhocFilters(e){return Object(r.map)(e,(e,t)=>this.renderTagCondition(e,t,!0)).join(" ")}}O.$inject=["target","templateSrv","scopedVars"];class x{parse(e,t){if(null==t||!t.results||0===t.results.length)return[];const a=t.results[0];if(!a.series)return[];const n=e.toLowerCase(),s=n.indexOf("show field keys")>=0||n.indexOf("show retention policies")>=0,i=new Set;return Object(r.each)(a.series,e=>{Object(r.each)(e.values,e=>{Object(r.isArray)(e)?s?w(i,e[0]):void 0!==e[1]?w(i,e[1]):w(i,e[0]):w(i,e)})}),Array.from(i).map(e=>({text:e}))}}function w(e,t){e.add(t.toString())}class S{constructor(e,t){this.target=e,this.database=t}buildExploreQuery(e,t,a){let n,s,i="";if("TAG_KEYS"===e)i="SHOW TAG KEYS",n=this.target.measurement,s=this.target.policy;else if("TAG_VALUES"===e)i="SHOW TAG VALUES",n=this.target.measurement,s=this.target.policy;else if("MEASUREMENTS"===e)i="SHOW MEASUREMENTS",a&&(i+=" WITH MEASUREMENT =~ /(?i)"+v.a.regexEscape(a)+"/");else{if("FIELDS"===e)return n=this.target.measurement,s=this.target.policy,n.match("^/.*/")||(n='"'+n+'"',s&&"default"!==s&&(s='"'+s+'"',n=s+"."+n)),"SHOW FIELD KEYS FROM "+n;if("RETENTION POLICIES"===e)return i='SHOW RETENTION POLICIES on "'+this.database+'"',i}if(n&&(n.match("^/.*/")||n.match(/^merge\(.*\)/)||(n='"'+n+'"'),s&&"default"!==s&&(s='"'+s+'"',n=s+"."+n),i+=" FROM "+n),t&&(i+=' WITH KEY = "'+t+'"'),this.target.tags&&this.target.tags.length>0){const e=Object(r.reduce)(this.target.tags,(e,a)=>(a.key===t||">"===a.operator||"<"===a.operator||e.push(function(e,t){let a="",r=e.operator,n=e.value;return t>0&&(a=(e.condition||"AND")+" "),r||(r=/^\/.*\/$/.test(e.value)?"=~":"="),(""===n||"=~"!==r&&"!~"!==r&&isNaN(+n))&&(n="'"+n+"'"),a+'"'+e.key+'" '+r+" "+n}(a,e.length)),e),[]);e.length>0&&(i+=" WHERE "+e.join(" "))}return"MEASUREMENTS"===e&&(i+=" LIMIT 100"),i}}let C;!function(e){e.InfluxQL="InfluxQL",e.Flux="Flux"}(C||(C={}));var P,T,N,E=a("5kRJ"),I=a("t8hP"),F=a("F/XL"),D=a("XlPw"),k=a("q1tI"),A=a.n(k),R=a("vF1F"),B=a("kDLi"),M=a("nKUr");function q(){return(q=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function L(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const _=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:'from(bucket: "db/rp")\n  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)\n  |> filter(fn: (r) =>\n    r._measurement == "example-measurement" and\n    r._field == "example-field"\n  )'},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:'// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)\nfrom(bucket: v.bucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)\n  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)\n  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)\n  |> yield(name: "some-name")'},{label:"Filter by value",description:"Results between a min/max",value:'// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb\nfrom(bucket: v.bucket)\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)'},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:'import "influxdata/influxdb/v1"\nv1.measurements(bucket: v.bucket)'},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:'from(bucket: v.bucket)\n  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)\n  |> keys()\n  |> keep(columns: ["_value"])\n  |> group()\n  |> distinct()'},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:'import "influxdata/influxdb/v1"\nv1.tagKeys(bucket: v.bucket)'},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:'import "influxdata/influxdb/v1"\nv1.tagValues(\n    bucket: v.bucket,\n    tag: "host",\n    predicate: (r) => true,\n    start: -1d\n)'}];class Q extends k.PureComponent{constructor(...e){super(...e),L(this,"onFluxQueryChange",e=>{this.props.onChange(q({},this.props.query,{query:e})),this.props.onRunQuery()}),L(this,"onSampleChange",e=>{this.props.onChange(q({},this.props.query,{query:e.value})),this.forceUpdate(),this.props.onRunQuery()}),L(this,"getSuggestions",()=>{const e=[{label:"v.timeRangeStart",kind:B.CodeEditorSuggestionItemKind.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:B.CodeEditorSuggestionItemKind.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:B.CodeEditorSuggestionItemKind.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:B.CodeEditorSuggestionItemKind.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:B.CodeEditorSuggestionItemKind.Property,detail:"org configured for the datsource"}],t=Object(I.getTemplateSrv)();return t.getVariables().forEach(a=>{const r="${"+a.name+"}";let n=t.replace(r);n===r&&(n=""),e.push({label:r,kind:B.CodeEditorSuggestionItemKind.Text,detail:"(Template Variable) "+n})}),e}),L(this,"editorDidMountCallbackHack",e=>{setTimeout(()=>e.layout(),100)})}render(){const{query:e}=this.props,t=P||(P=Object(M.jsxs)("div",{children:["Type: ",Object(M.jsx)("i",{children:"ctrl+space"})," to show template variable suggestions ",Object(M.jsx)("br",{}),"Many queries can be copied from chronograph"]}));return Object(M.jsxs)(M.Fragment,{children:[Object(M.jsx)(B.CodeEditor,{height:"200px",language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),Object(M.jsxs)("div",{className:Object(R.cx)("gf-form-inline",R.css`
              margin-top: 6px;
            `),children:[T||(T=Object(M.jsx)(B.LinkButton,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/",children:"Flux language syntax"})),Object(M.jsx)(B.Segment,{options:_,value:"Sample Query",onChange:this.onSampleChange}),N||(N=Object(M.jsx)("div",{className:"gf-form gf-form--grow",children:Object(M.jsx)("div",{className:"gf-form-label gf-form-label--grow"})})),Object(M.jsx)(B.InlineFormLabel,{width:5,tooltip:t,children:"Help"})]})]})}}var V=a("67Y/"),G=a("9Z1F");function U(){return(U=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function $(e){const t=Object(r.cloneDeep)(e);return new O(t).render(!1)}function z(){return(z=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function W(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function H(e){const t=e.find(e=>null!==e);if(void 0===t)return n.FieldType.number;const a=typeof t;switch(a){case"string":return n.FieldType.string;case"boolean":return n.FieldType.boolean;case"number":return n.FieldType.number;default:throw new Error("InfluxQL: invalid value type "+a)}}function K(e){const t=[],a=[],r=e.datapoints;for(const e of r)a.push(e[0]),t.push(e[1]);const s=[{name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time,config:{},values:new n.ArrayVector(t)},{name:n.TIME_SERIES_VALUE_FIELD_NAME,type:H(a),config:{displayNameFromDS:e.title},values:new n.ArrayVector(a),labels:e.tags}];return{name:e.target,refId:e.refId,meta:e.meta,fields:s,length:a.length}}class J extends I.DataSourceWithBackend{constructor(e,t=Object(E.a)()){var a,r,n;super(e),W(this,"type",void 0),W(this,"urls",void 0),W(this,"username",void 0),W(this,"password",void 0),W(this,"name",void 0),W(this,"database",void 0),W(this,"basicAuth",void 0),W(this,"withCredentials",void 0),W(this,"interval",void 0),W(this,"responseParser",void 0),W(this,"httpMode",void 0),W(this,"isFlux",void 0),this.templateSrv=t,this.type="influxdb",this.urls=(null!==(a=e.url)&&void 0!==a?a:"").split(",").map(e=>e.trim()),this.username=null!==(r=e.username)&&void 0!==r?r:"",this.password=null!==(n=e.password)&&void 0!==n?n:"",this.name=e.name,this.database=e.database,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials;const s=e.jsonData||{};this.interval=s.timeInterval,this.httpMode=s.httpMode||"GET",this.responseParser=new x,this.isFlux=s.version===C.Flux,this.isFlux&&(this.annotations={QueryEditor:Q})}query(e){if(this.isFlux){const t=z({},e,{targets:e.targets.filter(e=>!0!==e.hide)});return super.query(t)}return this.classicQuery(e)}getQueryDisplayText(e){return this.isFlux?e.query:new O(e).render(!1)}filterQuery(e){return!this.isFlux||!!e.query}applyTemplateVariables(e,t){var a;return z({},e,{query:this.templateSrv.replace(null!==(a=e.query)&&void 0!==a?a:"",t)})}classicQuery(e){let t=this.getTimeFilter(e);const a=e.scopedVars,n=Object(r.cloneDeep)(e.targets),s=[];let i,o,c=Object(r.map)(n,e=>e.hide?"":(s.push(e),a.interval=a.__interval,new O(e,this.templateSrv,a).render(!0))).reduce((e,t)=>(""!==t&&(e+=";"+t),e));if(""===c)return Object(F.a)({data:[]});const u=this.templateSrv.getAdhocFilters(this.name);if(u.length>0){t+=" AND "+new O({refId:"A"},this.templateSrv,a).renderAdhocFilters(u)}return a.timeFilter={value:t},c=this.templateSrv.replace(c,a),this._seriesQuery(c,e).pipe(Object(V.a)(t=>{if(!t||!t.results)return{data:[]};const a=[];for(i=0;i<t.results.length;i++){const r=t.results[i];if(!r||!r.series)continue;const n=s[i];let c=n.alias;c&&(c=this.templateSrv.replace(n.alias,e.scopedVars));const u={executedQueryString:t.executedQueryString},d=new l({refId:n.refId,series:t.results[i].series,alias:c,meta:u});switch(n.resultFormat){case"logs":u.preferredVisualisationType="logs";case"table":a.push(d.getTable());break;default:{const e=d.getTimeSeries();for(o=0;o<e.length;o++)a.push(K(e[o]));break}}}return{data:a}}))}async annotationQuery(e){if(this.isFlux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!e.annotation.query)return Promise.reject({message:"Query missing in annotation definition"});const t=this.getTimeFilter({rangeRaw:e.rangeRaw,timezone:e.dashboard.timezone});let a=e.annotation.query.replace("$timeFilter",t);return a=this.templateSrv.replace(a,void 0,"regex"),this._seriesQuery(a,e).toPromise().then(t=>{if(!t||!t.results||!t.results[0])throw{message:"No results in response from InfluxDB"};return new l({series:t.results[0].series,annotation:e.annotation}).getAnnotations()})}targetContainsTemplate(e){const t=this.isFlux?e.query:$(e);return this.templateSrv.variableExists(t)}interpolateVariablesInQueries(e,t){if(!e||0===e.length)return[];let a=e;return e&&e.length>0&&(a=e.map(e=>{var a,r;const n=z({},e,{datasource:this.name,measurement:this.templateSrv.replace(null!==(a=e.measurement)&&void 0!==a?a:"",t,"regex"),policy:this.templateSrv.replace(null!==(r=e.policy)&&void 0!==r?r:"",t,"regex")});var s;e.rawQuery&&(n.query=this.templateSrv.replace(null!==(s=e.query)&&void 0!==s?s:"",t,"regex"));return e.tags&&(n.tags=e.tags.map(e=>z({},e,{value:this.templateSrv.replace(e.value,void 0,"regex")}))),n})),a}async metricFindQuery(e,t){if(this.isFlux){const a={refId:"metricFindQuery",query:e};return super.query(z({},t,{targets:[a]})).toPromise().then(e=>{var t;return null!==(t=e.data)&&void 0!==t&&t.length?Object(I.frameToMetricFindValue)(e.data[0]):[]})}const a=this.templateSrv.replace(e,void 0,"regex");return this._seriesQuery(a,t).toPromise().then(t=>this.responseParser.parse(e,t))}getTagKeys(e={}){const t=new S({measurement:e.measurement||"",tags:[]},this.database).buildExploreQuery("TAG_KEYS");return this.metricFindQuery(t,e)}getTagValues(e={}){const t=new S({measurement:e.measurement||"",tags:[]},this.database).buildExploreQuery("TAG_VALUES",e.key);return this.metricFindQuery(t,e)}_seriesQuery(e,t){if(!e)return Object(F.a)({results:[]});if(t&&t.range){const a=this.getTimeFilter({rangeRaw:t.range,timezone:t.timezone});e=e.replace("$timeFilter",a)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},t)}serializeParams(e){return e?Object(r.reduce)(e,(e,t,a)=>(null==t||e.push(encodeURIComponent(a)+"="+encodeURIComponent(t)),e),[]).join("&"):""}testDatasource(){if(this.isFlux){const e={targets:[{refId:"test",query:"buckets()"}],requestId:`${this.id}-health-${Object(s.a)()}`,dashboardId:0,panelId:0,interval:"1m",intervalMs:6e4,maxDataPoints:423,range:{from:Object(n.dateTime)(1e3),to:Object(n.dateTime)(2e3)}};return super.query(e).toPromise().then(e=>{if(!e||!e.data||e.state!==n.LoadingState.Done)return console.error("InfluxDB Error",e),{status:"error",message:"Error reading InfluxDB"};const t=e.data[0];return t&&t.length?{status:"success",message:t.length+" buckets found"}:(console.error("InfluxDB Error",e),{status:"error",message:"Error reading buckets"})}).catch(e=>(console.error("InfluxDB Error",e),{status:"error",message:e.message}))}const e=new S({measurement:"",tags:[]},this.database).buildExploreQuery("RETENTION POLICIES");return this._seriesQuery(e).toPromise().then(e=>{const t=Object(r.get)(e,"results[0].error");return t?{status:"error",message:t}:{status:"success",message:"Data source is working"}}).catch(e=>({status:"error",message:e.message}))}_influxRequest(e,t,a,n){const s=this.urls.shift();this.urls.push(s);const i={};this.username&&(i.u=this.username,i.p=this.password),n&&n.database?i.db=n.database:this.database&&(i.db=this.database);const{q:o}=a;"POST"===e&&Object(r.has)(a,"q")?(Object(r.extend)(i,Object(r.omit)(a,["q"])),a=this.serializeParams(Object(r.pick)(a,["q"]))):"GET"!==e&&"POST"!==e||(Object(r.extend)(i,a),a=null);const l={method:e,url:s+t,params:i,data:a,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return l.headers=l.headers||{},(this.basicAuth||this.withCredentials)&&(l.withCredentials=!0),this.basicAuth&&(l.headers.Authorization=this.basicAuth),"POST"===e&&(l.headers["Content-type"]="application/x-www-form-urlencoded"),Object(I.getBackendSrv)().fetch(l).pipe(Object(V.a)(e=>{const{data:t}=e;if(t&&(t.executedQueryString=o,t.results)){const a=e.data.results.filter(e=>e.error);if(a.length>0)throw{message:"InfluxDB Error: "+a[0].error,data:t}}return t}),Object(G.a)(e=>e.cancelled?Object(F.a)(e):Object(D.a)(this.handleErrors(e))))}handleErrors(e){const t={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&0!==e.status||e.status>=300)&&(e.data&&e.data.error?(t.message="InfluxDB Error: "+e.data.error,t.data=e.data,t.config=e.config):(t.message="Network Error: "+e.statusText+"("+e.status+")",t.data=e.data,t.config=e.config)),t}getTimeFilter(e){return"time >= "+this.getInfluxTime(e.rangeRaw.from,!1,e.timezone)+" and time <= "+this.getInfluxTime(e.rangeRaw.to,!0,e.timezone)}getInfluxTime(e,t,a){if(Object(r.isString)(e)){if("now"===e)return"now()";const r=/^now-(\d+)([dhms])$/.exec(e);if(r){return"now() - "+parseInt(r[1],10)+r[2]}e=n.dateMath.parse(e,t,a)}return e.valueOf()+"ms"}}var Y=a("tLXD");function X(e){const[t,a]=Object(k.useState)(e),r=Object(Y.a)(e);return Object(k.useEffect)(()=>{r!==e&&t!==e&&a(e)},[e,t,r]),[t,a]}function Z(){const e=Object(k.useRef)(null);return null==e.current&&(e.current=Object(r.uniqueId)()),e.current}const ee=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}];function te(){return(te=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const ae=({query:e,onChange:t,onRunQuery:a})=>{var r;const[n,s]=X(e.query),[i,o]=X(e.alias),l=Z(),c=Z(),u=()=>{t(te({},e,{query:n,alias:i})),a()};return Object(M.jsxs)("div",{children:[Object(M.jsx)(B.TextArea,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:u,onChange:e=>{s(e.currentTarget.value)},value:null!=n?n:""}),Object(M.jsxs)(B.HorizontalGroup,{children:[Object(M.jsx)(B.InlineFormLabel,{htmlFor:c,children:"Format as"}),Object(M.jsx)(B.Select,{menuShouldPortal:!0,inputId:c,onChange:r=>{t(te({},e,{resultFormat:r.value})),a()},value:null!==(r=e.resultFormat)&&void 0!==r?r:"time_series",options:ee}),Object(M.jsx)(B.InlineFormLabel,{htmlFor:l,children:"Alias by"}),Object(M.jsx)(B.Input,{id:l,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:u,onChange:e=>{o(e.currentTarget.value)},value:null!=i?i:""})]})]})};var re=a("NluS"),ne=a.n(re),se=a("Kwub");const ie=Object(R.css)({minWidth:"160px"}),oe=e=>e,le=({loadOptions:e,allowCustomValue:t,onChange:a,onClose:r})=>{const n=ne()(e,1e3,{leading:!0});return Object(M.jsx)("div",{className:ie,children:Object(M.jsx)(B.AsyncSelect,{menuShouldPortal:!0,formatCreateLabel:oe,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:r,allowCustomValue:t,loadOptions:n,onChange:a})})},ce=({loadOptions:e,allowCustomValue:t,onChange:a,onClose:r})=>{var n;const[s,i]=Object(se.a)(e,[e]);return Object(k.useEffect)(()=>{i()},[i,e]),Object(M.jsx)("div",{className:ie,children:Object(M.jsx)(B.Select,{menuShouldPortal:!0,isLoading:s.loading,formatCreateLabel:oe,autoFocus:!0,isOpen:!0,onCloseMenu:r,allowCustomValue:t,options:null!==(n=s.value)&&void 0!==n?n:[],onChange:a})})},ue=({loadOptions:e,filterByLoadOptions:t,allowCustomValue:a,onChange:r,onClose:n})=>t?Object(M.jsx)(le,{loadOptions:e,allowCustomValue:a,onChange:r,onClose:n}):Object(M.jsx)(ce,{loadOptions:e,allowCustomValue:a,onChange:r,onClose:n}),de=({initialValue:e,onChange:t,onClose:a})=>{const[r,n]=X(e);return Object(M.jsx)(B.Input,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:a,onKeyDown:e=>{"Enter"===e.key&&t(r)},onChange:e=>{n(e.currentTarget.value)},value:r})},me=Object(R.css)({width:"auto",cursor:"pointer"}),pe=({value:e,buttonClassName:t,loadOptions:a,filterByLoadOptions:r,allowCustomValue:n,onChange:s})=>{const[i,o]=Object(k.useState)(!1);if(i)return void 0!==a?Object(M.jsx)(ue,{loadOptions:a,filterByLoadOptions:null!=r&&r,allowCustomValue:n,onChange:e=>{o(!1),s(e)},onClose:()=>{o(!1)}}):Object(M.jsx)(de,{initialValue:e,onClose:()=>{o(!1)},onChange:e=>{o(!1),s({value:e,label:e})}});{const a=Object(R.cx)(me,t);return Object(M.jsx)(B.InlineLabel,{as:"button",className:a,onClick:()=>{o(!0)},children:e})}};function he(e){return{label:e,value:e}}const ge=({policy:e,measurement:t,onChange:a,getPolicyOptions:r,getMeasurementOptions:n})=>Object(M.jsxs)(M.Fragment,{children:[Object(M.jsx)(pe,{allowCustomValue:!0,value:null!=e?e:"using default policy",loadOptions:async()=>{const e=await r();return(e.some(e=>"default"===e)?e:["default",...e]).map(he)},onChange:e=>{a(e.value,t)}}),Object(M.jsx)(pe,{allowCustomValue:!0,value:null!=t?t:"select measurement",loadOptions:async e=>(await n(e)).map(he),filterByLoadOptions:!0,onChange:t=>{a(e,t.value)}})]});function fe(e){return/^\/.*\/$/.test(e)}function be(e){var t;return null!==(t=e.operator)&&void 0!==t?t:fe(e.value)?"=~":"="}function je(e,t){var a;return t?void 0:null!==(a=e.condition)&&void 0!==a?a:"AND"}function ve(e,t){const a="=~"===e||"!~"===e;return fe(t)?a?e:"=~":a?"=":e}function ye(e){if(null==e)throw new Error("value must not be nullish");return e}const Oe=({loadOptions:e,allowCustomValue:t,onAdd:a})=>Object(M.jsx)(pe,{value:"+",loadOptions:e,allowCustomValue:t,onChange:e=>{a(ye(e.value))}});function xe(){return(xe=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const we=["=","!=","<>","<",">","=~","!~"].map(he),Se=["AND","OR"].map(he),Ce=()=>Promise.resolve(Se),Pe=()=>Promise.resolve(we),Te=({tag:e,isFirst:t,onRemove:a,onChange:r,getTagKeyOptions:n,getTagValueOptions:s})=>{const i=be(e),o=je(e,t);return Object(M.jsxs)("div",{className:"gf-form",children:[null!=o&&Object(M.jsx)(pe,{value:o,loadOptions:Ce,onChange:t=>{r(xe({},e,{condition:t.value}))}}),Object(M.jsx)(pe,{allowCustomValue:!0,value:e.key,loadOptions:()=>n().then(e=>[{label:"-- remove filter --",value:void 0},...e.map(he)]),onChange:t=>{const{value:n}=t;void 0===n?a():r(xe({},e,{key:null!=n?n:""}))}}),Object(M.jsx)(pe,{value:i,loadOptions:Pe,onChange:t=>{r(xe({},e,{operator:t.value}))}}),Object(M.jsx)(pe,{allowCustomValue:!0,value:e.value,loadOptions:()=>s(e.key).then(e=>e.map(he)),onChange:t=>{var a;const n=null!==(a=t.value)&&void 0!==a?a:"";r(xe({},e,{value:n,operator:ve(i,n)}))}})]})},Ne=({tags:e,onChange:t,getTagKeyOptions:a,getTagValueOptions:r})=>Object(M.jsxs)(M.Fragment,{children:[e.map((n,s)=>Object(M.jsx)(Te,{tag:n,isFirst:0===s,onChange:a=>{((a,r)=>{const n=e.map((e,t)=>r===t?a:e);t(n)})(a,s)},onRemove:()=>{(a=>{const r=e.filter((e,t)=>t!==a);t(r)})(s)},getTagKeyOptions:a,getTagValueOptions:r},s)),Object(M.jsx)(Oe,{allowCustomValue:!0,loadOptions:()=>a().then(e=>e.map(he)),onAdd:a=>{((a,r)=>{const n={key:a,value:"select tag value"},s={key:n.key,value:n.value,operator:be(n),condition:je(n,r)};t([...e,s])})(a,0===e.length)}})]}),Ee=Object(R.css)({paddingRight:"0",marginRight:"0"}),Ie=({name:e,onRemove:t})=>Object(M.jsx)(B.WithContextMenu,{renderMenuItems:()=>{return e=t,Object(M.jsx)(B.MenuGroup,{label:"",ariaLabel:"",children:Object(M.jsx)(B.MenuItem,{label:"remove",ariaLabel:"remove",onClick:e})});var e},children:({openMenu:t})=>Object(M.jsx)("button",{className:Object(R.cx)("gf-form-label",Ee),onClick:t,children:e})}),Fe=Object(R.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),De=({name:e,params:t,onChange:a,onRemove:r})=>{const n=Object(B.useTheme2)(),s=Object(k.useMemo)(()=>(e=>Object(R.cx)("gf-form-label",Object(R.css)({paddingLeft:"0",lineHeight:e.typography.body.lineHeight,fontSize:e.typography.body.fontSize})))(n),[n]);return Object(M.jsxs)("div",{className:s,children:[Object(M.jsx)(Ie,{name:e,onRemove:r}),"(",t.map((e,r)=>{const{value:n,options:s}=e,i=r===t.length-1,o=null!==s?()=>s().then(e=>e.map(he)):void 0;return Object(M.jsxs)(A.a.Fragment,{children:[Object(M.jsx)(pe,{allowCustomValue:!0,value:n,buttonClassName:Fe,loadOptions:o,onChange:e=>{((e,r)=>{const n=t.map(e=>e.value);n[r]=e,a(n)})(ye(e.value),r)}}),!i&&","]},r)}),")"]})},ke=({parts:e,getNewPartOptions:t,onAddNewPart:a,onRemovePart:r,onChange:n})=>Object(M.jsxs)(M.Fragment,{children:[e.map((e,t)=>Object(M.jsx)(De,{name:e.name,params:e.params,onRemove:()=>{r(t)},onChange:e=>{n(t,e)}},t)),Object(M.jsx)(Oe,{loadOptions:t,onAdd:a})]}),Ae=Object(R.css)({paddingRight:"4px"}),Re=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],Be=Object(R.cx)("width-9",Ae),Me=({value:e,onChange:t})=>Object(M.jsx)(M.Fragment,{children:Object(M.jsx)(B.Select,{className:Be,onChange:e=>{t(ye(e.value))},value:e,options:Re})}),qe=({value:e,onChange:t,isWide:a,placeholder:r})=>{const[n,s]=X(e);return Object(M.jsx)(M.Fragment,{children:Object(M.jsx)(B.Input,{placeholder:r,className:Object(R.cx)(null!=a&&a?"width-14":"width-8",Ae),type:"text",spellCheck:!1,onBlur:()=>{t(""===n?void 0:n)},onChange:e=>{s(e.currentTarget.value)},value:null!=n?n:""})})},Le=(e,t,a,r,n)=>{const s=new S(r,n.database).buildExploreQuery(e,t,a);return n.metricFindQuery(s)};const _e=Object(R.cx)("width-8",Ae),Qe=({format:e,onChange:t})=>Object(M.jsx)(B.Select,{className:_e,onChange:e=>{t(ye(e.value))},value:e,options:ee}),Ve=Object(R.css)({textTransform:"uppercase"}),Ge=({name:e,isInitial:t})=>Object(M.jsx)("label",{className:Object(R.cx)("gf-form-label query-keyword",{"width-7":null!=t&&t},Ve),children:e});var Ue;const $e=()=>Ue||(Ue=Object(M.jsx)("div",{className:"gf-form gf-form--grow",children:Object(M.jsx)("label",{className:"gf-form-label gf-form-label--grow"})}));function ze(){return(ze=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function We(e,t){var a;const r=j.create(e).def,n=(null!==(a=e.params)&&void 0!==a?a:[]).map(e=>e.toString());if(n.length!==r.params.length)throw new Error("Invalid query-segment");return n.map((e,a)=>{const n=r.params[a];return n.dynamicLookup?{value:e,options:ye(t.get(`${r.type}_${a}`))}:null!=n.options?{value:e,options:()=>Promise.resolve(n.options)}:{value:e,options:null}})}function He(e,t){return e.map(e=>({name:e.type,params:We(e,t)}))}var Ke,Je,Ye,Xe,Ze;function et(){return(et=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function tt(e){return e.then(e=>[...Object(I.getTemplateSrv)().getVariables().map(e=>`/^$${e.name}$/`),...e])}const at=({initialName:e,children:t})=>Object(M.jsxs)("div",{className:"gf-form-inline",children:[Object(M.jsx)(Ge,{name:e,isInitial:!0}),t,Ke||(Ke=Object(M.jsx)($e,{}))]}),rt=e=>{var t,a,n,s;const i=function(e){if(void 0!==e.policy&&void 0!==e.resultFormat&&void 0!==e.orderByTime&&void 0!==e.tags&&void 0!==e.groupBy&&void 0!==e.select)return e;const t=Object(r.cloneDeep)(e);return new O(t).target}(e.query),{datasource:o}=e,{measurement:l,policy:c}=i,u=Object(k.useMemo)(()=>{var e;const t=new Map([["field_0",()=>void 0!==l?async function(e,t,a){const r={tags:[],measurement:e,policy:t};return(await Le("FIELDS",void 0,void 0,r,a)).map(e=>e.text)}(l,c,o):Promise.resolve([])]]);return(null!==(e=i.select)&&void 0!==e?e:[]).map(e=>He(e,t))},[l,c,i.select,o]),d=Object(k.useMemo)(()=>()=>{var e;return async function(e,t,a,r){const n={tags:a,measurement:e,policy:t};return(await Le("TAG_KEYS",void 0,void 0,n,r)).map(e=>e.text)}(l,c,null!==(e=i.tags)&&void 0!==e?e:[],o)},[l,c,i.tags,o]),m=Object(k.useMemo)(()=>{var e;const t=new Map([["tag_0",d]]);return He(null!==(e=i.groupBy)&&void 0!==e?e:[],t)},[d,i.groupBy]),p=t=>{e.onChange(t),e.onRunQuery()};return Object(M.jsxs)("div",{children:[Object(M.jsxs)(at,{initialName:"from",children:[Object(M.jsx)(ge,{policy:c,measurement:l,getPolicyOptions:()=>async function(e){const t={tags:[],measurement:void 0,policy:void 0};return(await Le("RETENTION POLICIES",void 0,void 0,t,e)).map(e=>e.text)}(o),getMeasurementOptions:e=>{var t;return tt(async function(e,t,a){const r={tags:t,measurement:void 0,policy:void 0};return(await Le("MEASUREMENTS",void 0,e,r,a)).map(e=>e.text)}(""===e?void 0:e,null!==(t=i.tags)&&void 0!==t?t:[],o))},onChange:(e,t)=>{p(et({},i,{policy:e,measurement:t}))}}),Je||(Je=Object(M.jsx)(Ge,{name:"where"})),Object(M.jsx)(Ne,{tags:null!==(t=i.tags)&&void 0!==t?t:[],onChange:e=>{p(et({},i,{tags:0===e.length?void 0:e}))},getTagKeyOptions:d,getTagValueOptions:e=>{var t;return tt(async function(e,t,a,r,n){const s={tags:r,measurement:t,policy:a};return(await Le("TAG_VALUES",e,void 0,s,n)).map(e=>e.text)}(e,l,c,null!==(t=i.tags)&&void 0!==t?t:[],o))}})]}),u.map((e,t)=>Object(M.jsx)(at,{initialName:0===t?"select":"",children:Object(M.jsx)(ke,{parts:e,getNewPartOptions:()=>Promise.resolve(function(){const e=j.getCategories(),t=[];return Object.keys(e).forEach(a=>{const r=e[a].map(e=>he(e.type));t.push({label:a,options:r})}),t}()),onChange:(e,a)=>{const r=function(e,t,a,r){var n;const s=[...null!==(n=e.select)&&void 0!==n?n:[]];return s[t]=[...s[t]],s[t][a]=U({},s[t][a],{params:r}),U({},e,{select:s})}(i,t,e,a);p(r)},onAddNewPart:e=>{p(function(e,t,a){const n=Object(r.cloneDeep)(e),s=new O(n);return s.addSelectPart(s.selectModels[a],t),s.target}(i,e,t))},onRemovePart:e=>{p(function(e,t,a){const n=Object(r.cloneDeep)(e),s=new O(n),i=s.selectModels[a];return s.removeSelectPart(i,i[t]),s.target}(i,e,t))}})},t)),Object(M.jsx)(at,{initialName:"group by",children:Object(M.jsx)(ke,{parts:m,getNewPartOptions:()=>async function(e,t){const a=await t(),r=ze({},e),n=new O(r),s=[];return n.hasFill()||s.push(he("fill(null)")),n.hasGroupByTime()||s.push(he("time($interval)")),a.forEach(e=>{s.push(he(`tag(${e})`))}),s}(i,d),onChange:(e,t)=>{const a=function(e,t,a){var r;const n=[...null!==(r=e.groupBy)&&void 0!==r?r:[]];return n[t]=U({},n[t],{params:a}),U({},e,{groupBy:n})}(i,e,t);p(a)},onAddNewPart:e=>{p(function(e,t){const a=Object(r.cloneDeep)(e),n=new O(a);return n.addGroupBy(t),n.target}(i,e))},onRemovePart:e=>{p(function(e,t){const a=Object(r.cloneDeep)(e),n=new O(a);return n.removeGroupByPart(n.groupByParts[t],t),n.target}(i,e))}})}),Object(M.jsxs)(at,{initialName:"timezone",children:[Object(M.jsx)(qe,{placeholder:"(optional)",value:i.tz,onChange:e=>{p(et({},i,{tz:e}))}}),Ye||(Ye=Object(M.jsx)(Ge,{name:"order by time"})),Object(M.jsx)(Me,{value:"DESC"===i.orderByTime?"DESC":"ASC",onChange:e=>{p(et({},i,{orderByTime:e}))}})]}),Object(M.jsxs)(at,{initialName:"limit",children:[Object(M.jsx)(qe,{placeholder:"(optional)",value:null===(a=i.limit)||void 0===a?void 0:a.toString(),onChange:e=>{p(et({},i,{limit:e}))}}),Xe||(Xe=Object(M.jsx)(Ge,{name:"slimit"})),Object(M.jsx)(qe,{placeholder:"(optional)",value:null===(n=i.slimit)||void 0===n?void 0:n.toString(),onChange:e=>{p(et({},i,{slimit:e}))}})]}),Object(M.jsxs)(at,{initialName:"format as",children:[Object(M.jsx)(Qe,{format:null!==(s=i.resultFormat)&&void 0!==s?s:"time_series",onChange:e=>{p(et({},i,{resultFormat:e}))}}),"table"!==i.resultFormat&&Object(M.jsxs)(M.Fragment,{children:[Ze||(Ze=Object(M.jsx)(Ge,{name:"alias"})),Object(M.jsx)(qe,{isWide:!0,placeholder:"Naming pattern",value:i.alias,onChange:e=>{p(et({},i,{alias:e}))}})]})]})]})},nt=({isRaw:e,onChange:t})=>{const[a,r]=Object(k.useState)(!1);return Object(k.useEffect)(()=>{r(!1)},[e]),e?Object(M.jsxs)(M.Fragment,{children:[Object(M.jsx)(B.Button,{icon:"pen",variant:"secondary",type:"button",onClick:()=>{r(!0)}}),Object(M.jsx)(B.ConfirmModal,{isOpen:a,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will loose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{t(!1)},onDismiss:()=>{r(!1)}})]}):Object(M.jsx)(B.Button,{icon:"pen",variant:"secondary",type:"button",onClick:()=>{t(!0)}})};function st(){return(st=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}var it;const ot=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}];var lt,ct,ut,dt,mt,pt,ht,gt,ft,bt,jt,vt,yt=e=>Object(M.jsxs)("div",{children:[it||(it=Object(M.jsx)("h2",{children:"InfluxDB Cheat Sheet"})),ot.map(e=>Object(M.jsxs)("div",{className:"cheat-sheet-item",children:[Object(M.jsx)("div",{className:"cheat-sheet-item__title",children:e.title}),Object(M.jsx)("div",{className:"cheat-sheet-item__label",children:e.label})]},e.title))]});class Ot extends k.PureComponent{render(){return Object(M.jsx)(yt,{onClickExample:this.props.onClickExample})}}function xt(){return(xt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function wt(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const{Select:St,Input:Ct,SecretFormField:Pt}=B.LegacyForms,Tt=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],Nt=[{label:"InfluxQL",value:C.InfluxQL,description:"The InfluxDB SQL-like query language.  Supported in InfluxDB 1.x"},{label:"Flux",value:C.Flux,description:"Advanced data scripting and query language.  Supported in InfluxDB 2.x and 1.8+ (beta)"}];class Et extends k.PureComponent{constructor(e){var t;super(e),wt(this,"state",{maxSeries:""}),wt(this,"onResetPassword",()=>{Object(n.updateDatasourcePluginResetOption)(this.props,"password")}),wt(this,"onResetToken",()=>{Object(n.updateDatasourcePluginResetOption)(this.props,"token")}),wt(this,"onVersionChanged",e=>{const{options:t,onOptionsChange:a}=this.props,r=xt({},t,{jsonData:xt({},t.jsonData,{version:e.value})});e.value===C.Flux&&(r.access="proxy",r.basicAuth=!0,r.jsonData.httpMode="POST",delete r.user,delete r.database),a(r)}),this.state.maxSeries=(null===(t=e.options.jsonData.maxSeries)||void 0===t?void 0:t.toString())||""}renderInflux2x(){const{options:e}=this.props,{secureJsonFields:t}=e,a=e.secureJsonData||{};return Object(M.jsxs)(M.Fragment,{children:[Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsxs)("div",{className:"gf-form",children:[lt||(lt=Object(M.jsx)(B.InlineFormLabel,{className:"width-10",children:"Organization"})),Object(M.jsx)("div",{className:"width-10",children:Object(M.jsx)(Ct,{className:"width-20",value:e.jsonData.organization||"",onChange:Object(n.onUpdateDatasourceJsonDataOption)(this.props,"organization")})})]})}),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsx)("div",{className:"gf-form",children:Object(M.jsx)(Pt,{isConfigured:t&&t.token,value:a.token||"",label:"Token",labelWidth:10,inputWidth:20,onReset:this.onResetToken,onChange:Object(n.onUpdateDatasourceSecureJsonDataOption)(this.props,"token")})})}),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsxs)("div",{className:"gf-form",children:[ct||(ct=Object(M.jsx)(B.InlineFormLabel,{className:"width-10",children:"Default Bucket"})),Object(M.jsx)("div",{className:"width-10",children:Object(M.jsx)(Ct,{className:"width-20",placeholder:"default bucket",value:e.jsonData.defaultBucket||"",onChange:Object(n.onUpdateDatasourceJsonDataOption)(this.props,"defaultBucket")})})]})}),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsxs)("div",{className:"gf-form",children:[ut||(ut=Object(M.jsx)(B.InlineFormLabel,{className:"width-10",tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute.",children:"Min time interval"})),Object(M.jsx)("div",{className:"width-10",children:Object(M.jsx)(Ct,{className:"width-10",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:Object(n.onUpdateDatasourceJsonDataOption)(this.props,"timeInterval")})})]})})]})}renderInflux1x(){const{options:e}=this.props,{secureJsonFields:t}=e,a=e.secureJsonData||{};return Object(M.jsxs)(M.Fragment,{children:[dt||(dt=Object(M.jsxs)(B.InfoBox,{children:[Object(M.jsx)("h5",{children:"Database Access"}),Object(M.jsxs)("p",{children:["Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",Object(M.jsx)("code",{children:"SHOW MEASUREMENTS ON _internal"})," or",Object(M.jsx)("code",{children:'SELECT * FROM "_internal".."database" LIMIT 10'}),Object(M.jsx)("br",{}),Object(M.jsx)("br",{}),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB."]})]})),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsxs)("div",{className:"gf-form",children:[mt||(mt=Object(M.jsx)(B.InlineFormLabel,{className:"width-10",children:"Database"})),Object(M.jsx)("div",{className:"width-20",children:Object(M.jsx)(Ct,{className:"width-20",value:e.database||"",onChange:Object(n.onUpdateDatasourceOption)(this.props,"database")})})]})}),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsxs)("div",{className:"gf-form",children:[pt||(pt=Object(M.jsx)(B.InlineFormLabel,{className:"width-10",children:"User"})),Object(M.jsx)("div",{className:"width-10",children:Object(M.jsx)(Ct,{className:"width-20",value:e.user||"",onChange:Object(n.onUpdateDatasourceOption)(this.props,"user")})})]})}),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsx)("div",{className:"gf-form",children:Object(M.jsx)(Pt,{isConfigured:t&&t.password,value:a.password||"",label:"Password",labelWidth:10,inputWidth:20,onReset:this.onResetPassword,onChange:Object(n.onUpdateDatasourceSecureJsonDataOption)(this.props,"password")})})}),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsxs)("div",{className:"gf-form",children:[ht||(ht=Object(M.jsx)(B.InlineFormLabel,{className:"width-10",tooltip:"You can use either GET or POST HTTP method to query your InfluxDB database. The POST method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method will restrict you and return an error if the query is too large.",children:"HTTP Method"})),Object(M.jsx)(St,{menuShouldPortal:!0,className:"width-10",value:Tt.find(t=>t.value===e.jsonData.httpMode),options:Tt,defaultValue:e.jsonData.httpMode,onChange:Object(n.onUpdateDatasourceJsonDataOptionSelect)(this.props,"httpMode")})]})}),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsxs)("div",{className:"gf-form",children:[gt||(gt=Object(M.jsx)(B.InlineFormLabel,{className:"width-10",tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute.",children:"Min time interval"})),Object(M.jsx)("div",{className:"width-10",children:Object(M.jsx)(Ct,{className:"width-10",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:Object(n.onUpdateDatasourceJsonDataOption)(this.props,"timeInterval")})})]})})]})}render(){const{options:e,onOptionsChange:t}=this.props;return Object(M.jsxs)(M.Fragment,{children:[ft||(ft=Object(M.jsx)("h3",{className:"page-heading",children:"Query Language"})),Object(M.jsx)("div",{className:"gf-form-group",children:Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsx)("div",{className:"gf-form",children:Object(M.jsx)(St,{menuShouldPortal:!0,className:"width-30",value:e.jsonData.version===C.Flux?Nt[1]:Nt[0],options:Nt,defaultValue:Nt[0],onChange:this.onVersionChanged})})})}),e.jsonData.version===C.Flux&&(bt||(bt=Object(M.jsxs)(B.InfoBox,{children:[Object(M.jsx)("h5",{children:"Support for Flux in Grafana is currently in beta"}),Object(M.jsxs)("p",{children:["Please report any issues to: ",Object(M.jsx)("br",{}),Object(M.jsx)("a",{href:"https://github.com/grafana/grafana/issues/new/choose",children:"https://github.com/grafana/grafana/issues"})]})]}))),"direct"===e.access&&(jt||(jt=Object(M.jsx)(B.Alert,{title:"Deprecation Notice",severity:"warning",children:"Browser access mode in the InfluxDB datasource is deprecated and will be removed in a future release."}))),Object(M.jsx)(B.DataSourceHttpSettings,{showAccessOptions:!0,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:t}),Object(M.jsxs)("div",{className:"gf-form-group",children:[vt||(vt=Object(M.jsx)("div",{children:Object(M.jsx)("h3",{className:"page-heading",children:"InfluxDB Details"})})),e.jsonData.version===C.Flux?this.renderInflux2x():this.renderInflux1x(),Object(M.jsx)("div",{className:"gf-form-inline",children:Object(M.jsx)(B.InlineField,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000.",children:Object(M.jsx)(Ct,{placeholder:"1000",type:"number",className:"width-10",value:this.state.maxSeries,onChange:e=>{this.setState({maxSeries:e.currentTarget.value});const t=parseInt(e.currentTarget.value,10);Object(n.updateDatasourcePluginJsonDataOption)(this.props,"maxSeries",Number.isFinite(t)?t:void 0)}})})})]})]})}}var It,Ft,Dt,kt,At=Et;class Rt extends k.PureComponent{constructor(...e){var t,a,r;super(...e),r=()=>{},(a="onRefresh")in(t=this)?Object.defineProperty(t,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[a]=r}render(){let{query:e,datasource:t,onChange:a}=this.props;return t.isFlux?Object(M.jsx)(Q,{datasource:t,query:{refId:"A",query:e},onRunQuery:this.onRefresh,onChange:e=>a(e.query)}):Object(M.jsxs)("div",{className:"gf-form-inline",children:[It||(It=Object(M.jsx)(B.InlineFormLabel,{width:10,children:"Query"})),Object(M.jsx)("div",{className:"gf-form-inline gf-form--grow",children:Object(M.jsx)(B.TextArea,{defaultValue:e||"",placeholder:"metric name or tags query",rows:1,className:"gf-form-input",onBlur:e=>a(e.currentTarget.value)})})]})}}a.d(t,"plugin",(function(){return Mt}));class Bt{}kt="partials/annotations.editor.html",(Dt="templateUrl")in(Ft=Bt)?Object.defineProperty(Ft,Dt,{value:kt,enumerable:!0,configurable:!0,writable:!0}):Ft[Dt]=kt;const Mt=new n.DataSourcePlugin(J).setConfigEditor(At).setQueryEditor(({query:e,onChange:t,onRunQuery:a,datasource:r,range:n,data:s})=>{var i;return r.isFlux?Object(M.jsx)("div",{className:"gf-form-query-content",children:Object(M.jsx)(Q,{query:e,onChange:t,onRunQuery:a,datasource:r})}):Object(M.jsxs)("div",{className:Object(R.css)({display:"flex"}),children:[Object(M.jsx)("div",{className:Object(R.css)({flexGrow:1}),children:e.rawQuery?Object(M.jsx)(ae,{query:e,onChange:t,onRunQuery:a}):Object(M.jsx)(rt,{query:e,onChange:t,onRunQuery:a,datasource:r})}),Object(M.jsx)(nt,{isRaw:null!==(i=e.rawQuery)&&void 0!==i&&i,onChange:r=>{t(st({},e,{query:$(e),rawQuery:r})),a()}})]})}).setAnnotationQueryCtrl(Bt).setVariableQueryEditor(Rt).setQueryEditorHelp(Ot)},tLXD:function(e,t,a){"use strict";var r=a("q1tI");t.a=function(e){var t=Object(r.useRef)();return Object(r.useEffect)((function(){t.current=e})),t.current}}}]);
//# sourceMappingURL=influxdbPlugin.9b94026935735f1cc824.js.map